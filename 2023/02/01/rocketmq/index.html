<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>RocketMQ | Hexo</title><meta name="keywords" content="juc"><meta name="author" content="YuanJW"><meta name="copyright" content="YuanJW"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="RocketMQRocketMQ入门消息队列 消息队列中间件 - Message Queue 是分布式系统中重要的组建，主要解决 应用解耦、异步消息、流量削峰 等问题。 消息队列实现了高性能、高可用、可伸缩和最终一致性架构，是大型分布式系统不可缺少的中间件。 目前主流的消息队列有 RocketMQ、Kafka、RabbitMQ、ActiveMQ等。本文将主要介绍 RocketMQ  消息队列的作用">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ">
<meta property="og:url" content="http://example.com/2023/02/01/rocketmq/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="RocketMQRocketMQ入门消息队列 消息队列中间件 - Message Queue 是分布式系统中重要的组建，主要解决 应用解耦、异步消息、流量削峰 等问题。 消息队列实现了高性能、高可用、可伸缩和最终一致性架构，是大型分布式系统不可缺少的中间件。 目前主流的消息队列有 RocketMQ、Kafka、RabbitMQ、ActiveMQ等。本文将主要介绍 RocketMQ  消息队列的作用">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/default-cover/40.png">
<meta property="article:published_time" content="2023-01-31T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-12T02:33:33.434Z">
<meta property="article:author" content="YuanJW">
<meta property="article:tag" content="juc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/default-cover/40.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/02/01/rocketmq/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RocketMQ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-12 10:33:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/default-cover/40.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RocketMQ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-31T16:00:00.000Z" title="Created 2023-02-01 00:00:00">2023-02-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-03-12T02:33:33.434Z" title="Updated 2024-03-12 10:33:33">2024-03-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RocketMQ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h1><h2 id="RocketMQ入门"><a href="#RocketMQ入门" class="headerlink" title="RocketMQ入门"></a>RocketMQ入门</h2><h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><blockquote>
<p>消息队列中间件 - Message Queue 是分布式系统中重要的组建，主要解决 应用解耦、异步消息、流量削峰 等问题。</p>
<p>消息队列实现了高性能、高可用、可伸缩和最终一致性架构，是大型分布式系统不可缺少的中间件。</p>
<p>目前主流的消息队列有 RocketMQ、Kafka、RabbitMQ、ActiveMQ等。本文将主要介绍 RocketMQ</p>
</blockquote>
<h4 id="消息队列的作用"><a href="#消息队列的作用" class="headerlink" title="消息队列的作用"></a>消息队列的作用</h4><ul>
<li>异构系统之间的调用<strong>解耦</strong></li>
<li>基于”发布订阅”机制的<strong>数据分发</strong></li>
<li><strong>异步</strong>消息处理</li>
<li><strong>削峰限流</strong></li>
</ul>
<h4 id="消息队列选型"><a href="#消息队列选型" class="headerlink" title="消息队列选型"></a>消息队列选型</h4><p><a target="_blank" rel="noopener" href="https://kafka.apache.org/">Kafka</a></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kafka.apache.org/">Apache Kafka</a> 是一个开源流处理平台，是一个高吞吐的分布式发布订阅消息系统</p>
<p>使用场景：大流量应用、对消息延迟不敏感的场景</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">RabbitMQ</a></p>
<blockquote>
<p>RabbitMQ 开源的消息队列系统，实现了高级消息队列协议（AMQP）</p>
<p>使用场景：企业级别内部应用，数据可靠性高，对于并发和延迟不敏感的场景</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">RocketMQ</a></p>
<blockquote>
<p>Apache RocketMQ 由阿里巴巴集团贡献的开源分布式消息中间件</p>
<p>适用场景：低延迟应用，瞬间大流量处理效率不如kafka</p>
</blockquote>
<h3 id="RocketMQ概述"><a href="#RocketMQ概述" class="headerlink" title="RocketMQ概述"></a>RocketMQ概述</h3><blockquote>
<p>Apache RocketMQ 是一款分布式消息中间件系统，它最初由阿里巴巴集团开发并开源。RocketMQ 的设计目标是提供低延迟、高可用性、高吞吐量、高可靠性以及水平可扩展的消息传递服务。</p>
<p>Apache RocketMQ 官方文档：<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/">https://rocketmq.apache.org/zh/docs/</a></p>
</blockquote>
<h3 id="RocketMQ特性"><a href="#RocketMQ特性" class="headerlink" title="RocketMQ特性"></a>RocketMQ特性</h3><ul>
<li>高可用：支持集群和水平扩容，实现负载均衡和高可用</li>
<li>高性能：支持过亿级别的消息处理</li>
<li>高可靠：支持消息持久化、失败重试、消息回溯等机制，确保消息的可靠性</li>
<li>功能丰富：支持异步消息、同步消息、顺序消息、事务消息等功能</li>
</ul>
<h3 id="RocketMQ基本概念"><a href="#RocketMQ基本概念" class="headerlink" title="RocketMQ基本概念"></a>RocketMQ基本概念</h3><p><img src="https://s2.loli.net/2024/01/07/zM4PdkLyVpAZYSr.png" alt="生产者"></p>
<h4 id="生产者和生产者组"><a href="#生产者和生产者组" class="headerlink" title="生产者和生产者组"></a>生产者和生产者组</h4><blockquote>
<p>生产者(Producer)是 RocketMQ 系统中用来构建并传输消息到 RocketMQ服务端 的运行实体。</p>
<p>生产者组(ProducerGroup) 是 区分不同业务类型生产者的逻辑概念。</p>
</blockquote>
<h4 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h4><blockquote>
<p>主题(Topic)是消息传输和存储的<strong>顶层容器</strong>，用于标识同一类业务逻辑的消息，主题通过TopicName来做唯一标识和区分。</p>
</blockquote>
<h4 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h4><blockquote>
<p>消息(Message)是 RocketMQ 中的最小数据传输单元。每个Message都必须指定Topic，RocketMQ 服务端将消息投递到消费端进行消费。</p>
</blockquote>
<h4 id="消息标签"><a href="#消息标签" class="headerlink" title="消息标签"></a>消息标签</h4><blockquote>
<p>消息标签(Message Tag)是 RocketMQ 提供的细粒度消息分类属性，可以在主题层级之下做消息类型的细分。消费者通过订阅特定的标签来实现细粒度过滤。</p>
</blockquote>
<h4 id="消息位点"><a href="#消息位点" class="headerlink" title="消息位点"></a>消息位点</h4><blockquote>
<p>消息按照到达 RocketMQ服务端的先后顺序进行存储在指定topic的队列中，每个消息在所在队列中都有一个唯一的long类型的坐标，用于快速查找消息的位置。</p>
</blockquote>
<h4 id="消息队列-1"><a href="#消息队列-1" class="headerlink" title="消息队列"></a>消息队列</h4><blockquote>
<p>消息队列(Message Queue)是 RocketMQ 中消息存储和传输的<strong>实际容器</strong>，也是消息的最小存储单元。</p>
<p>RocketMQ所有主题由多个队列组成（默认4个），以此实现队列数量的水平拆分和队列内部的流式存储。队列通过QueueId来做唯一标识和区分。队列采用 FIFO - 先进先出 的模式传输，负责向消费者 Push 推送消息，或者由消费者直接 Pull 拉取消息。</p>
</blockquote>
<h4 id="消费者和消费者组"><a href="#消费者和消费者组" class="headerlink" title="消费者和消费者组"></a>消费者和消费者组</h4><blockquote>
<p>消费者(Consumer)是 RocketMQ 用来接收并处理消息的运行实体。消费者通常被集成在业务系统中，从服务端获取消息并进行业务逻辑处理。</p>
<p>消费者组(ConsumerGroup)是 RocketMQ 系统中承载多个消费行为一致的消费者的负载均衡分组的一个逻辑概念。在消费者组中初始化多个消费者实现消费性能的水平扩展以及高可用容灾。一个消费者组可以订阅多个 topic。如果一个主题的消息被多个消费者组订阅，每个消费者组都会独立地消费该消息，即每个消费都会被不同的消费者消费一遍。</p>
</blockquote>
<h4 id="消费点位"><a href="#消费点位" class="headerlink" title="消费点位"></a>消费点位</h4><blockquote>
<p>消费点位（ComsumeOffset）RocketMQ 会记录每个消费者组在一个特定主题（Topic）和队列（Queue）上的消费进度，是消费者组在某个队列上已经成功消费的消息的偏移量，用于快速定位该消费者组下次消费的起点地址。    </p>
</blockquote>
<h4 id="订阅关系"><a href="#订阅关系" class="headerlink" title="订阅关系"></a>订阅关系</h4><blockquote>
<p>订阅关系（Subscription）是 RocketMQ 定义了消费者获取消息、处理消息的规则和状态配置。</p>
<p>订阅关系由消费者组<strong>动态注册</strong>到 RocketMQ服务端，并在后续的消息投递过程中，RocketMQ broker按照注册上来的订阅关系进行消息过滤匹配和消费进度的维护。</p>
</blockquote>
<h3 id="RocketMQ基本工作流程"><a href="#RocketMQ基本工作流程" class="headerlink" title="RocketMQ基本工作流程"></a>RocketMQ基本工作流程</h3><img src="https://s2.loli.net/2024/01/21/VUBXf3hucvWmb5H.png" alt="image-20240121182823616" style="zoom:50%;" />



<ul>
<li>Name Server启动，作为路由控制中心和topic的配置信息，负责维护Broker的路由信息，提供轻量级的服务注册发现和路由功能。Producer和Consumer都需要和Name Server交互来获取路由信息。</li>
<li>Broker和Namesrv建立连接注册信息（包括ip、端口、所存储topic信息）到namesrv，并定时（默认30秒）发送心跳包，用于健康监控（120秒没有收到用于心跳包，则broker会被namesrv剔除）。</li>
<li>Topic用于消息的分类，Topic是消息发布的地址，Producer将消息发送到特定的Topic，而Consumer从Topic接收消息。Topic可以手动添加，也可以在发送消息时由RocketMQ服务端自动创建（自动创建会根据配置文件中指定的默认队列数量分配相应数量的队列，并负载均衡或者其他算法分配到不同的broker节点中）。</li>
<li>Producer首先会从Name Server获取Broker的路由信息，然后根据路由信息将消息发送到指定的Broker中。</li>
<li>Consumer首先会从Name Server获取路由信息来找到对应的Topic所在的Broker中，然后从Broker订阅消息，拉取消息进行消费。</li>
</ul>
<h3 id="RocketMQ部署"><a href="#RocketMQ部署" class="headerlink" title="RocketMQ部署"></a>RocketMQ部署</h3><img src="https://s2.loli.net/2024/01/17/cHkKf72BRnxop5b.png" alt="image-20240117222521555" style="zoom:33%;" />

<p>RocketMQ拓扑结构：</p>
<img src="https://s2.loli.net/2024/01/14/7Q3POMTD1wUkxWH.png" alt="image-20240114190733792" style="zoom:33%;" />

<p>在部署中，有三个重要的组建，分别是 namesrv、broker 和 console。它们承担着不同的角色和功能</p>
<ul>
<li>namesrv：存储和管理整个RocketMQ集群中topic的路由信息，维护了一个topic到broker的映射关系。<ul>
<li>在producer发送消息时或者consumer消费消息时，需要向namesrv查询路由信息，以确定消息的发送或消费的broker。</li>
</ul>
</li>
<li>broker：RocketMQ的消息存储和消息传递的核心组件，负责存储producer发送的消息，并且将这些消息推送给consumer。</li>
<li>console：RocketMQ的控制台即可视化管理界面，用于监控和管理RocketMQ集群。<ul>
<li>通过控制台，管理者可以查看集群的运行状态，监控息的发送和消费情况，管理topic和consumer等。</li>
</ul>
</li>
</ul>
<h4 id="单节点-RocketMQ-部署"><a href="#单节点-RocketMQ-部署" class="headerlink" title="单节点 RocketMQ 部署"></a>单节点 RocketMQ 部署</h4><blockquote>
<p>运行前 需要设置挂载目录读写权限 </p>
<p>mkdir -p /mydata/rocketmq/namesrv</p>
<p>chmod 777 -R /mydata/rocketmq/namesrv/*</p>
<p>mkdir -p /mydata/rocketmq/broker</p>
<p>chmod 777 -R /mydata/rocketmq/broker/*</p>
</blockquote>
<p>docker-compose.yml文件如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rocketmq_namesrv:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/rocketmq</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rocketmq_namesrv</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/rocketmq/namesrv/logs:/home/rocketmq/logs</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>,<span class="string">&quot;mqnamesrv&quot;</span> ]</span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">JAVA_OPT_EXT:</span> <span class="string">&quot;-Duser.home=/home/rocketmq -Xms256m -Xmx256m -Xmn128m&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9876</span><span class="string">:9876</span></span><br><span class="line">  <span class="attr">rocketmq_broker:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/rocketmq</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rocketmq_broker</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rocketmq_namesrv</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;sh&quot;</span>,<span class="string">&quot;mqbroker&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/home/rocketmq/broker.conf&quot;</span>,<span class="string">&quot;autoCreateTopicEnable=true&quot;</span> ]</span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">NAMESRV_ADDR:</span> <span class="string">&quot;rocketmq_namesrv:9876&quot;</span></span><br><span class="line">      <span class="attr">JAVA_OPT_EXT:</span> <span class="string">&quot;-Duser.home=/home/rocketmq -server -Xms128m -Xmx128m -Xmn128m&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/rocketmq/broker/logs:/home/rocketmq/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/rocketmq/broker/store:/home/rocketmq/store</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/rocketmq/broker/conf/broker.conf:/home/rocketmq/broker.conf</span> <span class="comment"># broker.conf 配置参考: https://github.com/apache/rocketmq/blob/master/distribution/conf/broker.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10909</span><span class="string">:10909</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10911</span><span class="string">:10911</span></span><br><span class="line">  <span class="attr">rocketmq_dashboard:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apacherocketmq/rocketmq-dashboard:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rocketmq-dashboard</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rocketmq_namesrv</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">JAVA_OPTS:</span> <span class="string">&quot;-Xmx256m -Xms256m -Xmn128m -Drocketmq.namesrv.addr=rocketmq_namesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">11880</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>

<p>其中 broker.conf 配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 集群名称</span><br><span class="line">brokerClusterName = DefaultCluster</span><br><span class="line"># broker 名称</span><br><span class="line">brokerName = broker-a</span><br><span class="line"># broker IP地址</span><br><span class="line">brokerIP1=xx.xxx.xxx.xxx</span><br><span class="line"># brokerId 0为master 大于0为slave</span><br><span class="line">brokerId = 0</span><br><span class="line"># 每日凌晨4点删除过期日志</span><br><span class="line">deleteWhen = 04</span><br><span class="line"># 日志文件保留时间 默认48小时</span><br><span class="line">fileReservedTime = 48</span><br><span class="line"># broker主从复制策略（默认：ASYNC_MASTER）ASYNC_MASTER-异步复制Master SYNC_MASTER-同步双写Master</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br><span class="line"># broker刷盘策略（默认：ASYNC_FLUSH）：ASYNC_MASTER-异步刷盘（性能好，但宕机可能会导致数据丢失） ASYNC_FLUSH-同步刷盘（性能差，但不会导致数据丢失）</span><br><span class="line">flushDiskType = ASYNC_FLUSH</span><br><span class="line"># 是否允许 broker 在当前topic不存在时自动创建 topic (线上环境设置为 false)</span><br><span class="line">autoCreateTopicEnable=true</span><br><span class="line"># 是否允许 broker 自动创建订阅组（线上环境设置为 false）</span><br><span class="line"># 自动创建时读写队列数量</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"># 开启SQL属性过滤</span><br><span class="line">enablePropertyFilter=true</span><br></pre></td></tr></table></figure>

<h4 id="同步复制和异步复制"><a href="#同步复制和异步复制" class="headerlink" title="同步复制和异步复制"></a>同步复制和异步复制</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># broker主从辅助策略（默认：ASYNC_MASTER）ASYNC_MASTER-异步复制Master SYNC_MASTER-同步双写Master</span><br><span class="line">brokerRole = ASYNC_MASTER</span><br></pre></td></tr></table></figure>

<h5 id="同步复制（默认）"><a href="#同步复制（默认）" class="headerlink" title="同步复制（默认）"></a>同步复制（默认）</h5><ul>
<li><p>特点：生产者发送消息，在主节点接收到消息后，必须等待所有从节点都成功写入该消息即等待从从节点完成数据同步，主节点才会响应结果给生产者</p>
</li>
<li><p>优点：数据一致性好，从节点数据与主节点完全一致，不会产生丢失数据的风险</p>
</li>
<li><p>缺点：同步阻塞，性能相对较差</p>
</li>
<li><p>应用场景：同步复制适用于强一致性要求较高，不能容忍数据丢失的场景，例如关键业务数据变更，数据安全性要求高的。</p>
<img src="https://s2.loli.net/2024/01/21/rCEpIeo8Bj14OXl.png" alt="image-20240121202223163" style="zoom:50%;" /></li>
</ul>
<h5 id="异步复制"><a href="#异步复制" class="headerlink" title="异步复制"></a>异步复制</h5><ul>
<li><p>特点：生产者发送消息，在主节点接收到消息后，不需要等待从节点写入成功，直接响应结果给生产者</p>
</li>
<li><p>优点：性能较好，主节点不需要等待从节点确认，可以更快地响应结果</p>
</li>
<li><p>缺点：存在一定的数据不一致性，主从节点数据可能在一段时间内存在差异</p>
</li>
<li><p>应用场景：异步复制适用于对一致性要求较低，追求吞吐量，可以容忍一定的时间内不一致和数据丢失的风险的场景</p>
<img src="https://s2.loli.net/2024/01/21/pluLKwaFGqbnWdR.png" alt="image-20240121152510526" style="zoom:50%;" /></li>
</ul>
<h3 id="RocketMQ-dashboard使用"><a href="#RocketMQ-dashboard使用" class="headerlink" title="RocketMQ dashboard使用"></a>RocketMQ dashboard使用</h3><img src="https://s2.loli.net/2024/01/21/qeohU8nbELvMNWK.png" alt="image-20240121135503401" style="zoom:33%;" />

<h3 id="RabbitMQ高可用方案"><a href="#RabbitMQ高可用方案" class="headerlink" title="RabbitMQ高可用方案"></a>RabbitMQ高可用方案</h3><h4 id="高可用架构"><a href="#高可用架构" class="headerlink" title="高可用架构"></a>高可用架构</h4><p>生产使用高可用的多主多从的拓扑结构</p>
<img src="https://s2.loli.net/2024/01/21/FZn8ortvmzBIuyA.png" alt="image-20240121202426604" style="zoom:50%;" />

<p>多个namesrv节点可以提高系统的可用性和容错性。多主多从的broker节点，主broker节点可以处理读写请求，从broker节点只能处理读请求，从节点用于备份和提高可用性。在主从broker之间，数据通过日志 commitlog 进行同步，    </p>
<h4 id="高可用实现"><a href="#高可用实现" class="headerlink" title="高可用实现"></a>高可用实现</h4><ul>
<li><p>当一个主broker-a节点挂了则停止服务，不会接受新的消息，rocketmq默认不会自动主从切换，此时生产者无法从rocketmq中消费消息，利用重试机制切换到其从节点消费消息，已经被同步到其从节点broker-slave-a的消息可以正常被消息者消费。</p>
<p>在同步复制的模式下，消息数据不会丢失，而在异步复制的模式下，主节点可能还有消息没有同步，可能会导致消息数据丢失的问题。</p>
<p>当生产者向从broker-a节点发送消息时，broker-a无法响应，生产者触发重试机制，向另一个从broker-b发送消息，从而保证高可用。</p>
<p>主broker-a超过120秒没有上报信息到namesrv时，namesrv将剔除主broker-a的信息。</p>
</li>
<li><p>当主从集群 broker-a 和 broker-slave-a 同时挂掉，服务无法响应读写请求，无法接受也无法消费消息，但是数据化持久化，消息不会丢失。新消息会被发到其他节点上。</p>
</li>
<li><p>当 namesrv-a节点挂掉，生产者和消费者无法获取broker的路由信息，会轮询尝试到另一个namesrv节点获取。</p>
</li>
<li><p>当 broker-a主从集群和 namesrv-a之间的网络阻塞的请求，导致 namesrv节点之间数据不一致，此时一个消费者从namesrv-a中获取路由信息，会导致broker-a主从集群产生的消息无法消费，持续挤压，解决方案只有调试网络或者动态不停机的修改消费者配置。</p>
</li>
</ul>
<h3 id="Java应用接入RocketMQ"><a href="#Java应用接入RocketMQ" class="headerlink" title="Java应用接入RocketMQ"></a>Java应用接入RocketMQ</h3><h4 id="引入-RocketMQ-客户端"><a href="#引入-RocketMQ-客户端" class="headerlink" title="引入 RocketMQ 客户端"></a>引入 RocketMQ 客户端</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rocketmq --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="新建测试类发送消息"><a href="#新建测试类发送消息" class="headerlink" title="新建测试类发送消息"></a>新建测试类发送消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RocketMQApp.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testProduce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 生产者为 producerGroup1 的 DefaultMQProducer 消息生产者对象</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">defaultMQProducer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;producerGroup1&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置 消息生产者对象 的 namesrv 地址 （多个节点间用分号分割）</span></span><br><span class="line">        defaultMQProducer.setNamesrvAddr(<span class="string">&quot;xx.xxx.xxx.xxx:9876&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生产者启动，与 namesrv 建立长连接查询路由，与 topic 所处的 broker 建立长连接用于发送消息</span></span><br><span class="line">            defaultMQProducer.start();</span><br><span class="line">            <span class="comment">// 创建 message</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span> (<span class="string">&quot;simple&quot;</span>, <span class="string">&quot;hello wolrd!&quot;</span>.getBytes());</span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> defaultMQProducer.send(message);</span><br><span class="line">            logger.info(<span class="string">&quot;send message：&#123;&#125;&quot;</span>, sendResult);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 关闭长连接</span></span><br><span class="line">                defaultMQProducer.shutdown();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// 防止 start 建立连接失败</span></span><br><span class="line">                logger.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testComsume</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">defaultMQPushConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;comsumerGroup1&quot;</span>);</span><br><span class="line">        defaultMQPushConsumer.setNamesrvAddr(<span class="string">&quot;xx.xxx.xxx.xxx:9876&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 消息订阅 subExpression * 表示 所有 tags</span></span><br><span class="line">            defaultMQPushConsumer.subscribe(<span class="string">&quot;simple&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">            <span class="comment">// 注册消息的监听器 - 监听 broker 推送的消息并处理</span></span><br><span class="line">            defaultMQPushConsumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">@param</span> msgs msgs.size() &gt;= 1&lt;br&gt; DefaultMQPushConsumer.consumeMessageBatchMaxSize=1,you can modify here</span></span><br><span class="line"><span class="comment">                 *             消息批量推送 提高消息消费的吞吐量</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">                 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(msg.getBody(), StandardCharsets.UTF_8);</span><br><span class="line">                        logger.info(<span class="string">&quot;consume message：&#123;&#125;&quot;</span>, content);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 返回接收成功标识</span></span><br><span class="line">                    <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 消费者启动，与namesrv建立长连接查询路由，与 topic 所处的 broker 建立长连接，开启监听消息的推送</span></span><br><span class="line">            defaultMQPushConsumer.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>).await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ功能特性"><a href="#RocketMQ功能特性" class="headerlink" title="RocketMQ功能特性"></a>RocketMQ功能特性</h2><h3 id="普通消息"><a href="#普通消息" class="headerlink" title="普通消息"></a>普通消息</h3><blockquote>
<p>普通消息为 Apache RocketMQ 中最基础的消息，本章将介绍普通消息的应用场景、功能原理、使用方法和使用建议。</p>
</blockquote>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><blockquote>
<p>普通消息一般应用于微服务解耦、事件驱动、数据集成等场景。这些场景要求消息的可靠性，但是对消息的处理时机、处理顺序没有特别要求。</p>
</blockquote>
<ul>
<li><p>异步解耦</p>
<p><img src="https://s2.loli.net/2024/01/07/onVuci6WHhU14Jb.png" alt="在线消息处理"></p>
<p>上游系统将一个一个业务事件封装成独立的普通消息并发送至 RocketMQ服务端，下游按需订阅 RocketMQ服务端 消息，拉取到消息后按照本地消费逻辑处理下游任务。</p>
</li>
<li><p>数据集成</p>
<p><img src="https://s2.loli.net/2024/01/07/8fOZ3vdeT7cpSFL.png" alt="数据传输"></p>
<p>以日志收集场景为例，日志信息转发到 RocketMQ，每条消息即是一段日志数据，RocketMQ 不用不做任何处理，将日志数据可靠的投递到下游的存储系统和分析系统等，后续由不同系统处理即可。</p>
</li>
</ul>
<h4 id="功能原理"><a href="#功能原理" class="headerlink" title="功能原理"></a>功能原理</h4><blockquote>
<p>普通消息是 rocketmq 的基本功能，支持生产者和消费者的异步解耦通信</p>
</blockquote>
<h4 id="普通消息生命周期"><a href="#普通消息生命周期" class="headerlink" title="普通消息生命周期"></a>普通消息生命周期</h4><p><img src="https://s2.loli.net/2024/01/07/ehcEBjkVlyY2SPi.png" alt="生命周期"></p>
<ul>
<li>初始化 - Initialized：消息被生产者构建并完成初始化，待发送到RocketMQ服务端的状态</li>
<li>待消费 - Ready：消息被发送到RocketMQ服务端，等待消费者消费的状态</li>
<li>消费中 - Inflight：消息被消费者获取，并按照消费者本地的业务逻辑进行处理的过程<ul>
<li>此过程RocketMQ服务端会等待消费者完成消费并提交消费结果至RocketMQ服务端</li>
<li>如果一定时间后没有收到消费者响应，RocketMQ会对消息进行重试处理</li>
</ul>
</li>
<li>消息确认：消费者完成消费处理，并向RocketMQ服务端提交消费结果，服务端标记当前消息的处理状态（包括消费成功和失败）<ul>
<li>RocketMQ 默认持久化所有消息，被消费的消息不会立即删除，而是进行逻辑标记消费状态</li>
<li>当消息在保存时间到期或者存储空间不足被删除前，消费者支持回溯消息来重新消费</li>
</ul>
</li>
<li>消息删除：RocketMQ按照消息保存机制滚动清理最早的消息数据，将消息从物理文件中删除。</li>
</ul>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NormalTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(RocketMQApp.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testProduce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// DefaultMQProducer 用于发送非事务消息</span></span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">defaultMQProducer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;producer-group-normal&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置 namesrv 地址</span></span><br><span class="line">        defaultMQProducer.setNamesrvAddr(<span class="string">&quot;xx.xxx.xxx.xxx:9876&quot;</span>);</span><br><span class="line">        <span class="comment">// 异步发送失败后重试2次 消息高可靠性的处理方式</span></span><br><span class="line">        defaultMQProducer.setRetryTimesWhenSendAsyncFailed(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生产者启动</span></span><br><span class="line">            defaultMQProducer.start();</span><br><span class="line">            <span class="comment">// 创建 message</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span> (<span class="string">&quot;simple&quot;</span>, <span class="string">&quot;default-tag&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;hello wolrd!&quot;</span>.getBytes());</span><br><span class="line">            <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> defaultMQProducer.send(message);</span><br><span class="line">            logger.info(<span class="string">&quot;send message：&#123;&#125;&quot;</span>, sendResult);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 关闭长连接</span></span><br><span class="line">                defaultMQProducer.shutdown();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// 防止 start 建立连接失败</span></span><br><span class="line">                logger.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testComsume</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">defaultMQPushConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;producer-group-normal&quot;</span>);</span><br><span class="line">        defaultMQPushConsumer.setNamesrvAddr(<span class="string">&quot;xx.xxx.xxx.xxx:9876&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 消息订阅 subExpression * 表示 所有 tags</span></span><br><span class="line">            defaultMQPushConsumer.subscribe(<span class="string">&quot;simple&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">            <span class="comment">// 注册消息的监听器 - 监听 broker 推送的消息并处理</span></span><br><span class="line">            defaultMQPushConsumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(msg.getBody(), StandardCharsets.UTF_8);</span><br><span class="line">                    logger.info(<span class="string">&quot;consume message：&#123;&#125;&quot;</span>, content);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 返回接收成功标识</span></span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 消费者启动，与namesrv建立长连接查询路由，与 topic 所处的 broker 建立长连接，开启监听消息的推送</span></span><br><span class="line">            defaultMQPushConsumer.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>).await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h4><p>设置全局唯一业务key，方便问题追踪和定位</p>
<img src="https://s2.loli.net/2024/01/25/P12gbz4TAvZOINo.png" alt="image-20240125200801026" style="zoom:50%;" />

<h3 id="定时-延迟消息"><a href="#定时-延迟消息" class="headerlink" title="定时/延迟消息"></a>定时/延迟消息</h3><blockquote>
<p>定时/延时消息是 Apache RocketMQ 中的高级特性消息，是生产者将消息发送给broker后，broker不会立即将消息投递给具体的消费者，而是在一定的时间后或者指定的某个时间点再进行消息的投递</p>
<p>定时和延时的本质是一样的，服务端都是根据消息设置的定时时间<strong>在某一个固定的时刻</strong>将消息投递给消费者消费。</p>
</blockquote>
<h4 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h4><p>定时/延迟消息可以应用于分布式定时调度、任务超时处理等场景。</p>
<ul>
<li><input disabled="" type="checkbox"> rocketmq5.x 支持任意时间的消息 怎么没有</li>
</ul>
<h4 id="功能原理-1"><a href="#功能原理-1" class="headerlink" title="功能原理"></a>功能原理</h4><h4 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h4><h4 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h4><h4 id="使用建议-1"><a href="#使用建议-1" class="headerlink" title="使用建议"></a>使用建议</h4><h3 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h3><h4 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h4><p>在有序事件处理，例如订单消息处理，订单需要严格按照 “订单创建-&gt;财务结算-&gt;物流消息” 等环节的顺序，以避免混乱或错误的处理。</p>
<p>当使用普通消息时，消息发送到不同的队列中，不同队列的消息积压或者其他因素会导致消息被投递到消费者消费的时机不同，这时就会导致消费没有按照顺序执行。</p>
<img src="https://s2.loli.net/2024/01/24/Eya5gzpmRikVCLG.png" alt="image-20240124132737720" style="zoom:50%;" />

<h4 id="功能原理-2"><a href="#功能原理-2" class="headerlink" title="功能原理"></a>功能原理</h4><blockquote>
<p>顺序消息是 RocketMQ 提供的一种高级消息类型，支持消费者按照生产者发送消息的先后顺序获取消息，从而实现业务场景中的顺序处理。 </p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> 分区有序消息和全局有序消息  消息组 </li>
</ul>
<h3 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h3><blockquote>
<p>RocketMQ的事务消息支持在分布式场景下保障<strong>消息生产</strong>和<strong>本地事务</strong>的最终一致性。</p>
</blockquote>
<h4 id="应用场景-3"><a href="#应用场景-3" class="headerlink" title="应用场景"></a>应用场景</h4><p>分布式事务需要保证核心业务和多个下游业务的执行结果的完全一致。</p>
<img src="https://s2.loli.net/2024/01/26/2petH7PvruAVQS4.png" alt="事务消息诉求" style="zoom:50%;" />

<p>基于普通消息方案，本地事务和消息的生产无法保证一致性</p>
<ul>
<li>先执行本地事务，再生产消息<ul>
<li>过程：执行本地事务，再生产消息，通过消息生产回执来判断消息生产的状态，成功则提交事务，失败则回滚事务</li>
<li>问题 - 阻塞：当出现网络问题时，消息生产回执响应太慢，保证本地事务无法提交，方法响应时间长。在大并发的场景下，数据库连接池被耗尽，大量请求积压连接池等待，请求向前积压到tomcat连接池，网关等，导致雪崩，整个系统不可用</li>
</ul>
</li>
<li>先生产消息：再执行本地事务：<ul>
<li>过程：先发送消息，消息发送成功后，再进行本地事务的执行和提交。</li>
<li>问题 - 回滚：当本地事务的执行失败并回滚时，则已经发送的消息需要被撤销，但普通消息无法撤销消息。</li>
</ul>
</li>
</ul>
<blockquote>
<p>RocketMQ 提供的分布式事务消息可以保证应用<strong>本地事务</strong>和<strong>消息生产</strong>的<strong>最终一致性</strong>。</p>
</blockquote>
<p>上述普通消息无法保证一致性的本质原因是 普通消息无法具备提交、回滚和统一协调的能力。</p>
<p>而基于 RocketMQ 的分布式事务消息，将 本地消息和本地事务 绑定，实现全局提交结果的一致性。</p>
<img src="https://s2.loli.net/2024/01/26/ISKA8jmERNlPrs2.png" alt="image-20240126091647924" style="zoom: 33%;" />

<h4 id="功能原理-3"><a href="#功能原理-3" class="headerlink" title="功能原理"></a>功能原理</h4><h5 id="事务消息流程"><a href="#事务消息流程" class="headerlink" title="事务消息流程"></a>事务消息流程</h5><p><img src="https://s2.loli.net/2024/01/25/BRlL9sYAokf7CNx.png" alt="事务消息"></p>
<ol>
<li>生产者将消息发送至RocketMQ服务器</li>
<li>RocketMQ服务将消息持久化成功后，向生产者返回ACK确认消息已经发送成功，但是此时消息被标记为半事务消息 - half message，在这种状态下消息”暂时不能投递”</li>
<li>生产者收到ACK确认消息后，开始执行本地事务</li>
<li>生产者向RocketMQ服务器提交本地事务的执行结果（commit|rollback），RocketMQ服务器根据执行结果做出不同的处理<ul>
<li>当提交的本地事务执行结果为 <strong>commit</strong>，RocketMQ 服务器将消息从<strong>半事务</strong>状态标记为<strong>可投递</strong>状态，并投递给消费者</li>
<li>当提交的本地事务执行结果为 <strong>rollback</strong>，RocketMQ 服务器将不会对应事务的半事务消息投递给消费者</li>
</ul>
</li>
<li>在断网或者生产者应用重启等特殊情况下，若 RocketMQ服务器没有收到生产者的本地事务的执行结果 或者 收到的结果为 UNKNOWN -未知状态。经过固定时间后，RocketMQ服务器对消息生产者集群的任一实例发起消息进行<strong>回查</strong>（回查的时间间隔和最大回查次数可以配置）。</li>
<li>任一生产者实例收到回查后，检查对应消息的本地事务的执行的最终结果。并将检查到的本地事务的最终状态再次提交，rocketMQ服务器按照步骤4对于半事务消息进行处理。</li>
</ol>
<h5 id="事务消息生命周期"><a href="#事务消息生命周期" class="headerlink" title="事务消息生命周期"></a>事务消息生命周期</h5><img src="https://s2.loli.net/2024/01/30/lykL7WxQOIYjnuG.png" alt="image-20240126101352640" style="zoom:50%;" />

<p>相比于，事务消息的生命周期多了事务待提交和消息回滚的周期，</p>
<ul>
<li>半事务消息在发送到RocketMQ服务器中时，不会直接被持久化到服务端，而是会被单独存储在事务存储系统中，此时消息对消费者不可见，等待二阶段本地事务执行后再返回结果。</li>
<li>消息回滚，在本地事务执行结果为rollback时，RocketMQ会将半事务消息回滚，该事务消息流程终止。</li>
</ul>
<h4 id="使用示例-2"><a href="#使用示例-2" class="headerlink" title="使用示例"></a>使用示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionTest</span> <span class="keyword">extends</span> <span class="title class_">CommonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 构建事务消息生产者 TransactionMQProducer</span></span><br><span class="line">        <span class="type">TransactionMQProducer</span> <span class="variable">transactionMQProducer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransactionMQProducer</span>(<span class="string">&quot;produce_group_transaction&quot;</span>);</span><br><span class="line">        transactionMQProducer.setNamesrvAddr(<span class="string">&quot;xx.xxx.xxx.xx:9876&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// cachedThreadPool 用于本地事务回查</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">cachedThreadPool</span> <span class="operator">=</span> Executors.newCachedThreadPool(r -&gt; &#123;</span><br><span class="line">            <span class="comment">// 重写线程工厂的构造方法 定义线程名称</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">            thread.setName(<span class="string">&quot;check-transaction-thread&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 设置 本地事务连接池 用于回查</span></span><br><span class="line">        transactionMQProducer.setExecutorService(cachedThreadPool);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 本地事务监听器 同于执行代码</span></span><br><span class="line">        transactionMQProducer.setTransactionListener(<span class="keyword">new</span> <span class="title class_">DemoTransactionListener</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            transactionMQProducer.start();</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;transaction&quot;</span>, <span class="string">&quot;transaction-1001&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;1001&quot;</span>, <span class="string">&quot;transaction json message 1001&quot;</span>.getBytes());</span><br><span class="line">            logger.info(<span class="string">&quot;发送事务消息...&quot;</span>);</span><br><span class="line">            <span class="comment">// 使用 sendMessageInTransaction 发送事务消息</span></span><br><span class="line">            transactionMQProducer.sendMessageInTransaction(message, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 关闭长连接</span></span><br><span class="line">                transactionMQProducer.shutdown();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// 防止 start 建立连接失败</span></span><br><span class="line">                logger.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">defaultMQPushConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;producer-group-transaction&quot;</span>);</span><br><span class="line">        defaultMQPushConsumer.setNamesrvAddr(<span class="string">&quot;xx.xxx.xxx.xxx:9876&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 消息订阅 subExpression * 表示 所有 tags</span></span><br><span class="line">            defaultMQPushConsumer.subscribe(<span class="string">&quot;transaction&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">            <span class="comment">// 注册消息的监听器 - 监听 broker 推送的消息并处理</span></span><br><span class="line">            defaultMQPushConsumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(msg.getBody(), StandardCharsets.UTF_8);</span><br><span class="line">                    logger.info(<span class="string">&quot;consume message：&#123;&#125;&quot;</span>, content);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 返回接收成功标识</span></span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 消费者启动，与namesrv建立长连接查询路由，与 topic 所处的 broker 建立长连接，开启监听消息的推送</span></span><br><span class="line">            defaultMQPushConsumer.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>).await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DemoTransactionListener</span> <span class="keyword">implements</span> <span class="title class_">TransactionListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(DemoTransactionListener.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isSucc</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行本地事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg Half(prepare) message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arg Custom business parameter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState <span class="title function_">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;正在执行本地事务...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟本地事务执行状态</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            // ...</span></span><br><span class="line">        <span class="comment">// 本地事务执行成功</span></span><br><span class="line"><span class="comment">//            connection.commit();</span></span><br><span class="line"><span class="comment">//            return LocalTransactionState.COMMIT_MESSAGE;</span></span><br><span class="line"><span class="comment">//        &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">//            // 发生异常本地事务回滚</span></span><br><span class="line"><span class="comment">//            connection.rollback();</span></span><br><span class="line"><span class="comment">//            return LocalTransactionState.ROLLBACK_MESSAGE;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟随机结果</span></span><br><span class="line">        isSucc = <span class="keyword">new</span> <span class="title class_">Random</span>().nextBoolean();</span><br><span class="line">        logger.info(<span class="string">&quot;正在执行本地事务结果:&#123;&#125;&quot;</span>, isSucc);</span><br><span class="line">        <span class="keyword">return</span> isSucc ?</span><br><span class="line">                LocalTransactionState.COMMIT_MESSAGE : LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回查本地事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg Check message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> LocalTransactionState <span class="title function_">checkLocalTransaction</span><span class="params">(MessageExt msg)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;正在执行本地事务回查&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        String msgId = msg.getMsgId();</span></span><br><span class="line"><span class="comment">//        logger.info(&quot;回查检查本地事务key:&#123;&#125;状态&quot;, msgId);</span></span><br><span class="line"><span class="comment">//        XX xx = xxDao.selectById(msgId);</span></span><br><span class="line"><span class="comment">//        return xx != null ? LocalTransactionState.COMMIT_MESSAGE : LocalTransactionState.ROLLBACK_MESSAGE;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> isSucc ? LocalTransactionState.COMMIT_MESSAGE : LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="RocketMQ高级"><a href="#RocketMQ高级" class="headerlink" title="RocketMQ高级"></a>RocketMQ高级</h2><h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ul>
<li>消费者(Consumer)：RocketMQ 用来接收并处理消息的运行实体。消费者通常被集成在业务系统中，从服务端获取消息并进行业务逻辑处理。</li>
</ul>
<ul>
<li>消费者组(ConsumerGroup)：RocketMQ 系统中承载多个消费行为一致的消费者的负载均衡分组的一个逻辑概念。在消费者组中初始化多个消费者实现消费性能的水平扩展以及高可用容灾。一个消费者组可以订阅多个 topic。</li>
<li>订阅关系(Subscription)：订阅关系以消费组粒度进行管理，消费组通过定义订阅关系控制指定消费组下的消费者如何实现消息过滤、消费重试及消费进度恢复等。</li>
</ul>
<h4 id="消费模式"><a href="#消费模式" class="headerlink" title="消费模式"></a>消费模式</h4><p><img src="https://s2.loli.net/2024/01/30/NxAtMBlgPZfzTLi.png" alt="消费方式"></p>
<h5 id="集群消费模式"><a href="#集群消费模式" class="headerlink" title="集群消费模式"></a>集群消费模式</h5><blockquote>
<p>在集群消费模式中，一个消费者组中的每个消费者实例共同消费相同topic的消息。</p>
<p>每个消息只会被消费者组中的一个消费者实例消费，具体消费的策略可以配置，默认是负载均衡。</p>
<p>集群消费模式是默认的消费模式，它的消费进度保存在broker服务端。</p>
</blockquote>
<h6 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置为消费模式为集群消费模式 默认为集群消费模式</span></span><br><span class="line">defaultMQPushConsumer.setMessageModel(MessageModel.CLUSTERING);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClusterTest</span> <span class="keyword">extends</span> <span class="title class_">CommonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">defaultMQProducer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;group-consume-cluster&quot;</span>);</span><br><span class="line">        defaultMQProducer.setNamesrvAddr(<span class="string">&quot;110.42.239.193:9876&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            defaultMQProducer.start();</span><br><span class="line">            logger.info(<span class="string">&quot;producer start&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span>  <span class="string">&quot;这是第&quot;</span> + i + <span class="string">&quot;条消息&quot;</span>;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;topic-consume-cluster&quot;</span>, <span class="string">&quot;test&quot;</span>, String.valueOf(i),content.getBytes());</span><br><span class="line">                <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> defaultMQProducer.send(message);</span><br><span class="line">                logger.info(<span class="string">&quot;sendResult:&#123;&#125;&quot;</span>, sendResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                defaultMQProducer.shutdown();</span><br><span class="line">                logger.info(<span class="string">&quot;producer shutdown&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">defaultMQPushConsumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;group-consume-cluster&quot;</span>);</span><br><span class="line">        defaultMQPushConsumer.setNamesrvAddr(<span class="string">&quot;110.42.239.193:9876&quot;</span>);</span><br><span class="line">        defaultMQPushConsumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            defaultMQPushConsumer.subscribe(<span class="string">&quot;topic-consume-cluster&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">            defaultMQPushConsumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span><br><span class="line"><span class="params">                                                                ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">                    msgs.forEach(messageExt -&gt; logger.info(<span class="string">&quot;consume:&#123;&#125;&quot;</span>, messageExt.getKeys()));</span><br><span class="line">                    <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            defaultMQPushConsumer.start();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>).await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">启动两个消费者实例：</span><br><span class="line">  实例<span class="number">1</span>:</span><br><span class="line"> consume:<span class="number">0</span></span><br><span class="line"> consume:<span class="number">3</span></span><br><span class="line"> consume:<span class="number">4</span></span><br><span class="line"> consume:<span class="number">7</span></span><br><span class="line"> consume:<span class="number">8</span></span><br><span class="line">  实例<span class="number">2</span>:</span><br><span class="line"> consume:<span class="number">1</span></span><br><span class="line"> consume:<span class="number">2</span></span><br><span class="line"> consume:<span class="number">5</span></span><br><span class="line"> consume:<span class="number">6</span></span><br><span class="line"> consume:<span class="number">9</span></span><br></pre></td></tr></table></figure>

<h5 id="广播消费模式"><a href="#广播消费模式" class="headerlink" title="广播消费模式"></a>广播消费模式</h5><blockquote>
<p>在广播消费模式中，一个消费者组中的每个消费者实例都会消费相同主题的所有消息。</p>
<p>每个消息会被消费者组中的每个消费者实例都处理一次。</p>
<p>广播消息的消费进度被保存在每个消费者实例本地，而不是broker服务端中。</p>
</blockquote>
<h6 id="使用方式-1"><a href="#使用方式-1" class="headerlink" title="使用方式"></a>使用方式</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置消费模式 广播消费模式</span></span><br><span class="line">defaultMQPushConsumer.setMessageModel(MessageModel.BROADCASTING);</span><br><span class="line">每个实例都会消费 <span class="number">10</span>条消息</span><br></pre></td></tr></table></figure>

<h4 id="消费重试"><a href="#消费重试" class="headerlink" title="消费重试"></a>消费重试</h4><blockquote>
<p>消费重试是值消费者出现异常或者消费某条消息失败时，RocketMQ 会根据消费重试策略重新投递该消息进行故障恢复，如果超过一定的次数还没有成功，则消息不再继续重试，而是直接被发送到死信队列中。</p>
<p>在这个过程被RocketMQ分为了3个阶段，分别是 正常消费，重试消费和死信，对应主题为 正常原始topic、重试topic和死信topic</p>
</blockquote>
<img src="https://s2.loli.net/2024/01/29/3H9BehnI7GMorCJ.png" alt="image-20240129232123639" style="zoom: 50%;" />

<ul>
<li><p>正常消费：生产者正常消费消息并返回确认给broker，无需做任何处理</p>
</li>
<li><p>重试消息：当网络原因或者其他因素导致消费者消费消息失败时，消息会自动自动保存到重试topic中，格式为”%RETRY%消费者组”，在重试时消费者会自动订阅该重试topic，重新尝试处理消息</p>
<ul>
<li><p>重试一共会进行16次，每次会按照固定的时间间隔进行，每次重试时间间隔不一样</p>
<img src="https://s2.loli.net/2024/01/29/fyThmloXBdC7Jxu.png" alt="image-20240129233807693" style="zoom:50%;" /></li>
</ul>
</li>
<li><p>死信：重试次数耗尽，消息仍然没有消费成功，消息会被保存到死信topic中，死信topic的格式”%DLQ%消费者组名”，进入死信topic的消息不会被再次消费，需要人工介入处理问题</p>
</li>
</ul>
<h4 id="消息获取方式"><a href="#消息获取方式" class="headerlink" title="消息获取方式"></a>消息获取方式</h4><h5 id="push"><a href="#push" class="headerlink" title="push"></a>push</h5><blockquote>
<p>push 推送模式：broker主动向消费者推送最新的消息。</p>
<p>push 模式，消费位点由broker管理，使用简单</p>
<img src="https://s2.loli.net/2024/02/03/oZCVK9YphTdUjBW.png" alt="image-20240203140109107" style="zoom: 33%;" />

<p>push 模式使用的消费者类为 DefaultMQPushConsumer。</p>
</blockquote>
<h5 id="pull"><a href="#pull" class="headerlink" title="pull"></a>pull</h5><blockquote>
<p>pull 拉取模式：消费者主动从broker中拉取消息，提交消费位点。</p>
<p>pull 模式，消费者自主管理消费位点，可以灵活把握消费进度和消费速度，适合流计算和耗时等特殊消费场景。</p>
<img src="https://s2.loli.net/2024/02/03/eGF5Hf2SPijZXkb.png" alt="image-20240203140230182" style="zoom:33%;" />

<p>拉取模式是指由消费者定时向broker发起队列查询请求，broker收到请求后将没有消费的消息返回给消费者进行消费，消费后会发送确认应答给broker。</p>
<p>pull 模式使用的消费者类为 DefaultLitePullConsumer。</p>
</blockquote>
<h5 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h5><img src="https://s2.loli.net/2024/01/30/KDRlrAkVzQNZS18.png" alt="image-20240129235856435" style="zoom:50%;" />

<h3 id="消费过滤"><a href="#消费过滤" class="headerlink" title="消费过滤"></a>消费过滤</h3><blockquote>
<p>消费者订阅了某个主题后，RocketMQ 会将该主题中的所有消息投递给消费者。若消费者只需要关注部分消息，可通过设置过滤条件在 RocketMQ 消费者端进行过滤，只获取到需要关注的消息子集，避免接收到大量无效的消息。</p>
</blockquote>
<h4 id="应用场景-4"><a href="#应用场景-4" class="headerlink" title="应用场景"></a>应用场景</h4><p>在实际业务场景中，同一个主题下的消息往往会被多个不同的下游业务方处理，各下游的处理逻辑不同，只关注自身逻辑需要的消息子集。</p>
<p>RocketMQ 主要解决的单个业务域即同一个主题内不同消息子集的过滤问题，一般是基于同一业务下更具体的分类进行过滤匹配。如果是对不同业务域的消息拆分，应该使用不同的主题进行区分处理。</p>
<h4 id="功能原理-4"><a href="#功能原理-4" class="headerlink" title="功能原理"></a>功能原理</h4><p>消息过滤的含义指的是将<strong>在RocketMQ Broker端将符合条件的消息投递给消费者</strong>，而不是在生产者端将匹配到的消息过滤掉。具体而言就是，RocketMQ 服务端根据生产者和消费者定义的过滤条件（属性或者标签）进行筛选匹配，将符合条件的消息投递给消费者进行消费。</p>
<img src="https://s2.loli.net/2024/01/30/AwSCt6pgNYXIG82.png" alt="消息过滤" style="zoom:50%;" />

<p>流程：</p>
<ul>
<li><p>生产者：生产者在初始化消息时预先为消息设置一些属性和标签，用于后续消费时指定过滤目标</p>
</li>
<li><p>消费者：消费者在初始化及后续消费流程中通过<strong>调用订阅关系注册接口</strong>，<strong>向服务端上报</strong>需要订阅指定主题的目标消息，即<strong>过滤条件</strong></p>
</li>
<li><p>服务端：消费者获取消息时会触发服务端的动态过滤计算，<strong>RocketMQ 服务端根据消费者上报的过滤条件</strong>的表达式进行<strong>匹配</strong>，并将符合条件的消息<strong>投递</strong>给消费者。</p>
</li>
</ul>
<h4 id="订阅关系一致性"><a href="#订阅关系一致性" class="headerlink" title="订阅关系一致性"></a>订阅关系一致性</h4><p>过滤表达式属于订阅关系，RocketMQ 的领域模型规定，同一消费者分组内的多个消费者的订阅关系的过滤表达式必须保持一致，否则可能会导致部分消息消费不到。</p>
<h4 id="过滤分类"><a href="#过滤分类" class="headerlink" title="过滤分类"></a>过滤分类</h4><p>RocketMQ 提供了两种过滤方式：Tag标签过滤 和 SQL标签过滤</p>
<img src="https://s2.loli.net/2024/01/30/eaVOKyR2xYZ3IJm.png" alt="image-20240130101608721" style="zoom:50%;" />

<h5 id="tag-过滤"><a href="#tag-过滤" class="headerlink" title="tag 过滤"></a>tag 过滤</h5><blockquote>
<p>消息标签是 RocketMQ 提供的细粒度消息分类属性，可以在主题层级之下做消息类型的细分。消费者通过订阅特定的标签来实现细粒度过滤。</p>
</blockquote>
<h6 id="使用方式-2"><a href="#使用方式-2" class="headerlink" title="使用方式"></a>使用方式</h6><p>生产者在发送消息时，设置消息的Tag标签</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.rocketmq.common.message.Message#Message(java.lang.String topic, java.lang.String tags, java.lang.String keys, <span class="type">byte</span>[] body) </span><br></pre></td></tr></table></figure>

<p>消费者通过 tag 标签过滤表达式需要指定已有的Tag标签来进行匹配订阅</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.rocketmq.client.consumer.DefaultMQPushConsumer#subscribe(java.lang.String topic, java.lang.String subExpression)</span><br></pre></td></tr></table></figure>

<h6 id="tag标签设置"><a href="#tag标签设置" class="headerlink" title="tag标签设置"></a>tag标签设置</h6><ul>
<li>tag 由生产者发送消息时为消息设置，每条消息只能有一个tag标签</li>
</ul>
<h6 id="tag-标签过滤表达式"><a href="#tag-标签过滤表达式" class="headerlink" title="tag 标签过滤表达式"></a>tag 标签过滤表达式</h6><p>Tag标签过滤为精准字符串匹配，过滤规则 subExpression 设置格式如下：</p>
<ul>
<li>单Tag匹配 - “tag1”：过滤表达式为目标Tag。表示只有消息标签为指定目标Tag的消息符合匹配条件，会被发送给消费者。</li>
<li>多Tag匹配 - “tag1||tag2||tag3”：多个Tag之间为或的关系，不同Tag间使用两个竖线（||）隔开。例如，Tag1||Tag2||Tag3，表示标签为Tag1或Tag2或Tag3的消息都满足匹配条件，都会被发送给消费者进行消费。</li>
<li>全部匹配 - “<em>“：使用星号（</em>）作为全匹配表达式。表示主题下的所有消息都将被发送给消费者进行消费。</li>
</ul>
<h5 id="SQL-属性过滤"><a href="#SQL-属性过滤" class="headerlink" title="SQL 属性过滤"></a>SQL 属性过滤</h5><blockquote>
<p>SQL 属性过滤是 RocketMQ 提供的高级消息过滤方式。生产者为消息设置多个属性（每个属性都是一对自定义的键值对Key-Value），消费者订阅时可设置SQL语法的过滤表达式过滤多个属性。</p>
</blockquote>
<p>生产者设置消息的自定义属性，通过 message.putUserProperty 方法设置，每个消息可以设置多个属性</p>
<p>消费者设置sql过滤规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defaultMQPushConsumer.subscribe(<span class="string">&quot;topic&quot;</span>, MessageSelector.bySql(<span class="string">&quot;SQL属性过滤表达式&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>SQL 属性过滤<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/featureBehavior/07messagefilter">表达式</a>：IS NULL、IS NOT NULL、*&gt;* &gt;= <em>&lt;</em> &lt;=、BETWEEN xxx AND xxx、IN (xxx, xxx)等</p>
<blockquote>
<p>消费者端设置过滤规则，注册订阅关系到服务器端，服务端根据过滤规则进行动态过滤计算，将符号条件的消息投递给消费者。</p>
<p>在消息处理时，出现异常情况、空值情况、数值类型不符的都会被过滤掉，不会投递给消费者。</p>
</blockquote>
<h4 id="使用建议-2"><a href="#使用建议-2" class="headerlink" title="使用建议"></a>使用建议</h4><p>topic和tag的合理划分和选择：不同业务类型的消息使用topic进行拆分，相同业务不同属性或者类型使用tag区分</p>
<h3 id="Rebalance-机制"><a href="#Rebalance-机制" class="headerlink" title="Rebalance 机制"></a>Rebalance 机制</h3><blockquote>
<p>当外部环境发生变化时，例如broker发生掉线，topic扩缩容，消费者扩缩容等，RocketMQ 会自动感知并调整自身的消费，尽量减少消息没有消费</p>
</blockquote>
<h3 id="消息存储和清理"><a href="#消息存储和清理" class="headerlink" title="消息存储和清理"></a>消息存储和清理</h3><img src="https://s2.loli.net/2024/01/29/URbzNP4ilrKvL9E.png" alt="image-20240128150629985" style="zoom:50%;" />

<h4 id="存储介质"><a href="#存储介质" class="headerlink" title="存储介质"></a>存储介质</h4><p>RocketMQ 采用<strong>文件</strong>的方式来做持久化，持久化的模式有两种：同步刷盘和异步刷盘。</p>
<h4 id="消息存储"><a href="#消息存储" class="headerlink" title="消息存储"></a>消息存储</h4><p>RabbitMQ 的消息存储采用 <strong>顺序写、随机读</strong>，保证了消息存储的速度。</p>
<p><img src="https://s2.loli.net/2024/01/28/iXvTxeNlqHwzbM1.png" alt="image-20240128151352481"></p>
<h5 id="存储文件结构"><a href="#存储文件结构" class="headerlink" title="存储文件结构"></a>存储文件结构</h5><p>RocketMQ 消息默认存储在本地磁盘文件，RocketMQ broker 的存储文件结构如下：</p>
<p><img src="https://rocketmq.apache.org/zh/assets/images/store-2eb2d519dd4030480ca3ea63f2dc1b70.jpg" alt="消息存储"></p>
<ul>
<li>commitlog：存储消息物理文件<ul>
<li>文件名长度为20，由文件保存消息的最小物理偏移量offset的基础上高位补0组成</li>
<li>文件大小一般最大为1g，可以通过 mapedFileSizeCommitLog 进行配置</li>
</ul>
</li>
<li>comsumeQueue：存储逻辑队列索引</li>
<li>index：存储消息唯一标识-message key的索引信息 </li>
<li>config：保存了当前broker的topic、订阅关系等配置元数据信息。<ul>
<li>broker 会定时将配置信息从内存持久化到该目录中，用于宕机后到快速恢复</li>
</ul>
</li>
</ul>
<h5 id="消息构成"><a href="#消息构成" class="headerlink" title="消息构成"></a>消息构成</h5><p><img src="https://s2.loli.net/2024/01/30/akfH2t5Px7Uj6AJ.png" alt="image-20240128164256846"></p>
<p>commitlog 目录</p>
<p>commitlog 目录下，可以有多个commitlog文件，但是逻辑上是一个文件，只是为了方便检索和读写将文件物理拆分成多个子文件（默认最大大小为1g），子文件之间通过其保存的第一个物理点位和上一个文件的最后一个物理点位进行连接。</p>
<img src="https://s2.loli.net/2024/01/30/nd6mtXM39ijqvxL.png" alt="image-20240128165134974" style="zoom: 33%;" />

<p>RocketMQ 的CommitLog文件是按照消息的时间顺序和物理offset的顺序来写入的，以保证消息的顺序性和持久性，在执行写入操作时会加锁，以保证多线程访问的安全性。当一个子文件写满后，将会创建一个新的 commitlog，在上一个文件的 offset 的基础上继续写操作。因此所有 commitlog 文件都是连续的，被写入的总是最后一个子文件。</p>
<h4 id="消息检索"><a href="#消息检索" class="headerlink" title="消息检索"></a>消息检索</h4><img src="https://s2.loli.net/2024/01/28/JHuzUneGldIV6AT.png" alt="image-20240128231201092" style="zoom:33%;" />

<ul>
<li><p>利用 MessageID 查询消息</p>
<p>MessageID 是由生产者向broker发送消息成功，由broker自动生成的消息编号，这个编号由ip + port + offset 组成，所以通过它本身就快速查找和操作特定的消息。</p>
</li>
<li><p>实现 tag 过滤查询消息</p>
<p>基于 comsumeQueue 的消息索引实现 tag 过滤查询消息。</p>
<p>comsumeQueue 是一个用于存储消息偏移量信息的数据结构，它可以帮助快速定位消息在 commitlog 文件中的位置。comsumeQueue 的索引条目与消息的偏移量相关联。</p>
<p>comsumeQueue 文件目录结构：comsumeQueue文件夹-&gt;topic目录-&gt;队列编号目录（0｜1｜2｜4）-&gt;consumeQueue文件，其中consumeQueue文件中的数据结构为 物理位点（offset-8字节） + 消息体size大小（4字节） + tag的hashcode值（8字节）。</p>
<p>流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 对于指定的 tag 进行 hash 运算得到对应的 hashcode</span><br><span class="line"><span class="number">2.</span> 从consumeQueue文件中查找对应hashcode的数据</span><br><span class="line"><span class="number">3.</span> 根据这些的数据的物理位置offset从commitlog中提取这些消息</span><br><span class="line"><span class="number">4.</span> 由于哈希冲突即有不同的tag会有相同的hashcode值的情况，因此要对于从commitlog获取的这些offset的数据进行根据具体的tag进行过滤</span><br><span class="line"><span class="number">5.</span> 将过滤过的消息提取出来并封装为 message 进行返回</span><br></pre></td></tr></table></figure></li>
<li><p>通过 key 查询消息</p>
<p>key 是生产者赋予消息的业务唯一标识，RocketMQ的底层存储结构的IndexFile提供了基于key或者时间的索引功能。</p>
<p>IndexFile 是提供的基于 message key 和 时间 的索引文件</p>
</li>
</ul>
<h4 id="消息清理"><a href="#消息清理" class="headerlink" title="消息清理"></a>消息清理</h4><blockquote>
<p>RocketMQ Broker的消息存储文件CommitLog和其他索引文件都是通过顺序写的方式存储在磁盘上，磁盘的空间是有限的，数据不可能无限制追加。</p>
<p>RocketMQ Broker引入了过期文件清理机制。</p>
</blockquote>
<h5 id="CommitLog文件的清理"><a href="#CommitLog文件的清理" class="headerlink" title="CommitLog文件的清理"></a>CommitLog文件的清理</h5><p>Broker 任务调度每隔10秒对当前的commitlog文件进行一次扫描，检查出当前满足删除条件。</p>
<h6 id="删除条件"><a href="#删除条件" class="headerlink" title="删除条件"></a>删除条件</h6><blockquote>
<p>删除72小时内没有产生消费的commitlog文件</p>
</blockquote>
<ul>
<li>默认（可配置）明日凌晨4点</li>
<li>磁盘使用空间超过默认的85%，执行删除</li>
</ul>
<p>删除commitlog的执行过程</p>
<ol>
<li>扫描并根据系统配置的文件保留时间来确定 commitlog 文件的过期状态</li>
<li>对于过期的commitlog文件，首先会进行预删除检查（是否有进程正在使用这些文件，内存引用等）</li>
<li>执行删除操作</li>
<li>处理删除失败的情况（文件正在被使用等），会间隔120秒再次尝试执行重试删除直到文件删除</li>
</ol>
<p>删除索引文件的执行过程</p>
<p>遍历每一个consumeQueue文件，删除过期的消费队列文件以及更新消费队列的最小偏移量，在遍历删除的过程中，每删除一个consumeQueue文件，都会休眠一段时间，再对下一个comsumeQueue文件进行检查和删除操作。indexfile文件同理。</p>
<h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><h4 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h4><p>RocketMQ 采用零拷贝技术，提高性能，降低延迟。</p>
<p>零拷贝：在网络请求和数据返回处理的过程中，避免了数据在用户空间和内核空间之间的多次复制，从而减少拷贝操作，提高数据传输速度。</p>
<p><img src="https://s2.loli.net/2024/01/28/y3hPNSdI1gl8AjO.png" alt="image-20240128152707430"></p>
<p>RocketMQ 使用 MappedByteBuffer类（ Java NIO提供的类，该类提供了内存映射文件的方式即在用户空间创建内核空间文件的内存映射区域，这里的内存映射是指地址映射，而不是整个文件 ）将文件直接映射到用户空间的内存地址空间中，对于文件的操作直接在用户空间对应文件映射的内存区域中进行，避免了数据在内核空间和用户空间的相互拷贝过程。</p>
<h3 id="同步刷盘和异步刷盘"><a href="#同步刷盘和异步刷盘" class="headerlink" title="同步刷盘和异步刷盘"></a>同步刷盘和异步刷盘</h3><p>RocketMQ 处理消息是在内存中进行，但会被持久化到磁盘的 commitlog 文件中以便消息存储和故障恢复。</p>
<p>RocketMQ 提供了两种消息存储到 commitlog 时数据写入磁盘的不同机制：同步刷盘（Synchronous Flush）和异步刷盘（Asynchronous Flush）</p>
<img src="https://s2.loli.net/2024/01/28/JHj1WLXlMgoCfrv.png" alt="image-20240128232339508" style="zoom:50%;" />

<h4 id="同步刷盘"><a href="#同步刷盘" class="headerlink" title="同步刷盘"></a>同步刷盘</h4><p>生产者发送的消息，broker接收消息，消息先存储在内存中，然后 broker 会立即将这些数据同步写入磁盘，消息被持久化到磁盘后，生产者才会收到写入成功的确认。</p>
<p>特点：提供了更高的数据安全性，服务宕机不会丢失数据</p>
<h4 id="异步刷盘"><a href="#异步刷盘" class="headerlink" title="异步刷盘"></a>异步刷盘</h4><p>生产者发送的消息，broker接收消息，消息先存储在内存中， broker 不会立即进行磁盘同步操作，生产者直接收到写入成功的确认，消息会在定时或者适当的时机批量的写入到磁盘中。</p>
<p>特点：提高消息的响应速度和系统的吞吐量，服务宕机可能会丢失数据</p>
<h4 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flushDiskType=SYNC_FLUSH # 同步刷盘</span><br><span class="line">flushDiskType=ASYNC_FLUSH # 异步刷盘</span><br></pre></td></tr></table></figure>

<h3 id="冥等性保障"><a href="#冥等性保障" class="headerlink" title="冥等性保障"></a>冥等性保障</h3><h4 id="冥等性"><a href="#冥等性" class="headerlink" title="冥等性"></a>冥等性</h4><blockquote>
<p>幂等性（Idempotency）是指无论一个操作执行多少次，都会得到相同的结果。</p>
<p>在 RocketMQ 中，保证幂等性主要是为了确保即使同一消息被重复消费（例如，在消息重新投递或系统故障后），也不会对业务产生重复的影响。</p>
</blockquote>
<p>RocketMQ 导致消息重复的原因：</p>
<ul>
<li>发送时的消息重复：早期生产者发送消息到broker，broker完成了数据的持久化后，在响应应答给生产者时网络异常等，导致broker对于生产者应答失败，此时生产者重新发送消息，消费者此时会收到两条完全一样的消息。在现在的版本中，这个问题已经被解决，broker对于相同的messageID进行去重，不会再存储两条相同的消息，而是直接返回成功的响应给生产者。</li>
<li>投递时的消息重复：<ul>
<li>消息已经投递到消费者并完成业务处理，在消费者响应应答给消费者时，网络出现抖动异常或者broker重启或者消费者重启等，broker 没有接收到应答，为了保证消息至少被消费一次，会重试再次投递相同的消息，消费者此时可能处理两次相同的消息。</li>
<li>当RocketMQ 发生重启、因为扩缩容导致的Rebalance也可能会导致重复投递消息。</li>
</ul>
</li>
</ul>
<p>因此处理消息的冥等性非常的重要</p>
<h4 id="处理方式"><a href="#处理方式" class="headerlink" title="处理方式"></a>处理方式</h4><p>处理消息冥等性问题最常见的做法就是在 业务层实现冥等性，为每一条消息设置业务唯一标识（例如：订单号、事务ID等，建议不要使用MessageID作为处理依据，因为MessageId存在重复的情况），然后在消费者的业务逻辑中检查该标识符。在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 生产者</span><br><span class="line"><span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">message.setKey(<span class="string">&quot;order_1234&quot;</span>);</span><br><span class="line"><span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(message);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 消费者</span><br><span class="line">consumer.subscribe(<span class="string">&quot;demo_topic&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="keyword">new</span> <span class="title class_">MessageListener</span>() &#123;</span><br><span class="line">  <span class="keyword">public</span> Action <span class="title function_">consume</span><span class="params">(Message message, ConsumeContext context)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 获取分布式锁 保证线程安全</span></span><br><span class="line">    lock.tryLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> message.getKey();</span><br><span class="line">    <span class="comment">// 查询数据库获取指定key订单状态</span></span><br><span class="line">     <span class="keyword">if</span>(订单状态为<span class="string">&quot;等待支付&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 处理扣款</span></span><br><span class="line">      <span class="comment">// 返回支付成功响应</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span>(订单状态为<span class="string">&quot;已支付&quot;</span>) &#123;</span><br><span class="line">       <span class="comment">// 直接返回支付成功响应</span></span><br><span class="line">     &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot接入RocketMQ"><a href="#SpringBoot接入RocketMQ" class="headerlink" title="SpringBoot接入RocketMQ"></a>SpringBoot接入RocketMQ</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">YuanJW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/02/01/rocketmq/">http://example.com/2023/02/01/rocketmq/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/juc/">juc</a></div><div class="post_share"><div class="social-share" data-image="/img/default-cover/40.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/08/MySQL%E8%BF%9B%E9%98%B6/"><img class="prev-cover" src="/img/default-cover/56.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">MySQL进阶</div></div></a></div><div class="next-post pull-right"><a href="/2023/01/26/2-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JMM/"><img class="next-cover" src="/img/default-cover/2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">JUC 并发编程 (二) JMM</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/01/26/2-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JMM/" title="JUC 并发编程 (二) JMM"><img class="cover" src="/img/default-cover/2.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-26</div><div class="title">JUC 并发编程 (二) JMM</div></div></a></div><div><a href="/2023/01/26/1-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E5%9F%BA%E7%A1%80/" title="JUC 并发编程 (一) 基础"><img class="cover" src="/img/default-cover/49.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-26</div><div class="title">JUC 并发编程 (一) 基础</div></div></a></div><div><a href="/2023/01/26/3-JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-JUC%E5%B7%A5%E5%85%B7/" title="JUC 并发编程 (三) JUC并发工具"><img class="cover" src="/img/default-cover/4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-26</div><div class="title">JUC 并发编程 (三) JUC并发工具</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YuanJW</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/XiaoYuanJW" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/2754742370@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ"><span class="toc-number">1.</span> <span class="toc-text">RocketMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RocketMQ%E5%85%A5%E9%97%A8"><span class="toc-number">1.1.</span> <span class="toc-text">RocketMQ入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.1.1.</span> <span class="toc-text">消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">消息队列的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%80%89%E5%9E%8B"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">消息队列选型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">RocketMQ概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ%E7%89%B9%E6%80%A7"><span class="toc-number">1.1.3.</span> <span class="toc-text">RocketMQ特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.4.</span> <span class="toc-text">RocketMQ基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E7%94%9F%E4%BA%A7%E8%80%85%E7%BB%84"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">生产者和生产者组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E9%A2%98"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">主题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A0%87%E7%AD%BE"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">消息标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%BD%8D%E7%82%B9"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">消息位点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-1"><span class="toc-number">1.1.4.6.</span> <span class="toc-text">消息队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-number">1.1.4.7.</span> <span class="toc-text">消费者和消费者组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E7%82%B9%E4%BD%8D"><span class="toc-number">1.1.4.8.</span> <span class="toc-text">消费点位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.4.9.</span> <span class="toc-text">订阅关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.5.</span> <span class="toc-text">RocketMQ基本工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ%E9%83%A8%E7%BD%B2"><span class="toc-number">1.1.6.</span> <span class="toc-text">RocketMQ部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9-RocketMQ-%E9%83%A8%E7%BD%B2"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">单节点 RocketMQ 部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%92%8C%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">同步复制和异步复制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89"><span class="toc-number">1.1.6.2.1.</span> <span class="toc-text">同步复制（默认）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.1.6.2.2.</span> <span class="toc-text">异步复制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQ-dashboard%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.7.</span> <span class="toc-text">RocketMQ dashboard使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RabbitMQ%E9%AB%98%E5%8F%AF%E7%94%A8%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.8.</span> <span class="toc-text">RabbitMQ高可用方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.8.1.</span> <span class="toc-text">高可用架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.8.2.</span> <span class="toc-text">高可用实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%BA%94%E7%94%A8%E6%8E%A5%E5%85%A5RocketMQ"><span class="toc-number">1.1.9.</span> <span class="toc-text">Java应用接入RocketMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-RocketMQ-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.1.9.1.</span> <span class="toc-text">引入 RocketMQ 客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E6%B5%8B%E8%AF%95%E7%B1%BB%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.9.2.</span> <span class="toc-text">新建测试类发送消息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RocketMQ%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.</span> <span class="toc-text">RocketMQ功能特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%B6%88%E6%81%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">普通消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">功能原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E6%B6%88%E6%81%AF%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">普通消息生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">使用建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF"><span class="toc-number">1.2.2.</span> <span class="toc-text">定时&#x2F;延迟消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">功能原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%99%90%E5%88%B6"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">使用限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">使用示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE-1"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">使用建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">顺序消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86-2"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">功能原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">1.2.4.</span> <span class="toc-text">事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-3"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86-3"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">功能原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.4.2.1.</span> <span class="toc-text">事务消息流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.2.4.2.2.</span> <span class="toc-text">事务消息生命周期</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">使用示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RocketMQ%E9%AB%98%E7%BA%A7"><span class="toc-number">1.3.</span> <span class="toc-text">RocketMQ高级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.3.1.</span> <span class="toc-text">消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">消费模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">集群消费模式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.2.1.1.</span> <span class="toc-text">使用方式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">广播消费模式</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-1"><span class="toc-number">1.3.1.2.2.1.</span> <span class="toc-text">使用方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E9%87%8D%E8%AF%95"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">消费重试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">消息获取方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#push"><span class="toc-number">1.3.1.4.1.</span> <span class="toc-text">push</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pull"><span class="toc-number">1.3.1.4.2.</span> <span class="toc-text">pull</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-number">1.3.1.4.3.</span> <span class="toc-text">对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%BF%87%E6%BB%A4"><span class="toc-number">1.3.2.</span> <span class="toc-text">消费过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF-4"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86-4"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">功能原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">订阅关系一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">过滤分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#tag-%E8%BF%87%E6%BB%A4"><span class="toc-number">1.3.2.4.1.</span> <span class="toc-text">tag 过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-2"><span class="toc-number">1.3.2.4.1.1.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tag%E6%A0%87%E7%AD%BE%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.3.2.4.1.2.</span> <span class="toc-text">tag标签设置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#tag-%E6%A0%87%E7%AD%BE%E8%BF%87%E6%BB%A4%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.3.2.4.1.3.</span> <span class="toc-text">tag 标签过滤表达式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQL-%E5%B1%9E%E6%80%A7%E8%BF%87%E6%BB%A4"><span class="toc-number">1.3.2.4.2.</span> <span class="toc-text">SQL 属性过滤</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BB%BA%E8%AE%AE-2"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">使用建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rebalance-%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.3.</span> <span class="toc-text">Rebalance 机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E5%92%8C%E6%B8%85%E7%90%86"><span class="toc-number">1.3.4.</span> <span class="toc-text">消息存储和清理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">存储介质</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">消息存储</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.4.2.1.</span> <span class="toc-text">存储文件结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%9E%84%E6%88%90"><span class="toc-number">1.3.4.2.2.</span> <span class="toc-text">消息构成</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A3%80%E7%B4%A2"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">消息检索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B8%85%E7%90%86"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">消息清理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CommitLog%E6%96%87%E4%BB%B6%E7%9A%84%E6%B8%85%E7%90%86"><span class="toc-number">1.3.4.4.1.</span> <span class="toc-text">CommitLog文件的清理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.4.4.1.1.</span> <span class="toc-text">删除条件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="toc-number">1.3.5.</span> <span class="toc-text">消息发送</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">零拷贝</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%88%B7%E7%9B%98%E5%92%8C%E5%BC%82%E6%AD%A5%E5%88%B7%E7%9B%98"><span class="toc-number">1.3.6.</span> <span class="toc-text">同步刷盘和异步刷盘</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%88%B7%E7%9B%98"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">同步刷盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%88%B7%E7%9B%98"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">异步刷盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">配置方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%A5%E7%AD%89%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-number">1.3.7.</span> <span class="toc-text">冥等性保障</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%A5%E7%AD%89%E6%80%A7"><span class="toc-number">1.3.7.1.</span> <span class="toc-text">冥等性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.7.2.</span> <span class="toc-text">处理方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot%E6%8E%A5%E5%85%A5RocketMQ"><span class="toc-number">1.4.</span> <span class="toc-text">SpringBoot接入RocketMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.5.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/01/05/jvm-2-%E5%AE%9E%E6%88%98/" title="jvm 实战"><img src="/img/default-cover/34.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jvm 实战"/></a><div class="content"><a class="title" href="/2024/01/05/jvm-2-%E5%AE%9E%E6%88%98/" title="jvm 实战">jvm 实战</a><time datetime="2024-01-04T16:00:00.000Z" title="Created 2024-01-05 00:00:00">2024-01-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/28/jvm-5-%E9%9D%A2%E8%AF%95/" title="No title"><img src="/img/default-cover/39.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2023/12/28/jvm-5-%E9%9D%A2%E8%AF%95/" title="No title">No title</a><time datetime="2023-12-28T07:53:16.603Z" title="Created 2023-12-28 15:53:16">2023-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/28/jvm-1-%E5%9F%BA%E7%A1%80/" title="jvm 基础"><img src="/img/default-cover/25.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="jvm 基础"/></a><div class="content"><a class="title" href="/2023/12/28/jvm-1-%E5%9F%BA%E7%A1%80/" title="jvm 基础">jvm 基础</a><time datetime="2023-12-27T16:00:00.000Z" title="Created 2023-12-28 00:00:00">2023-12-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/06/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7/" title="JVM性能调优工具"><img src="/img/default-cover/37.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JVM性能调优工具"/></a><div class="content"><a class="title" href="/2023/09/06/JVM%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7/" title="JVM性能调优工具">JVM性能调优工具</a><time datetime="2023-09-06T00:31:22.000Z" title="Created 2023-09-06 08:31:22">2023-09-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/24/MybatisX%20%E8%87%AA%E5%AE%9A%E4%B9%89%20FreeMarker%20%E6%A8%A1%E5%9D%97/" title="MybatisX 自定义 FreeMarker 模块"><img src="/img/default-cover/14.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MybatisX 自定义 FreeMarker 模块"/></a><div class="content"><a class="title" href="/2023/06/24/MybatisX%20%E8%87%AA%E5%AE%9A%E4%B9%89%20FreeMarker%20%E6%A8%A1%E5%9D%97/" title="MybatisX 自定义 FreeMarker 模块">MybatisX 自定义 FreeMarker 模块</a><time datetime="2023-06-24T00:31:22.000Z" title="Created 2023-06-24 08:31:22">2023-06-24</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By YuanJW</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>