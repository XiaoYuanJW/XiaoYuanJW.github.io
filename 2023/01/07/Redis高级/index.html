<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis高级 | Hexo</title><meta name="keywords" content="Redis"><meta name="author" content="YuanJW"><meta name="copyright" content="YuanJW"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Redis分布式缓存Redis集群单节点Redis问题 数据丢失问题：redis是内存存储，服务重启可能会导致数据丢失 并发能力问题：redis本身具有较强的并发能力，但是无法满足高并发的场景 故障恢复问题：Redis宕机会导致服务不可用，需要一种自动故障恢复的方法 存储能力问题：Redis单节点存储数据量难以满足海量数据需求   Redis持久化RDB持久化 RDB(Redis Database">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis高级">
<meta property="og:url" content="http://example.com/2023/01/07/Redis%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Redis分布式缓存Redis集群单节点Redis问题 数据丢失问题：redis是内存存储，服务重启可能会导致数据丢失 并发能力问题：redis本身具有较强的并发能力，但是无法满足高并发的场景 故障恢复问题：Redis宕机会导致服务不可用，需要一种自动故障恢复的方法 存储能力问题：Redis单节点存储数据量难以满足海量数据需求   Redis持久化RDB持久化 RDB(Redis Database">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/default-cover/10.png">
<meta property="article:published_time" content="2023-01-07T00:31:22.000Z">
<meta property="article:modified_time" content="2023-06-15T05:44:40.091Z">
<meta property="article:author" content="YuanJW">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/default-cover/10.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/01/07/Redis%E9%AB%98%E7%BA%A7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis高级',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-06-15 13:44:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/default-cover/10.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis高级</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-07T00:31:22.000Z" title="Created 2023-01-07 08:31:22">2023-01-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-06-15T05:44:40.091Z" title="Updated 2023-06-15 13:44:40">2023-06-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis高级"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Redis分布式缓存"><a href="#Redis分布式缓存" class="headerlink" title="Redis分布式缓存"></a>Redis分布式缓存</h1><h2 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h2><h3 id="单节点Redis问题"><a href="#单节点Redis问题" class="headerlink" title="单节点Redis问题"></a>单节点Redis问题</h3><ul>
<li>数据丢失问题：redis是内存存储，服务重启可能会导致数据丢失</li>
<li>并发能力问题：redis本身具有较强的并发能力，但是无法满足高并发的场景</li>
<li>故障恢复问题：Redis宕机会导致服务不可用，需要一种自动故障恢复的方法</li>
<li>存储能力问题：Redis单节点存储数据量难以满足海量数据需求</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/08/NbxMuFW7miGhljw.png" alt="image-20230108005158866"></p>
<h2 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h2><h3 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h3><blockquote>
<p>RDB(Redis Database Backup file-Redis数据备份文件，也称Redis数据快照）指将内存中的所有数据记录到磁盘中。当Redis实例故障重启时，从磁盘读取快照文件，恢复数据。</p>
<p>快照文件称为RDB文件，默认保存在当前运行目录中。Redis停机时会执行一次RDB。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/08/mOUS3QZ6RBh2pIv.png" alt="image-20230108010846854"></p>
<h4 id="RDB文件"><a href="#RDB文件" class="headerlink" title="RDB文件"></a>RDB文件</h4><blockquote>
<p>关闭服务之前，进行一次RDB文件的保存</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/08/SQ5usAFn6W71tkX.png" alt="image-20230108191819684"></p>
<blockquote>
<p>查看挂载目录下的RDB文件</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/08/fXkqKOFlCJbSY5H.png" alt="image-20230108192014178"></p>
<h4 id="Redis配置RDB"><a href="#Redis配置RDB" class="headerlink" title="Redis配置RDB"></a>Redis配置RDB</h4><blockquote>
<p>Redis内部存在触发RDB的机制，可以在配置文件redis.conf文件中进行配置。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/08/AEITQclVNFZytHw.png" alt="image-20230108011229515"></p>
<p><img src="https://s2.loli.net/2023/01/09/vys9aCNJUFEMzHq.png" alt="image-20230109001222260"></p>
<p><img src="https://s2.loli.net/2023/01/09/gcCBXoRNbQKUVmw.png" alt="image-20230109001325781"></p>
<p><img src="https://s2.loli.net/2023/01/09/eQcbJrVGgn5oXy3.png" alt="image-20230109001523581"></p>
<h4 id="Redis的Fork原理"><a href="#Redis的Fork原理" class="headerlink" title="Redis的Fork原理"></a>Redis的Fork原理</h4><blockquote>
<p>bgsave开始时会fork主进程得到子进程，子进程共享主进程的内存数据。异步完成fork后读取内存数据并写入RDB文件中。</p>
</blockquote>
<p>在linux系统中，所有的进程都没有办法直接操作物理内存，操作系统会分配虚拟内存，而主进程只能操作虚拟内存，操作系统会维护一个虚拟内存与物理内存之间的映射关系表（称为页表），bgsave进行fork子进程时，只将页表进行复制。</p>
<p><img src="https://s2.loli.net/2023/01/09/RSuqtB8WZTV5o4U.png" alt="image-20230109002527682"></p>
<p>为了防止同时读写带来的脏数据，fork采用copy-on-write技术</p>
<ul>
<li><p>当主进程执行读操作时，访问只读的共享内存空间</p>
</li>
<li><p>当主进程执行写操作时，会拷贝一份数据副本，进行读写操作</p>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/09/JZeBbPFMdaUg1VI.png" alt="image-20230109002542007"></p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><h5 id="RDB的bgsave的基本流程"><a href="#RDB的bgsave的基本流程" class="headerlink" title="RDB的bgsave的基本流程"></a>RDB的bgsave的基本流程</h5><ul>
<li>fork主进程得到一个子进程，共享内存空间</li>
<li>子进程读取内存数据并写入新的RDB文件</li>
<li>用新RDB文件替换旧的RDB文件</li>
</ul>
<h5 id="RDB会执行时间，save命令的含义"><a href="#RDB会执行时间，save命令的含义" class="headerlink" title="RDB会执行时间，save命令的含义"></a>RDB会执行时间，save命令的含义</h5><ul>
<li>默认是服务停止时执行</li>
<li>save 60 1000代表60秒内至少执行1000次修改则触发RDB</li>
</ul>
<h5 id="RDB的缺点"><a href="#RDB的缺点" class="headerlink" title="RDB的缺点"></a>RDB的缺点</h5><ul>
<li>RDB执行时间间隔较长，两次RDB之间写入数据存在丢失的风险</li>
<li>Fork子进程、压缩、创建RDB文件都是比较耗时</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/09/spgCMDueazmk6Hx.png" alt="image-20230109003106114"></p>
<h3 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h3><h4 id="AOF定义"><a href="#AOF定义" class="headerlink" title="AOF定义"></a>AOF定义</h4><blockquote>
<p>AOF(Append Only File)是追加文件，Redis处理的每一个写命令都会记录到在AOF文件，可以看作是命令日志文件。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/TlOpdCLcWEVrsSb.png" alt="image-20230110090633806"></p>
<h4 id="AOF开启配置"><a href="#AOF开启配置" class="headerlink" title="AOF开启配置"></a>AOF开启配置</h4><blockquote>
<p>AOF默认是关闭状态，在配置文件redis.conf中开启AOF</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#  开启AOF功能，默认是关闭状态</span><br><span class="line">appendonly yes</span><br><span class="line"># AOF文件名称</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过redis.conf文件来配置AOF命令记录的频率</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 表示每次执行一次写命令，立即记录到AOF文件中</span><br><span class="line">appendfsync always</span><br><span class="line"># 写命令执行完后先放入AOF缓冲区，表示每隔一秒将缓冲区的数据写到AOF文件（默认方案）</span><br><span class="line">appendfsync everysec</span><br><span class="line"># 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓存区内容写到AOF文件</span><br><span class="line">appendfsync no</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/01/10/unMgHpOR2seiJrm.png" alt="image-20230110091731459"></p>
<table>
<thead>
<tr>
<th>appendfsync配置项</th>
<th>刷盘时机</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>always</td>
<td>同步刷盘</td>
<td>可靠性高，数据几乎不会丢失</td>
<td>性能影响大</td>
</tr>
<tr>
<td>everysec</td>
<td>每秒刷盘</td>
<td>性能适中</td>
<td>可能会丢失1秒的数据</td>
</tr>
<tr>
<td>no</td>
<td>操作系统控制</td>
<td>性能最好</td>
<td>可靠性比较差，可能会丢失大量数据</td>
</tr>
</tbody></table>
<blockquote>
<p>关闭redis，会有一次AOF文件的同步</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/p5Mh7eb24gajlZz.png" alt="image-20230110093258645"></p>
<blockquote>
<p>redis会从AOF文件中进行一次数据加载 </p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/ZLxgjaHBwXMhsmb.png" alt="image-20230110093514995"></p>
<blockquote>
<p>由于AOF是记录命令，AOF文件会比RBD文件大，而且AOF会记录同一个key的多次写操作，只有最后一次写操作命令才有意义。</p>
<p>通过<code>brewriteaof</code>命令可以后台开启独立线程异步让AOF文件执行重写功能，用最少的命令达到相同的效果</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/zU7gsFxH6f3W1hO.png" alt="image-20230110094021351"></p>
<p><img src="https://s2.loli.net/2023/01/10/Wc7FJIZoNiKtOg4.png" alt="image-20230110094001829"></p>
<blockquote>
<p>Redis会在触发阈值时自动重写AOF文件，阈值可以在配置文件redis.conf中进行配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># AOF文件与上一次重写后文件增加超过百分比触发重写</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line"># AOF文件体积最小多大以上触发重写</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/01/10/N4dEl1WzYbhC9ny.png" alt="image-20230110095108606"></p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p><img src="https://s2.loli.net/2023/01/10/zrQDhE2I8Jsx4oi.png" alt="image-20230110095557170"></p>
<h2 id="Redis主从"><a href="#Redis主从" class="headerlink" title="Redis主从"></a>Redis主从</h2><h3 id="搭建主从架构"><a href="#搭建主从架构" class="headerlink" title="搭建主从架构"></a>搭建主从架构</h3><blockquote>
<p>单节点redis的并发能力是存在上限的，要提高redis的并发能力，需要搭建主从集群，实现读写分离</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/QwMr75DPoIi3uTk.png" alt="image-20230110100433494"></p>
<h4 id="搭建redis从节点"><a href="#搭建redis从节点" class="headerlink" title="搭建redis从节点"></a>搭建redis从节点</h4><blockquote>
<p>使用docker搭建从节点，端口分别是6378和6377</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.1&#x27;</span><br><span class="line">services:</span><br><span class="line">  master:</span><br><span class="line">    environment: </span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-master</span><br><span class="line">    command: redis-server --replica-announce-ip 1.117.34.49 --replica-announce-port 6376 --requirepass 123456 --masterauth 123456 --appendonly yes</span><br><span class="line">    ports:</span><br><span class="line">      - 6376:6379</span><br><span class="line">    volumes:</span><br><span class="line">      - /mydata/redis-cluster/redis-master:/data  </span><br><span class="line">  slave1:</span><br><span class="line">    environment: </span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-slave1</span><br><span class="line">    command: redis-server --slaveof 1.117.34.49 6379 --requirepass 123456 --replica-announce-ip 1.117.34.49 --replica-announce-port 6377 --masterauth 123456 --appendonly yes</span><br><span class="line">    ports:</span><br><span class="line">      - 6377:6379</span><br><span class="line">    volumes:</span><br><span class="line">      - /mydata/redis-cluster/redis-slave1:/data  </span><br><span class="line">  slave2:</span><br><span class="line">    environment: </span><br><span class="line">      - TZ=Asia/Shanghai</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-slave2</span><br><span class="line">    command: redis-server --slaveof 1.117.34.49 6379 --requirepass 123456 --replica-announce-ip 1.117.34.49 --replica-announce-port 6378 --masterauth 123456 --appendonly yes</span><br><span class="line">    ports:</span><br><span class="line">      - 6378:6379</span><br><span class="line">    volumes:</span><br><span class="line">      - /mydata/redis-cluster/redis-salve2:/data  </span><br></pre></td></tr></table></figure>

<h4 id="开启主从关系的两种方式"><a href="#开启主从关系的两种方式" class="headerlink" title="开启主从关系的两种方式"></a>开启主从关系的两种方式</h4><ul>
<li><p>修改配置文件（永久生效）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在配置文件redis.conf中添加配置</span></span><br><span class="line">slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>使用redis-cli客户端，执行slaveof命令（重启失效）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在redis5.0之前的版本执行slaveof命令</span></span><br><span class="line">slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在redis5.0之后的版本执行replicaof命令</span></span><br><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于在docker容器内部进行操作，即使在一台主机上，也不能使用localhost代替masterip</p>
</blockquote>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/1zKRjfayu53QDVH.png" alt="image-20230110121320282"></p>
<blockquote>
<p>进入主节点，查看主从关系</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO REPLICATION</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/01/10/rACHbGqamTYU89k.png" alt="image-20230110123157694"></p>
<blockquote>
<p>在主节点存储数据，在从节点可以查询</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/uwHLjqyR7fSWmTI.png" alt="image-20230110123641859"></p>
<p><img src="https://s2.loli.net/2023/01/10/yz9YN46jVRQHnEg.png" alt="image-20230110123707448"></p>
<h4 id="总计"><a href="#总计" class="headerlink" title="总计"></a>总计</h4><p><img src="https://s2.loli.net/2023/01/10/RPfxXKOY9SyknhU.png" alt="image-20230110104432429"></p>
<h3 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h3><blockquote>
<p>在2.8版本之前只有全量复制，在2.8版本之后有全量复制和增量复制</p>
</blockquote>
<ul>
<li><code>全量（同步）复制</code>：第一次同步</li>
<li><code>增量（同步）复制</code>：会将主从库网络断连期间主库收到的命令，同步给从库</li>
</ul>
<h4 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a><code>全量同步</code></h4><blockquote>
<p>当启动多个Redis实例时，它们之间就可以通过<code>replicaof</code>命令（或者<code>slaveof</code>命令）形成主库和从库的关系，之后会按照三个阶段完成数据的第一次同步</p>
</blockquote>
<p><img src="https://pdai.tech/images/db/redis/db-redis-copy-2.jpg" alt="img"></p>
<blockquote>
<p>第一阶段：主从库建立连接时，从库发送主库一个psync命令请求数据同步，主库根据这个命令的参数启动辅助，psync命令包括对应replid和偏移量offset两个参数，当replid与主库的replid不一致时，主库会使用全量复制并发送FULLRESYNC响应命令并带上两个参数：replid和offset（偏移量用于记录复制进度）</p>
<p>第二阶段：主库执行bgsave命令，依赖内存快照生成RDB文件并将文件发送到从库，从库接收到RDB文件后，会先清空本地当前数据，加载RDB文件。在主库将文件发送往从库的过程，这个过程时比较耗时的且有可能受网络波动的影响，但主库并不会被阻塞，正常接收请求，为了保证数据一致性，主库会将RDB文件生成后的所有写命令记录到内存中专门的repl_baklog中</p>
<p>第三阶段：将第二阶段记录的repl_baklog中的写命令发送给从库，从库接收到的命令并执行，完成同步。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/5JprACMySFftU9d.png"></p>
<h5 id="从节点日志"><a href="#从节点日志" class="headerlink" title="从节点日志"></a><code>从节点日志</code></h5><p><img src="https://s2.loli.net/2023/01/10/JB1uWC2MS8AicN7.png" alt="image-20230110152016410"></p>
<h5 id="主节点日志"><a href="#主节点日志" class="headerlink" title="主节点日志"></a><code>主节点日志</code></h5><p><img src="https://s2.loli.net/2023/01/10/YuMvB4sHoEQFrVp.png" alt="image-20230110152327231"></p>
<h5 id="全量复制总结"><a href="#全量复制总结" class="headerlink" title="全量复制总结"></a>全量复制总结</h5><p><img src="https://s2.loli.net/2023/01/10/uDZJve4NWmIF1zC.png" alt="image-20230110151505640"></p>
<h4 id="增量同步"><a href="#增量同步" class="headerlink" title="增量同步"></a><code>增量同步</code></h4><blockquote>
<p>主从第一次同步是全量同步，如果从节点重启或者网络闪断后，则执行增量同步</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/FEGujqAaepXHTbK.jpg" alt="img"></p>
<blockquote>
<p>repl_baklog是环形缓冲区，存储大小存在上限，在从库重启或者网络闪断太久，从库会丢失掉那部分被新的写命令覆盖掉时，无法进行增量同步，从库和主库之间要进行全量复制。</p>
<p>从库记录着自己的relid，每个从库的复制进度不一定相同，从库重连时，主库会根据从库各自的复制进度决定这个从库是进行增量重复还是全量重复。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/10/c52RLAqBxmZQGKu.png"></p>
<p><img src="https://s2.loli.net/2023/01/10/WAv3UOP86gnaJrG.png" alt="image-20230110172014196"></p>
<h4 id="优化主从复制"><a href="#优化主从复制" class="headerlink" title="优化主从复制"></a>优化主从复制</h4><h5 id="优化全量同步性能："><a href="#优化全量同步性能：" class="headerlink" title="优化全量同步性能："></a><code>优化全量同步性能</code>：</h5><ul>
<li><p>在master配置文件中配置repl-diskless-sync-yes启用无磁盘复制，不生成RDB文件直接发送数据给从节点，避免全量同步时的磁盘IO </p>
</li>
<li><p>减少Redis单节点上的内存占用，减少RDB导致过多的磁盘IO和网络IO</p>
</li>
</ul>
<h5 id="尽量减少全量同步："><a href="#尽量减少全量同步：" class="headerlink" title="尽量减少全量同步："></a><code>尽量减少全量同步</code>：</h5><ul>
<li>适当提高repl_baklog的大小，发现slave宕机或者网络闪断时，尽快实现故障恢复，尽可能避免全量同步</li>
</ul>
<h5 id="降低主节点同步压力"><a href="#降低主节点同步压力" class="headerlink" title="降低主节点同步压力"></a><code>降低主节点同步压力</code></h5><ul>
<li>限制一个主节点上的从节点的数量，可以采用<code>主-从-从</code>的链式结构，减少master压力</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/7ELpu5hyvUDiABN.png" alt="image-20230110174714704"></p>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p><img src="https://s2.loli.net/2023/01/10/54UFzgfMbhIriVu.png" alt="image-20230110174830537"></p>
<h2 id="Redis哨兵"><a href="#Redis哨兵" class="headerlink" title="Redis哨兵"></a>Redis哨兵</h2><blockquote>
<p>slave节点宕机恢复后，可以找到master节点同步数据，但是当master节点发生宕机时，我们需要怎么解决</p>
<p>在Redis主从集群中，哨兵机制是实现主从库自动切换的关键机制，它有效地解决主从复制模式下的故障转移问题</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/18/AwiCPLeYskamW74.png" alt="sentinel"></p>
<h3 id="哨兵机制（Redis-Sentinel）的作用和原理"><a href="#哨兵机制（Redis-Sentinel）的作用和原理" class="headerlink" title="哨兵机制（Redis Sentinel）的作用和原理"></a>哨兵机制（Redis Sentinel）的作用和原理</h3><blockquote>
<p>在Redis2.8版本开始引入Redis Sentinel（Redis哨兵），哨兵的核心功能是实现主从集群的自动故障转移。</p>
</blockquote>
<h4 id="哨兵的作用"><a href="#哨兵的作用" class="headerlink" title="哨兵的作用"></a>哨兵的作用</h4><ul>
<li><code>监控</code>(monitoring)：哨兵不断检查master和slave是否按照预期工作</li>
<li><code>自动故障恢复</code>(automatic failover)：如果master不能正常工作，sentinel会将失效master的一个slave升级为新的master并让其他从节点同步新的master，当故障实例恢复后，以新的master作为主节点</li>
<li><code>配置提供者</code>（configuration provider）：在客户端进行初始化时，通过连接哨兵来获得当前redis集群服务的主节点地址</li>
<li><code>通知</code>（notification）：当集群发生故障转移时，哨兵会将最新的变更信息发送给redis客户端</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/EXiAUq6pVfjkvdO.png" alt="image-20230110235424893"></p>
<h4 id="服务状态监控"><a href="#服务状态监控" class="headerlink" title="服务状态监控"></a>服务状态监控</h4><blockquote>
<p>Sentinel基于心跳机制监测服务状态，每隔1秒向集群的每个实例发送ping命令</p>
</blockquote>
<ul>
<li><code>主观下线</code>：如果某sentinel节点发现实例未在规定时间内响应，则认为该实例主观下线</li>
<li><code>客观下线</code>：若超过指定数量（quorum：一般为sentinel实例数量的一半）的sentinel认为该实例主观下线，则该实例为客观下线</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/LMBbWzFNqAV9Eid.png" alt="img"></p>
<p><img src="https://s2.loli.net/2023/01/11/CTaXt3MeLJ4DO86.png" alt="image-20230111093909624"></p>
<h4 id="哨兵集群的选举"><a href="#哨兵集群的选举" class="headerlink" title="哨兵集群的选举"></a>哨兵集群的选举</h4><blockquote>
<p>为了安全性，一般哨兵会搭建分布式集群，作为分布式集群，必然涉及共识问题（即选举问题）</p>
<p>哨兵的选举机制一般是一个简单的<code>Raft算法</code>：选举的票数大于等于num(sentinel)/2+1时，该选举者将成为新的主节点</p>
</blockquote>
<h4 id="新主库的选出"><a href="#新主库的选出" class="headerlink" title="新主库的选出"></a>新主库的选出</h4><blockquote>
<p>master被判定客观下线，sentinel要从剩余的从库中选择一个新的master</p>
</blockquote>
<ul>
<li>过滤掉不健康的（下线或断线），没有响应哨兵ping的slave</li>
<li>过滤掉与master断开时间长短的slave，如果超过指定值（down-after-milliseconds*10），则会直接被排除</li>
<li>选择slave节点中salve-priority值最小的即优先级最高的（在配置文件redis.conf中配置）</li>
<li>选择复制偏移量最大即offset值最大的，越大说明数据越新，复制最完整的从节点</li>
<li>选择slave节点的运行id较小的</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/11/UCfjvlErT2Xi5eg.jpg" alt="img"></p>
<h4 id="故障的转移"><a href="#故障的转移" class="headerlink" title="故障的转移"></a>故障的转移</h4><ul>
<li>sentinel给选举出的slave节点发送<code>replicaof on one</code>命令，让其脱离从节点，升级为主节点</li>
<li>将其他从节点发送slaveof命令，指向新的主节点，从新的master同步数据</li>
<li>通知应用程序客户端RedisClient主节点的变更信息即新的主节点的地址</li>
<li>修改原主节点即故障节点的配置文件，将其标记为slave，当故障节点恢复后会自动变成新主节点的从节点</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/11/ceygupXdiRS1KvA.png" alt="img"></p>
<h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h4><p><img src="https://s2.loli.net/2023/01/11/j7OHkP8ZvyfdAwl.png" alt="image-20230111103827196"></p>
<h3 id="搭建哨兵集群"><a href="#搭建哨兵集群" class="headerlink" title="搭建哨兵集群"></a>搭建哨兵集群</h3><p><img src="https://s2.loli.net/2023/01/11/5l3JuFkQ7RvZdjN.png" alt="image-20230111103943735"></p>
<h4 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">port</span> <span class="string">&lt;port&gt;</span>	<span class="comment"># 哨兵实例运行端口</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">announce-ip</span> <span class="string">&lt;ip&gt;</span>	<span class="comment"># 哨兵指定ip地址 </span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">monitor</span> <span class="string">&lt;master_name&gt;</span> <span class="string">&lt;master_ip&gt;</span> <span class="string">&lt;master_port&gt;</span> <span class="string">&lt;quonum&gt;</span> <span class="comment"># 哨兵指定主节点自定义名称、ip、端口以及用于选举的quonum</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">down-after-milliseconds</span> <span class="string">&lt;master_name&gt;</span> <span class="number">5000</span> <span class="comment"># 主观判定不可达时间</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">failover-timeout</span> <span class="string">&lt;master_name&gt;</span> <span class="number">5000</span> <span class="comment"># 故障转移超时时间</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">auth-pass</span> <span class="string">&lt;master_name&gt;</span> <span class="string">&lt;master_password&gt;</span> <span class="comment"># 设置master与slave验证密码</span></span><br><span class="line"><span class="string">dir</span> <span class="string">/tmp</span> <span class="comment"># 工作目录</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/01/11/SgwAqWyi6fN7D8o.png" alt="image-20230111110631501"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">port</span> <span class="number">27001</span></span><br><span class="line"><span class="string">protected-mode</span> <span class="literal">no</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">monitor</span> <span class="string">mymaster</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">6376 </span><span class="number">2</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">down-after-milliseconds</span> <span class="string">mymaster</span> <span class="number">5000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">parallel-syncs</span> <span class="string">mymaster</span> <span class="number">1</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">failover-timeout</span> <span class="string">mymaster</span> <span class="number">18000</span></span><br><span class="line"><span class="string">sentinel</span> <span class="string">auth-pass</span> <span class="string">mymaster</span> <span class="number">123456</span></span><br><span class="line"><span class="string">dir</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>

<h4 id="编写Docker-compose-yml配置文件"><a href="#编写Docker-compose-yml配置文件" class="headerlink" title="编写Docker-compose.yml配置文件"></a>编写Docker-compose.yml配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">sentinel1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sentinel1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">27001</span><span class="string">:27001</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/usr/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/sentinel/conf/sentinel1/:/usr/local/etc/redis/</span></span><br><span class="line">  <span class="attr">sentinel2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sentinel2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">27002</span><span class="string">:27002</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/usr/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/sentinel/conf/sentinel2/:/usr/local/etc/redis/</span></span><br><span class="line">  <span class="attr">sentinel3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sentinel3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">27003</span><span class="string">:27003</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-sentinel</span> <span class="string">/usr/local/etc/redis/sentinel.conf</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/sentinel/conf/sentinel3/:/usr/local/etc/redis/</span></span><br></pre></td></tr></table></figure>

<h4 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h4><p><img src="https://s2.loli.net/2023/01/16/NTxzeSFrURqapDM.png" alt="image-20230116014331859"></p>
<h4 id="运行服务"><a href="#运行服务" class="headerlink" title="运行服务"></a>运行服务</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /mydata/sentinel/</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/01/16/znLDU26ph8EXZrY.png"></p>
<p><img src="https://s2.loli.net/2023/01/18/U98BmP4QbYrMFjc.png" alt="image-20230118171244229"></p>
<h4 id="测试故障转移"><a href="#测试故障转移" class="headerlink" title="测试故障转移"></a>测试故障转移</h4><h5 id="关闭主节点"><a href="#关闭主节点" class="headerlink" title="关闭主节点"></a>关闭主节点</h5><p><img src="https://s2.loli.net/2023/01/16/1z3JrFyKgIOpAtm.png" alt="image-20230116231427217"></p>
<h5 id="查看sentinel日志"><a href="#查看sentinel日志" class="headerlink" title="查看sentinel日志"></a>查看sentinel日志</h5><p><img src="https://s2.loli.net/2023/01/16/RCj95xe8zGABnqb.png" alt="image-20230116231417144"></p>
<h5 id="查看转移的主节点"><a href="#查看转移的主节点" class="headerlink" title="查看转移的主节点"></a>查看转移的主节点</h5><p><img src="https://s2.loli.net/2023/01/16/CIVN1vlhLrxWXBo.png" alt="image-20230116231716032"></p>
<h3 id="RedisTemplate哨兵模式"><a href="#RedisTemplate哨兵模式" class="headerlink" title="RedisTemplate哨兵模式"></a>RedisTemplate哨兵模式</h3><blockquote>
<p>Sentinel集群监管下的Redis主从集群中，其主节点会由于自动故障转移而发生变化，Redis客户端必须感知变化并及时更新连接信息。Spring的<code>RedisTemplate</code>底层利用<code>lettuce</code>实现了节点感知和自动切换。</p>
</blockquote>
<h4 id="Spring配置哨兵模式"><a href="#Spring配置哨兵模式" class="headerlink" title="Spring配置哨兵模式"></a>Spring配置哨兵模式</h4><h5 id="引入redis的starter依赖"><a href="#引入redis的starter依赖" class="headerlink" title="引入redis的starter依赖"></a>引入redis的starter依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置文件指定sentinel信息"><a href="#配置文件指定sentinel信息" class="headerlink" title="配置文件指定sentinel信息"></a>配置文件指定sentinel信息</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">level:</span></span><br><span class="line">  <span class="attr">io.lettuce.core:</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">10000ms</span></span><br><span class="line">  <span class="attr">lettuce:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">10</span> <span class="comment"># 连接池最大连接数</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">8</span> <span class="comment"># 连接池最大空闲连接数</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">2</span> <span class="comment"># 连接池最小空闲连接数</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="string">-1ms</span> <span class="comment"># 连接池最大阻塞等待时间，负值表示没有限制</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">master:</span> <span class="string">mymaster</span> <span class="comment"># 指定主节点名称</span></span><br><span class="line">    <span class="attr">nodes:</span> <span class="comment"># 指定redis-sentinel集群信息</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:27001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:27002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:27003</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span> <span class="comment"># Redis服务器连接密码</span></span><br></pre></td></tr></table></figure>

<h5 id="配置主从读写分离"><a href="#配置主从读写分离" class="headerlink" title="配置主从读写分离"></a>配置主从读写分离</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="title function_">lettuceClientConfigurationBuilderCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReadFrom是读取策略：</p>
<ul>
<li><code>MASTER</code>：从主节点读取</li>
<li><code>MASTER_PREFERRED</code>：优先从主节点读取，主机点不可用才读取从节点</li>
<li><code>REPLICA</code>：从从节点读取</li>
<li><code>REPLICA_PREFERRED</code>：优先从从节点读取，所有的从节点不可用才读取主节点</li>
</ul>
<p><img src="https://s2.loli.net/2023/01/17/6Hcq9KVOjbSBuJy.png" alt="image-20230117000659492"></p>
<h2 id="Redis分片集群"><a href="#Redis分片集群" class="headerlink" title="Redis分片集群"></a>Redis分片集群</h2><h3 id="分片集群"><a href="#分片集群" class="headerlink" title="分片集群"></a>分片集群</h3><blockquote>
<p><code>主从集群</code>和<code>哨兵模式</code>解决了高可用，高读并发的问题，但是写能力和存储能力无法进行扩展：    </p>
<ul>
<li>海量数据存储问题</li>
<li>高并发写问题</li>
</ul>
<p>主节点分片集群的可以存储海量数据，同时吸收高写并发能力：</p>
<ul>
<li>集群中有多个主节点，每个主节点存储不同的数据</li>
<li>每个主节点分片可以有多个从节点</li>
<li>主节点之间通过ping监控彼此健康状态，实现故障转移</li>
<li>客户端请求可以访问集群中任意的节点并且被转发到正确的节点上</li>
</ul>
</blockquote>
<p><img src="https://s2.loli.net/2023/01/18/sADR2nWN8bTlUSt.png" alt="image-20230118232513698"></p>
<h4 id="docker-compose部署redis集群"><a href="#docker-compose部署redis集群" class="headerlink" title="docker-compose部署redis集群"></a>docker-compose部署redis集群</h4><h5 id="编写docker-compose文件"><a href="#编写docker-compose文件" class="headerlink" title="编写docker-compose文件"></a>编写docker-compose文件</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master1:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span>  </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master1</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7000</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7000</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17000</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-master1/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7000</span><span class="string">:7000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17000</span><span class="string">:17000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-master2:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span> </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master2</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7001</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7001</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17001</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-master2/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-master3:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master3</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7002</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7002</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17002</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-master3/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span>  </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave1</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7003</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7003</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17003</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-slave1/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span>  </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave2</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7004</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7004</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17004</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-slave2/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7004</span><span class="string">:7004</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-slave3:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span>  </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-slave3</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7005</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7005</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17005</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-slave3/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7005</span><span class="string">:7005</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>--cluster-enabled yes</code>：开启集群</li>
<li><code>--cluster-config-file nodes.conf</code>：集群配置文件</li>
<li><code>cluster-node-timeout 5000</code>：节点心跳失败的超时时间</li>
<li><code>--cluster-announce-ip 1.117.34.49</code>：节点的注册实例ip</li>
<li><code>--cluster-announce-port 7001</code>：节点的注册实例端口<ul>
<li><code>--cluster-announce-bus-port 17001</code>：节点的注册总线端口</li>
</ul>
</li>
<li><code>--appendonly yes</code>：开启 备份 模式</li>
<li><code>--protected-mode no</code>：关闭 保护 模式</li>
</ul>
<h5 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h5 id="建立集群"><a href="#建立集群" class="headerlink" title="建立集群"></a>建立集群</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-master1 redis-cli --cluster create --cluster-replicas 1 1.117.34.49:7000 1.117.34.49:7001 1.117.34.49:7002 1.117.34.49:7003 1.117.34.49:7004 1.117.34.49:700</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/05/MQgWvZIPDiENxyV.png" alt="image-20230605161835616"></p>
<ul>
<li><code>redis-cli --cluster</code>：代表 集群命令操作</li>
<li><code>create</code>：代表 创建集群操作</li>
<li><code>--cluster-replicas 1</code>：代表 指定集群中每个master的副本个数是1，此时节点总数 = 节点总数 / （replicas + 1）即master的数量，其他节点都是slave节点，随机分配到不同的master</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/05/MdJ2tn6mi1sB9vH.png" alt="image-20230605213210215"></p>
<h5 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 7000 cluster nodes</span><br></pre></td></tr></table></figure>

<p><img src="/Users/yuanjianwei/Library/Application%20Support/typora-user-images/image-20230605230352481.png" alt="image-20230605230352481"></p>
<h3 id="散列插槽"><a href="#散列插槽" class="headerlink" title="散列插槽"></a>散列插槽</h3><blockquote>
<p>Redis会将每一个master节点映射到0-16383（共16364个）插槽（hash slot）中</p>
</blockquote>
<h4 id="查看集群信息"><a href="#查看集群信息" class="headerlink" title="查看集群信息"></a>查看集群信息</h4><p><img src="https://s2.loli.net/2023/06/05/X5tbEWnjiOoY1fe.png" alt="image-20230605230511919"></p>
<blockquote>
<p> 数据key不是与节点绑定的绑定的，而是与插槽绑定 </p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/05/T96VaKMEUm7YuRk.png" alt="image-20230605150922830"></p>
<ul>
<li>key中包含”{}”并且”{}”中至少包含一个字符串，则”{}”为有效部分</li>
<li>key中不包含”{}”，整个key都是有效部分</li>
</ul>
<p>例如：当存储的key是 a 时，那么根据 a 计算；如果是{test}a，则根据{a}test计算。计算方式是利用CRC16算法得到一个 Hash 值，然后对于 15495 取余，得到的结果就是 slot 值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-master1 /bin/bash</span><br><span class="line">redis-cli -c -h 1.117.34.49 -p 7000</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/05/iVHG6TNJAd8rWau.png" alt="image-20230605231048064"></p>
<h4 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h4><p><img src="https://s2.loli.net/2023/06/05/eun92Uo34WAamFr.png" alt="image-20230605180107940"></p>
<h5 id="Redis如何判断某个key应该在哪一个实例"><a href="#Redis如何判断某个key应该在哪一个实例" class="headerlink" title="Redis如何判断某个key应该在哪一个实例"></a>Redis如何判断某个key应该在哪一个实例</h5><blockquote>
<p>将16384个插槽分配不同的实例，根据key的有效部分计算出哈希值，将哈希值对16384取余，余数作为插槽，寻找插槽所处实例即可</p>
</blockquote>
<h5 id="如何将-同一类数据-固定的保持在同一个redis实例"><a href="#如何将-同一类数据-固定的保持在同一个redis实例" class="headerlink" title="如何将 同一类数据 固定的保持在同一个redis实例"></a>如何将 同一类数据 固定的保持在同一个redis实例</h5><blockquote>
<p>这一类数据使用相同的有效部分（{}中部分为有效部分，例如这些数据的key都以 {typeId} 为前缀）</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/05/G96khyqPJaKnriM.png" alt="image-20230605232159040"></p>
<h3 id="集群伸缩"><a href="#集群伸缩" class="headerlink" title="集群伸缩"></a>集群伸缩</h3><h4 id="添加一个节点到集群"><a href="#添加一个节点到集群" class="headerlink" title="添加一个节点到集群"></a>添加一个节点到集群</h4><h5 id="操作集群的命令"><a href="#操作集群的命令" class="headerlink" title="操作集群的命令"></a>操作集群的命令</h5><blockquote>
<p>Redis提供了很多 操作集群 的命令</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster help</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/05/iV7t1SzrlIkjUnX.png" alt="image-20230605232421959"></p>
<h5 id="新增节点到集群"><a href="#新增节点到集群" class="headerlink" title="新增节点到集群"></a>新增节点到集群</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-master1:</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span>  </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-master4</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--port</span> <span class="number">7006</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span> <span class="string">--cluster-config-file</span> <span class="string">nodes.conf</span> <span class="string">--cluster-node-timeout</span> <span class="number">5000</span> <span class="string">--cluster-announce-ip</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="string">--cluster-announce-port</span> <span class="number">7006</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17006</span> <span class="string">--appendonly</span> <span class="literal">yes</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/redis-cluster/redis-add/data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7006</span><span class="string">:7006</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17006</span><span class="string">:17006</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-master1 redis-cli --cluster add-node 1.117.34.49:7006 1.117.34.49:7000</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/05/UzT5uCnPqbLd8YV.png" alt="image-20230605233457310"></p>
<h5 id="查看集群状态-1"><a href="#查看集群状态-1" class="headerlink" title="查看集群状态"></a>查看集群状态</h5><blockquote>
<p>发现 新增的节点 没有 插槽</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-master1 redis-cli -p 7000 cluster nodes</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/05/DXKSvMRtmEb8zFg.png" alt="image-20230605233535709"></p>
<h5 id="分配插槽"><a href="#分配插槽" class="headerlink" title="分配插槽"></a>分配插槽</h5><p><img src="https://s2.loli.net/2023/06/05/3nkdiGl79xSvteP.png" alt="image-20230605234011814"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis-cli --cluster reshard --cluster-from 迁出节点ID --cluster-to 接收节点ID --cluster-slots 迁出槽数量 迁出节点ip 端口</span></span><br><span class="line">docker <span class="built_in">exec</span> -it redis-master1 redis-cli --cluster reshard --cluster-from 2728947563b6bbe2905978a00d340fac6961b9d3 --cluster-to 8991b780768b54fd5942006f32c4f562a949d33c --cluster-slots 2765 1.117.34.49 7000</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/05/oRTFdizAVnvGCIE.png" alt="image-20230605234709707"></p>
<h5 id="重新查看节点状态"><a href="#重新查看节点状态" class="headerlink" title="重新查看节点状态"></a>重新查看节点状态</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-master1 redis-cli -p 7000 cluster nodes</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/06/kYM3yTAIuwlEVs6.png" alt="image-20230606000656791"></p>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><h4 id="故障转移-1"><a href="#故障转移-1" class="headerlink" title="故障转移"></a>故障转移</h4><ul>
<li>实例与其他实例失去连接</li>
<li>其他实例心跳机制判断该节点是否宕机</li>
<li>确定节点宕机，自动提升一个从节点成为新的主节点</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/05/LUCB5PFuDWR3Y8y.png" alt="image-20230605235458216"></p>
<h4 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h4><blockquote>
<p>利用 <code>cluster failover</code>命令 手动 让集群中的某个主节点 宕机，切换到执行 cluster failover 命令这个从节点，实现无感知到数据迁移  </p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/uU3G7FPTKpMSjlN.png" alt="image-20230606000044589"></p>
<h5 id="手动Failover支持的三种不同模式"><a href="#手动Failover支持的三种不同模式" class="headerlink" title="手动Failover支持的三种不同模式"></a>手动Failover支持的三种不同模式</h5><ul>
<li>缺省：默认流程</li>
<li>force：省略对于2-3步对于offset的一致性校验</li>
<li>takeover：直接执行第5步，忽略数据一致性，忽略master状态和其他master意见</li>
</ul>
<h3 id="RedisTemplate访问分片分配"><a href="#RedisTemplate访问分片分配" class="headerlink" title="RedisTemplate访问分片分配"></a>RedisTemplate访问分片分配</h3><blockquote>
<p>RedisTemplate底层同样基于 lettuce 实现了 分片集群 的支持</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/Uaf1A9mKoZvxsuy.png" alt="image-20230606000943355"></p>
<ul>
<li><h4 id="引入-redis-的-starter-依赖"><a href="#引入-redis-的-starter-依赖" class="headerlink" title="引入 redis 的 starter 依赖"></a>引入 redis 的 starter 依赖</h4></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="配置分片集群地址"><a href="#配置分片集群地址" class="headerlink" title="配置分片集群地址"></a>配置分片集群地址</h4></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">redis:</span></span><br><span class="line">		<span class="attr">cluster:</span></span><br><span class="line">			<span class="attr">nodes:</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7000</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7001</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7002</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7003</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7004</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7005</span></span><br><span class="line">				<span class="bullet">-</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span> <span class="number">7006</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h4 id="配置读写分离"><a href="#配置读写分离" class="headerlink" title="配置读写分离"></a>配置读写分离</h4></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="title function_">clientConfigurationBuilderCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h2><h3 id="传统缓存问题"><a href="#传统缓存问题" class="headerlink" title="传统缓存问题"></a>传统缓存问题</h3><p><img src="https://s2.loli.net/2023/06/06/DXFVRqmAdPWzIiy.png" alt="image-20230606004054502"></p>
<h3 id="多级缓存方案"><a href="#多级缓存方案" class="headerlink" title="多级缓存方案"></a>多级缓存方案</h3><blockquote>
<p>多级缓存是充分利用请求处理的每一个环节，添加缓存，减轻Tomcat压力，提升服务器性能</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/AkKGhjSyEsJMI7H.png" alt="image-20230606113933783"></p>
<p><img src="https://s2.loli.net/2023/06/06/tMH3lIiuwvPL7J6.png" alt="image-20230606114422392"></p>
<p><img src="https://s2.loli.net/2023/06/06/dg9xDzU6G5JOhcm.png" alt="image-20230606114514952"></p>
<h3 id="Nginx代理"><a href="#Nginx代理" class="headerlink" title="Nginx代理"></a>Nginx代理</h3><p><img src="https://s2.loli.net/2023/06/06/uGtgxakneFjvSpY.png" alt="image-20230606120101026"></p>
<h3 id="JVM进程缓存"><a href="#JVM进程缓存" class="headerlink" title="JVM进程缓存"></a>JVM进程缓存</h3><h4 id="本地进程缓存"><a href="#本地进程缓存" class="headerlink" title="本地进程缓存"></a>本地进程缓存</h4><blockquote>
<p>缓存数据的读取速度非常快，能对大量减少对数据库的访问，减少数据库的压力</p>
</blockquote>
<ul>
<li><h5 id="分布式缓存：例如Redis"><a href="#分布式缓存：例如Redis" class="headerlink" title="分布式缓存：例如Redis"></a>分布式缓存：例如Redis</h5></li>
</ul>
<p>优点：集群部署支持数据共享，分片集群确保存储容量大，哨兵机制保证可靠性</p>
<p>缺点：访问缓存存在网络开销和网络延迟</p>
<p>场景：缓存数据量大、可靠性要求高，数据集群共享</p>
<ul>
<li><h5 id="进程本地缓存：例如HashMap、GuavaCache"><a href="#进程本地缓存：例如HashMap、GuavaCache" class="headerlink" title="进程本地缓存：例如HashMap、GuavaCache"></a>进程本地缓存：例如HashMap、GuavaCache</h5></li>
</ul>
<p>优点：直接读取本地内存，没有网络开销，速度更快</p>
<p>缺点：存储容量有限，可靠性较低，无法共享</p>
<p>场景：性能要求较高，缓存数据量较小</p>
<h4 id="Caffeine"><a href="#Caffeine" class="headerlink" title="Caffeine"></a>Caffeine</h4><blockquote>
<p>Caffine是基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/OT3HzyhNKxWsBQf.png" alt="image-20230606121617734"></p>
<h5 id="Caffine的使用"><a href="#Caffine的使用" class="headerlink" title="Caffine的使用"></a>Caffine的使用</h5><h6 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>caffeine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="Cache手动创建"><a href="#Cache手动创建" class="headerlink" title="Cache手动创建"></a>Cache手动创建</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CACHE = Caffeine.newBuilder()</span><br><span class="line">        <span class="comment">// 初始数量</span></span><br><span class="line">        .initialCapacity(INITIAL_CAPACITY)</span><br><span class="line">        <span class="comment">// 最大数量</span></span><br><span class="line">        .maximumSize(CACHE_SIZE)</span><br><span class="line">        <span class="comment">// 最后一次更新指定过期时间（当expireAfterWrite和expireAfterAccess同时存在，以expireAfterWrite为准）</span></span><br><span class="line">        .expireAfterWrite(EXPIRE_TIME, TimeUnit.SECONDS)</span><br><span class="line">        <span class="comment">// 最后一次读取指定过期时间</span></span><br><span class="line">        .expireAfterAccess(EXPIRE_TIME, TimeUnit.SECONDS)</span><br><span class="line">        <span class="comment">// 监听缓存被异常</span></span><br><span class="line">        .removalListener((key, value, cause) -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;缓存 &#123;&#125; -&gt; &#123;&#125; 已经被移除&quot;</span>, key, value);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 命中统计</span></span><br><span class="line">        .recordStats()</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<p><img src="/Users/yuanjianwei/Library/Application%20Support/typora-user-images/image-20230606141847447.png" alt="image-20230606141847447"></p>
<h5 id="Caffine的三种缓存驱逐策略"><a href="#Caffine的三种缓存驱逐策略" class="headerlink" title="Caffine的三种缓存驱逐策略"></a>Caffine的三种缓存驱逐策略</h5><ul>
<li>基于容量：设置缓存的 数量上限</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CACHE = Caffeine.newBuilder()</span><br><span class="line">        <span class="comment">// 最大数量</span></span><br><span class="line">        .maximumSize(CACHE_SIZE)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<ul>
<li>基于时间：设置缓存的 有效时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CACHE = Caffeine.newBuilder()</span><br><span class="line">  <span class="comment">// 最后一次更新指定过期时间</span></span><br><span class="line">        .expireAfterWrite(EXPIRE_TIME, TimeUnit.SECONDS)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<ul>
<li>基于引用：设置缓存为软引用和弱引用，利用GC回收缓存数据（性能较差，不建议使用）</li>
</ul>
<blockquote>
<p>在默认情况下，当一个缓存元素过期时，Caffine不会自动立即将其清理和驱逐，而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐</p>
</blockquote>
<h3 id="Lua语法"><a href="#Lua语法" class="headerlink" title="Lua语法"></a>Lua语法</h3><h4 id="初始Lua"><a href="#初始Lua" class="headerlink" title="初始Lua"></a>初始Lua</h4><blockquote>
<p>Lua是一种轻量小巧的脚本语言，用标准的C语言编写并以源代码形式开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/dTWRakmfeBqIX1A.png" alt="image-20230606172134668"></p>
<h4 id="变量和循环"><a href="#变量和循环" class="headerlink" title="变量和循环"></a>变量和循环</h4><h5 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h5><p><img src="https://s2.loli.net/2023/06/06/9jtmJPZrDldR36C.png" alt="image-20230606172213633"></p>
<p><img src="https://s2.loli.net/2023/06/06/2S9B8FqIhrVaWmv.png" alt="image-20230606172547233"></p>
<h5 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h5><p><img src="https://s2.loli.net/2023/06/06/f5gEDsNvWGqZiz8.png" alt="image-20230606172707493"></p>
<p><img src="https://s2.loli.net/2023/06/06/ln3USJeYHBpDVsK.png" alt="image-20230606200205411"></p>
<h5 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h5><blockquote>
<p>数组和table都可以使用for循环来遍历</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/b2Pt9qkld5pKCFg.png" alt="image-20230606200459614"></p>
<ul>
<li><h6 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h6></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 声明数组 key为索引的 table</span></span><br><span class="line"><span class="keyword">local</span> arr = &#123;<span class="string">&#x27;java&#x27;</span>, <span class="string">&#x27;pyrhon&#x27;</span>,<span class="string">&#x27;lua&#x27;</span>&#125;</span><br><span class="line"><span class="comment">-- 遍历数组</span></span><br><span class="line"><span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(arr) <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">print</span>(index, value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="遍历table"><a href="#遍历table" class="headerlink" title="遍历table"></a>遍历table</h6></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 声明map即table</span></span><br><span class="line"><span class="keyword">local</span> map = &#123;name = <span class="string">&#x27;jack&#x27;</span>, age = <span class="number">21</span>&#125;</span><br><span class="line"><span class="comment">-- 遍历table</span></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(map) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(key, value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="条件控制和函数"><a href="#条件控制和函数" class="headerlink" title="条件控制和函数"></a>条件控制和函数</h4><h5 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h5><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> 函数名（<span class="title">args1</span>, <span class="title">args2</span>...<span class="title">argsn</span>）</span></span><br><span class="line"><span class="function">		<span class="comment">-- 函数体</span></span></span><br><span class="line"><span class="function">		<span class="title">return</span> 返回值</span></span><br><span class="line"><span class="function"><span class="title">end</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/06/8gk6i3O2xNaVlwp.png" alt="image-20230606201927218"></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> arr = &#123;<span class="string">&#x27;java&#x27;</span>, <span class="string">&#x27;pyrhon&#x27;</span>,<span class="string">&#x27;lua&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printArr</span><span class="params">(arr)</span></span></span><br><span class="line">        <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(arr) <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">print</span>(value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">printArr(arr)</span><br></pre></td></tr></table></figure>

<h5 id="条件控制"><a href="#条件控制" class="headerlink" title="条件控制"></a>条件控制</h5><p><img src="https://s2.loli.net/2023/06/06/mYXTp6tcFSdqMZW.png" alt="image-20230606203011103"></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> （布尔表达式）</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">	<span class="comment">-- &#123; 布尔表达式 true 时执行该语句块 &#125;</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">	<span class="comment">-- &#123; 布尔表达式 false 时执行该语句块 &#125;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printArr</span><span class="params">(arr)</span></span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> arr) <span class="keyword">then</span>			# <span class="literal">nil</span> 表示一个无效值  在 布尔表达式 中默认为 <span class="literal">false</span> </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;数组不能为空！&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">for</span> index, value <span class="keyword">in</span> <span class="built_in">ipairs</span>(arr) <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">print</span>(value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">printArr(<span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<h3 id="多级缓存-1"><a href="#多级缓存-1" class="headerlink" title="多级缓存"></a>多级缓存</h3><h4 id="openResty"><a href="#openResty" class="headerlink" title="openResty"></a>openResty</h4><blockquote>
<p>OpenResty是一个基于Nginx的高性能Web平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：</p>
<ul>
<li>具备具备Nginx的完整功能</li>
<li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li>
<li>允许使用Lua自定义业务逻辑、自定义库</li>
</ul>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/06/gcdoC5kJFfKBhD2.png" alt="image-20230606205946157"></p>
<h4 id="安装openresty"><a href="#安装openresty" class="headerlink" title="安装openresty"></a>安装openresty</h4><h5 id="安装容器"><a href="#安装容器" class="headerlink" title="安装容器"></a>安装容器</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull openresty/openresty</span><br></pre></td></tr></table></figure>

<h5 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name openresty -d -p 90:80 openresty/openresty</span><br></pre></td></tr></table></figure>

<h5 id="挂载目录"><a href="#挂载目录" class="headerlink" title="挂载目录"></a>挂载目录</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mydata/openresty/nginx	</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp openresty:/usr/local/openresty/nginx/  /mydata/openresty/</span><br></pre></td></tr></table></figure>

<h5 id="重新运行容器"><a href="#重新运行容器" class="headerlink" title="重新运行容器"></a>重新运行容器</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f openresty</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --name openrestry -d -p 90:80 \</span><br><span class="line">-v /mydata/openresty/nginx/:/usr/local/openresty/nginx/ \</span><br><span class="line">openresty/openresty</span><br></pre></td></tr></table></figure>

<h4 id="openResty入门"><a href="#openResty入门" class="headerlink" title="openResty入门"></a>openResty入门</h4><p><img src="https://s2.loli.net/2023/06/07/sFf26OWT4KrcoAX.png" alt="image-20230607095543389"></p>
<h5 id="步骤一：修改Nginx-conf文件"><a href="#步骤一：修改Nginx-conf文件" class="headerlink" title="步骤一：修改Nginx.conf文件"></a>步骤一：修改Nginx.conf文件</h5><p><img src="https://s2.loli.net/2023/06/07/5ReVyJOzPgQowGC.png" alt="image-20230607100526394"></p>
<h6 id="在nginx-conf的http中，添加对OpenResty的Lua模块的加载"><a href="#在nginx-conf的http中，添加对OpenResty的Lua模块的加载" class="headerlink" title="在nginx.conf的http中，添加对OpenResty的Lua模块的加载"></a>在nginx.conf的http中，添加对OpenResty的Lua模块的加载</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 加载 lua 模块</span><br><span class="line">lua_package_path &quot;/usr/local/openresty/lualib/?.lua;;&quot;;</span><br><span class="line"># 加载 c 模块</span><br><span class="line">lua_package_cpath &quot;/usr/local/openresty/lualib/?.so;;&quot;;  </span><br></pre></td></tr></table></figure>

<h6 id="在nginx-conf的server下面，添加对-指定路径-的监听"><a href="#在nginx-conf的server下面，添加对-指定路径-的监听" class="headerlink" title="在nginx.conf的server下面，添加对 指定路径 的监听"></a>在nginx.conf的server下面，添加对 指定路径 的监听</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /api/product &#123;</span><br><span class="line">		# 默认的响应类型（返回的json）</span><br><span class="line">		default_type application/json</span><br><span class="line">		# 响应数据由 lua/product.lua 文件来指定</span><br><span class="line">		content_by_lua_file lua/product.lua</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="步骤二：编写lua文件"><a href="#步骤二：编写lua文件" class="headerlink" title="步骤二：编写lua文件"></a>步骤二：编写lua文件</h5><h6 id="在nginx目录创建文件夹lua以及新建lua文件"><a href="#在nginx目录创建文件夹lua以及新建lua文件" class="headerlink" title="在nginx目录创建文件夹lua以及新建lua文件"></a>在nginx目录创建文件夹lua以及新建lua文件</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /mydata/openresty/nginx</span><br><span class="line">mkdir lua</span><br><span class="line">touch lua/product.lua</span><br></pre></td></tr></table></figure>

<h6 id="编辑内容"><a href="#编辑内容" class="headerlink" title="编辑内容"></a>编辑内容</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 返回模拟数据（ngx.say()函数用于写入数据到Response中）</span></span><br><span class="line">ngx.say(<span class="string">&#x27;&#123;&quot;id&quot;:10001,&quot;name&quot;:&quot;SALSA AIR&quot;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="重启加载配置"><a href="#重启加载配置" class="headerlink" title="重启加载配置"></a>重启加载配置</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart openresty</span><br></pre></td></tr></table></figure>

<h4 id="请求参数处理"><a href="#请求参数处理" class="headerlink" title="请求参数处理"></a>请求参数处理</h4><h5 id="获取参数的API"><a href="#获取参数的API" class="headerlink" title="获取参数的API"></a>获取参数的API</h5><blockquote>
<p>OpenResty中提供了一些API用来获取不同类型的前端请求参数</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/07/mdNIWsfl6S1yHCF.png" alt="image-20230607113139500"></p>
<h6 id="路径占位符"><a href="#路径占位符" class="headerlink" title="路径占位符"></a>路径占位符</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/product/<span class="number">1</span></span><br><span class="line"><span class="comment">-- 正则表达式匹配</span></span><br><span class="line">location ~ /product/(\+d) &#123;</span><br><span class="line">  content_by_lua_file lua/product.lua;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">-- 匹配到的参数会存入ngx.var数组中，可以通过 角标 获取</span></span><br><span class="line"><span class="keyword">local</span> id = ngx.var[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h6 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a>请求头</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id:<span class="number">1</span></span><br><span class="line"><span class="comment">-- 获取请求头</span></span><br><span class="line"><span class="keyword">local</span> headers = ngx.req.get_headers()</span><br></pre></td></tr></table></figure>

<h6 id="GET-请求参数"><a href="#GET-请求参数" class="headerlink" title="GET 请求参数"></a>GET 请求参数</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id = <span class="number">1</span></span><br><span class="line"><span class="comment">-- 获取 get 请求参数 返回值是 table 类型</span></span><br><span class="line"><span class="keyword">local</span> param = ngx.req.get_uri_args()</span><br></pre></td></tr></table></figure>

<h6 id="POST-请求参数"><a href="#POST-请求参数" class="headerlink" title="POST 请求参数"></a>POST 请求参数</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id = <span class="number">1</span></span><br><span class="line"><span class="comment">-- 获取请求体</span></span><br><span class="line">ngx.req.read_body()</span><br><span class="line"><span class="comment">-- 获取 post 表单参数 返回值 table 类型</span></span><br><span class="line"><span class="keyword">local</span> body = ngx.req.get_post_args()</span><br></pre></td></tr></table></figure>

<h6 id="JSON-参数"><a href="#JSON-参数" class="headerlink" title="JSON 参数"></a>JSON 参数</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line"><span class="comment">-- 读取请求体</span></span><br><span class="line">ngx.req.read_body()</span><br><span class="line"><span class="comment">-- 获取 body 中的 json 参数 返回值 string 类型</span></span><br></pre></td></tr></table></figure>

<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><h6 id="路径占位符-1"><a href="#路径占位符-1" class="headerlink" title="路径占位符"></a>路径占位符</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># nginx.conf</span><br><span class="line">location ~ /api/product/(\d+) &#123;</span><br><span class="line">		# 默认的响应类型（返回的json）</span><br><span class="line">		default_type application/json</span><br><span class="line">		# 响应数据由 lua/product.lua 文件来指定</span><br><span class="line">		content_by_lua_file lua/product.lua</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="编辑lua文件"><a href="#编辑lua文件" class="headerlink" title="编辑lua文件"></a>编辑lua文件</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- product.lua</span></span><br><span class="line"><span class="keyword">local</span> id = ngx.var[<span class="number">1</span>]</span><br><span class="line">ngx.say(<span class="string">&#x27;&#123;&quot;id&quot;:&#x27;</span>..id ..<span class="string">&#x27;,&quot;name&quot;:&quot;SALSA AIR&quot;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="查询Tomcat"><a href="#查询Tomcat" class="headerlink" title="查询Tomcat"></a>查询Tomcat</h4><p><img src="https://s2.loli.net/2023/06/07/KRqOfIc5wtuEHUY.png" alt="image-20230607151021993"></p>
<p>之前我们通过 nginx 代理转发到 openresty 通过执行 lua 文件，返回模拟数据，在真实的场景中，需要 openresty 请求 tomcat 服务器拿到真实的数据进行返回</p>
<p><img src="https://s2.loli.net/2023/06/07/vKyCfWiSDum5GsH.png" alt="image-20230607110852695"></p>
<h5 id="nginx内部发送http请求"><a href="#nginx内部发送http请求" class="headerlink" title="nginx内部发送http请求"></a>nginx内部发送http请求</h5><blockquote>
<p>nginx提供了内部API用以发送http请求</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- product.lua</span></span><br><span class="line"><span class="keyword">local</span> resp = ngx.location.capture(<span class="string">&quot;/path&quot;</span>, &#123;</span><br><span class="line">		method = ngx.HTTP_GET,		<span class="comment">-- 请求方式</span></span><br><span class="line">    args = &#123;a=<span class="number">1</span>, b=<span class="number">2</span>, ...&#125;,		<span class="comment">-- get 方式传参（param）</span></span><br><span class="line">    body = <span class="string">&quot;c=3&amp;d=4&quot;</span>					<span class="comment">-- post 方式传参（body）</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h6 id="返回的响应内容包括"><a href="#返回的响应内容包括" class="headerlink" title="返回的响应内容包括"></a>返回的响应内容包括</h6><ul>
<li><code>resp.status</code>：响应状态码</li>
<li><code>resp.header</code>：响应头（即table键值对）</li>
<li><code>resp.body</code>：响应体（响应数据）</li>
</ul>
<p>注意：/path 是路径，并不包括 IP 和 端口，这个请求会被nginx内部的server监听并进行反向代理至 tomcat 服务器</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx.conf</span></span><br><span class="line"><span class="comment"># 匹配 正则 获取 路径和路径占位符</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ /path/(\d+)</span> &#123;</span><br><span class="line">  <span class="comment"># 默认响应类型</span></span><br><span class="line">  <span class="attribute">default_type</span> application/json;</span><br><span class="line">  <span class="comment"># 响应结果由lua文件执行</span></span><br><span class="line">  <span class="attribute">content_by_lua_file</span> lua/product.lua</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行lua文件 lua文件需要向tomcat发送请求 请求由本身的nginx监听并反向代理至指定的tomcat服务器</span></span><br><span class="line">location /path &#123;</span><br><span class="line">	  <span class="comment"># 反向代理的路径</span></span><br><span class="line">		<span class="attribute">proxy_pass</span> http://&#123;host&#125;:&#123;port&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="封装HTTP请求查询的函数"><a href="#封装HTTP请求查询的函数" class="headerlink" title="封装HTTP请求查询的函数"></a>封装HTTP请求查询的函数</h5><blockquote>
<p>可以将http查询的请求封装为一个函数，放到OpenResty函数库中，方便后期使用</p>
</blockquote>
<h6 id="在-usr-local-openrrsty-lualib目录下创建get-lua文件"><a href="#在-usr-local-openrrsty-lualib目录下创建get-lua文件" class="headerlink" title="在/usr/local/openrrsty/lualib目录下创建get.lua文件"></a>在/usr/local/openrrsty/lualib目录下创建get.lua文件</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/openrrsty/lualib/common.lua</span><br></pre></td></tr></table></figure>

<h6 id="在get-lua中封装http查询的函数"><a href="#在get-lua中封装http查询的函数" class="headerlink" title="在get.lua中封装http查询的函数"></a>在get.lua中封装http查询的函数</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 封装函数 发送 http 请求 并解析响应</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_http</span><span class="params">(path, params)</span></span> </span><br><span class="line">	<span class="keyword">local</span> resp = ngx.location.capture(<span class="built_in">path</span>, &#123;</span><br><span class="line">      		method = ngx.HTTP_GET,</span><br><span class="line">					args = params</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;http not found, path:&quot;</span>, <span class="built_in">path</span>, <span class="string">&quot;,args:&quot;</span>, args)</span><br><span class="line">    ngx.<span class="built_in">exit</span>(<span class="number">404</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 将 方法 导出</span></span><br><span class="line"><span class="keyword">local</span> _M = &#123;</span><br><span class="line">  read_http = read_http</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _M</span><br></pre></td></tr></table></figure>

<h5 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h5><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 导入get函数库(由于文件就在lualib下，无需加上路径名，直接写文件名即可)</span></span><br><span class="line"><span class="keyword">local</span> get = <span class="built_in">require</span>(<span class="string">&#x27;get&#x27;</span>)</span><br><span class="line"><span class="comment">-- 拿到函数库的方法</span></span><br><span class="line"><span class="keyword">local</span> read_http = get.read_http;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取路径请求参数</span></span><br><span class="line"><span class="keyword">local</span> id = ngx.var[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 调用通用函数</span></span><br><span class="line"><span class="keyword">local</span> resp = read_http(<span class="string">&quot;/product&quot;</span>.. id, <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回参数</span></span><br><span class="line">ngx.say(resp)</span><br></pre></td></tr></table></figure>

<h5 id="JSON结果处理"><a href="#JSON结果处理" class="headerlink" title="JSON结果处理"></a>JSON结果处理</h5><blockquote>
<p>OpenResty提供了一个cjson的模块用来处理JSON序列化和反序列化，可以使用此工具完成数据的组合工作</p>
</blockquote>
<ul>
<li>引入cjson模块</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&quot;cjson&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>序列化</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> obj = &#123;</span><br><span class="line">  name = <span class="string">&#x27;jack&#x27;</span></span><br><span class="line">  age = <span class="number">22</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">local</span> json = cjson.encode(obj)</span><br></pre></td></tr></table></figure>

<ul>
<li>反序列化</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> json = <span class="string">&#x27;&#123;&quot;name&quot;: &quot;jack&quot;, &quot;age&quot;: 21&#125;&#x27;</span></span><br><span class="line"><span class="comment">-- 反序列化</span></span><br><span class="line"><span class="keyword">local</span> obj = cjson.dencode(json);</span><br><span class="line"><span class="built_in">print</span>(obj.name)</span><br></pre></td></tr></table></figure>

<h4 id="Tomcat集群负载均衡"><a href="#Tomcat集群负载均衡" class="headerlink" title="Tomcat集群负载均衡"></a>Tomcat集群负载均衡</h4><h5 id="配置反向代理集群配置"><a href="#配置反向代理集群配置" class="headerlink" title="配置反向代理集群配置"></a>配置反向代理集群配置</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向代理配置 将/item路径的请求代理到tomcat集群</span></span><br><span class="line"><span class="section">location</span> /path &#123;</span><br><span class="line">	  <span class="comment"># 反向代理的路径</span></span><br><span class="line">		<span class="attribute">proxy_pass</span> http://tomcat_cluster</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># tomcat 集群配置（默认采用 轮询 的方式）</span></span><br><span class="line">upstream tomcat_cluster &#123;</span><br><span class="line">  <span class="section">server</span> &#123;host1&#125;:&#123;port1&#125;;</span><br><span class="line">  <span class="section">server</span> &#123;host2&#125;:&#123;port2&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="修改负载均衡策略"><a href="#修改负载均衡策略" class="headerlink" title="修改负载均衡策略"></a>修改负载均衡策略</h5><p>由于 默认 的集群模式反向代理是采用轮询的方式进行访问，这就导致了同样参数的请求会落到不同的服务器，由于进程缓存不同步，导致不同的tomcat进程缓存都需加载</p>
<p>修改负载均衡策略，基于用户请求的uri做简单hash，让同一个请求始终到一台服务器上，让进程缓存只需在一台服务器上加载</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> tomcat_cluster &#123;</span><br><span class="line">  <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">  <span class="section">server</span> &#123;host1&#125;:&#123;port1&#125;;</span><br><span class="line">  <span class="section">server</span> &#123;host2&#125;:&#123;port2&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Redis缓存预热"><a href="#Redis缓存预热" class="headerlink" title="Redis缓存预热"></a>Redis缓存预热</h4><p>在nginx请求tomcat之前，可以再加一层redis缓存，让请求优先查询缓存</p>
<p><img src="https://s2.loli.net/2023/06/07/Q72JutzdDpgbBow.png" alt="image-20230607163849229"></p>
<h5 id="冷启动和缓存预热"><a href="#冷启动和缓存预热" class="headerlink" title="冷启动和缓存预热"></a>冷启动和缓存预热</h5><h6 id="冷启动：服务刚刚启动时，Redis中并没有缓存，如果所有商品都在第一次查询时添加到缓存中，可能会给数据库带来较大的压力"><a href="#冷启动：服务刚刚启动时，Redis中并没有缓存，如果所有商品都在第一次查询时添加到缓存中，可能会给数据库带来较大的压力" class="headerlink" title="冷启动：服务刚刚启动时，Redis中并没有缓存，如果所有商品都在第一次查询时添加到缓存中，可能会给数据库带来较大的压力"></a>冷启动：服务刚刚启动时，Redis中并没有缓存，如果所有商品都在第一次查询时添加到缓存中，可能会给数据库带来较大的压力</h6><h6 id="缓存预热：面对冷启动的问题，我们可以利用大数据统计用户访问的热点数据，在项目启动时，将这些热点数据提前查询并保存到缓存中。或者数据量比较少时，可以在启动时将所有数据放入缓存中"><a href="#缓存预热：面对冷启动的问题，我们可以利用大数据统计用户访问的热点数据，在项目启动时，将这些热点数据提前查询并保存到缓存中。或者数据量比较少时，可以在启动时将所有数据放入缓存中" class="headerlink" title="缓存预热：面对冷启动的问题，我们可以利用大数据统计用户访问的热点数据，在项目启动时，将这些热点数据提前查询并保存到缓存中。或者数据量比较少时，可以在启动时将所有数据放入缓存中"></a>缓存预热：面对冷启动的问题，我们可以利用大数据统计用户访问的热点数据，在项目启动时，将这些热点数据提前查询并保存到缓存中。或者数据量比较少时，可以在启动时将所有数据放入缓存中</h6><h5 id="缓存预热"><a href="#缓存预热" class="headerlink" title="缓存预热"></a>缓存预热</h5><h6 id="编写初始化类"><a href="#编写初始化类" class="headerlink" title="编写初始化类"></a>编写初始化类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheHandler</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该方法会在 CacheHandler 创建并成员变量都完成初始化后执行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="comment">// 初始化缓存 完成预热</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 查询大数据热点数据列表</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 遍历列表将数据存储到redis缓存中</span></span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询Redis缓存"><a href="#查询Redis缓存" class="headerlink" title="查询Redis缓存"></a>查询Redis缓存</h4><blockquote>
<p> OpenResty提供了操作Redis的模块，使用只需要引入该模块就可以直接使用</p>
</blockquote>
<ul>
<li><h5 id="引入Redis模块并初始化Redis对象"><a href="#引入Redis模块并初始化Redis对象" class="headerlink" title="引入Redis模块并初始化Redis对象"></a>引入Redis模块并初始化Redis对象</h5></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 引入 redis 模块</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span>(<span class="string">&quot;resty.redis&quot;</span>)</span><br><span class="line"><span class="comment">-- 初始化 redis 对象</span></span><br><span class="line"><span class="keyword">local</span> red = redis:new()</span><br><span class="line"><span class="comment">-- 设置 redis 超时时间</span></span><br><span class="line">red:set_timeouts(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><h5 id="封装函数（用来释放Redis连接-释放进入连接池）"><a href="#封装函数（用来释放Redis连接-释放进入连接池）" class="headerlink" title="封装函数（用来释放Redis连接-释放进入连接池）"></a>封装函数（用来释放Redis连接-释放进入连接池）</h5></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 关闭 redis 连接的工具方法 其实释放进入连接池</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_redis</span><span class="params">(red)</span></span></span><br><span class="line">  <span class="comment">-- 连接的空闲时间（单位是毫秒）</span></span><br><span class="line">  <span class="keyword">local</span> pool_max_idle_time = <span class="number">10000</span></span><br><span class="line">  <span class="comment">-- 连接池大小</span></span><br><span class="line">  <span class="keyword">local</span> pool_size = <span class="number">100</span></span><br><span class="line">  <span class="keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span> </span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;放入 redis 连接池失败&quot;</span>， err)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h5 id="封装函数（从Redis读取数据并返回）"><a href="#封装函数（从Redis读取数据并返回）" class="headerlink" title="封装函数（从Redis读取数据并返回）"></a>封装函数（从Redis读取数据并返回）</h5></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询 redis 方法  ip和port是redis地址 key是查询的key</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">redis_read</span><span class="params">(ip, port, key)</span></span></span><br><span class="line">  <span class="comment">-- 获取一个连接客户端对象</span></span><br><span class="line">  <span class="keyword">local</span> ok, err = red.connect(ip, port)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span> </span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;连接 redis 失败：&quot;</span>， err)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">-- 使用 redis客户端对象 获取指定的key的 数据</span></span><br><span class="line">  <span class="keyword">local</span> resp, err = red.get(key)</span><br><span class="line">  <span class="comment">-- 查询失败处理</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;连接 redis 失败：&quot;</span>， err, <span class="string">&quot;key =&quot;</span>, key)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">-- 得到的数据为空处理</span></span><br><span class="line">  <span class="keyword">if</span> resp = ngx.null <span class="keyword">then</span></span><br><span class="line">    resp = <span class="literal">nil</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;查询 redis 数据为空：&quot;</span>， err, <span class="string">&quot;key =&quot;</span>, key)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  close_redis(red)</span><br><span class="line">  <span class="keyword">return</span> resp</span><br><span class="line"><span class="keyword">end</span>  </span><br></pre></td></tr></table></figure>

<h5 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h5><blockquote>
<p>将上述操作 Redis 客户端的函数封装到通用函数库里（与之前的流程一样）</p>
</blockquote>
<h6 id="根据具体业务封装函数"><a href="#根据具体业务封装函数" class="headerlink" title="根据具体业务封装函数"></a>根据具体业务封装函数</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 封装 函数，先查询 redis, redis 未命中 再去请求 tomcat 服务器</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">read_data</span><span class="params">(key, path, params)</span></span></span><br><span class="line">  <span class="comment">-- 先查询 redis</span></span><br><span class="line">  <span class="keyword">local</span> resp = redis_read(<span class="string">&quot;127.0.0.0&quot;</span>, <span class="string">&quot;6379&quot;</span>, key)</span><br><span class="line">  <span class="comment">-- 判断 redis 是否命中</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> resp <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- redis 未命中 再去请求 tomcat 服务器</span></span><br><span class="line">    resp = read_http(<span class="built_in">path</span>, params) </span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> resp</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取路径参数</span></span><br><span class="line"><span class="keyword">local</span> id = ngx.var[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用 函数查询信息</span></span><br><span class="line"><span class="keyword">local</span> product = read_data(<span class="string">&quot;pms:product:&quot;</span>..id, <span class="string">&quot;/path/&quot;</span>.. id,  <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回 查询结果</span></span><br><span class="line">ngx.say(product)</span><br></pre></td></tr></table></figure>

<h4 id="Nginx本地缓存"><a href="#Nginx本地缓存" class="headerlink" title="Nginx本地缓存"></a>Nginx本地缓存</h4><p><img src="https://s2.loli.net/2023/06/08/5QNKR2jlMax8ATI.png" alt="image-20230608004036209"></p>
<blockquote>
<p>OpenResty为Nginx提供了<strong>shard dict</strong>的功能，可以为nginx的多个worker进程之间共享数据（内部共享内存），实现缓存功能</p>
</blockquote>
<ul>
<li><h5 id="开启共享字典"><a href="#开启共享字典" class="headerlink" title="开启共享字典"></a>开启共享字典</h5><blockquote>
<p>在 nginx.conf 的 http 下添加配置</p>
</blockquote>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启共享字典 （本地缓存） 名称为：item_cache, 大小150m</span></span><br><span class="line"><span class="attribute">lua_shard_dict</span> item_cache <span class="number">150m</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><h5 id="操作共享字典"><a href="#操作共享字典" class="headerlink" title="操作共享字典"></a>操作共享字典</h5></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取 本地缓存对象</span></span><br><span class="line"><span class="keyword">local</span> item_cache = ngx.shard.item_cache</span><br><span class="line"><span class="comment">-- 存储数据（ 指定key、value、过期时间-单位：秒，默认0代表永不过期）</span></span><br><span class="line">item_cache:set(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;value&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line"><span class="comment">-- 读取数据</span></span><br><span class="line"><span class="keyword">local</span> val = item_cache:get(<span class="string">&#x27;key&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="缓存同步"><a href="#缓存同步" class="headerlink" title="缓存同步"></a>缓存同步</h3><h4 id="缓存同步策略"><a href="#缓存同步策略" class="headerlink" title="缓存同步策略"></a>缓存同步策略</h4><p><img src="https://s2.loli.net/2023/06/08/6HYiEsGdwPDpoU8.png" alt="image-20230608010649362"></p>
<h4 id="基于Canal的异步通知"><a href="#基于Canal的异步通知" class="headerlink" title="基于Canal的异步通知"></a>基于Canal的异步通知</h4><p><img src="https://s2.loli.net/2023/06/08/PUjEItGYnSJbCuK.png" alt="image-20230608010851585"></p>
<h5 id="初始Canal"><a href="#初始Canal" class="headerlink" title="初始Canal"></a>初始Canal</h5><p><img src="https://s2.loli.net/2023/06/08/htoX8Y9lBIOqgZE.png" alt="image-20230608095755843"></p>
<blockquote>
<p>Canal（译为水道/管道/渠道）,Canal是阿里巴巴旗下的一款开源项目，基于Java开发，基于数据库<strong>增量日志分析</strong>，提供<strong>增量数据订阅&amp;消费</strong>。</p>
</blockquote>
<p>Canal是基于 MySQL的主从同步 来实现的，MySQL 主从同步的原理如下：</p>
<ul>
<li>MySQL Master 将数据变更写入到二进制日志（binary log），其中记录的数据为 binary log events</li>
<li>MySQL Slave 将 Master 的 binary log events 拷贝到它的中继日志（relay log）</li>
<li>MySQL Slave 重放 Relay Log 中事件，将数据变更反映到它自己的数据</li>
</ul>
<blockquote>
<p>Canal 就会将自己 <strong>伪装</strong>成 一个 MySQL 的一个<strong>Slave</strong> 节点，从而<strong>监听</strong> Master 的 binary log 的变化，再把得到的变化信息<strong>通知</strong>给 Canal 客户端，进而完成其他数据库的同步</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/08/DJr1dY3sGM6UVCt.png" alt="image-20230608100622549"></p>
<h4 id="安装Canal"><a href="#安装Canal" class="headerlink" title="安装Canal"></a>安装Canal</h4><h5 id="指定binary-log文件和database"><a href="#指定binary-log文件和database" class="headerlink" title="指定binary log文件和database"></a>指定binary log文件和database</h5><h6 id="修改MySQL配置文件"><a href="#修改MySQL配置文件" class="headerlink" title="修改MySQL配置文件"></a>修改MySQL配置文件</h6><blockquote>
<p>MySQL 配置文件挂载在宿主机的 /mydata/mysql/conf 目录中</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /mydata/mysql/conf/my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 设置 binary log 文件的存放地址 /var/lib/mysql/ 和文件名 mysql-bin</span><br><span class="line">log-bin = /var/lib/mysql/mysql-bin</span><br><span class="line"># 指定 database 记录 binary log events</span><br><span class="line">binlog-do-db=mall</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/08/thDwgMzISClN8QG.png" alt="image-20230608230343587"></p>
<h6 id="重启MySQL服务"><a href="#重启MySQL服务" class="headerlink" title="重启MySQL服务"></a>重启MySQL服务</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart mysql</span><br></pre></td></tr></table></figure>

<h6 id="查看-mydata-mysql-data-目录下的-binary-log-日志文件"><a href="#查看-mydata-mysql-data-目录下的-binary-log-日志文件" class="headerlink" title="查看 /mydata/mysql/data/ 目录下的 binary log 日志文件"></a>查看 /mydata/mysql/data/ 目录下的 binary log 日志文件</h6><p><img src="https://s2.loli.net/2023/06/08/ZBwHamxPrG849Kz.png" alt="image-20230608230547120"></p>
<h5 id="设置用户权限"><a href="#设置用户权限" class="headerlink" title="设置用户权限"></a>设置用户权限</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE user canal@&#x27;%&#x27; IDENTIFIED BY &#x27;canal&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT, SUPER ON *.* TO &#x27;canal&#x27;@&#x27;%&#x27; WITH GRANT OPTION</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/08/BPT8qDs2mcHxnOZ.png" alt="image-20230608232108177"></p>
<h5 id="创建网络并将MySQL容器加入网络"><a href="#创建网络并将MySQL容器加入网络" class="headerlink" title="创建网络并将MySQL容器加入网络"></a>创建网络并将MySQL容器加入网络</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create canal_default</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/09/oGlBivdCV8U6H9y.png" alt="image-20230609125417874"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect canal_default mysql</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/09/LD2rptyMefiU4Ev.png" alt="image-20230609125504137"></p>
<h5 id="创建Canal容器"><a href="#创建Canal容器" class="headerlink" title="创建Canal容器"></a>创建Canal容器</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull canal/canal-server</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 启动 容器 ｜ 查看配置文件路径 ｜ 拷贝 | 重新启动容器</span><br><span class="line">docker run --name canal -d canal/canal-server</span><br><span class="line"></span><br><span class="line">docker exec -it canal bash</span><br><span class="line">cd /home/admin/canal-server/conf/</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">mkdir -p /mydata/canal/conf/</span><br><span class="line">docker cp canal:/home/admin/canal-server/conf/ /mydata/canal/</span><br><span class="line"></span><br><span class="line">docker rm -f canal</span><br><span class="line">docker run --name canal --network canal_default -p 11111:11111 -d	\</span><br><span class="line">-v /mydata/canal/conf:/home/admin/canal-server/conf \</span><br><span class="line">-v /mydata/canal/log:/home/admin/canal-server/logs \</span><br><span class="line">canal/canal-server</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/09/GiU3nmOSXvflVBD.png" alt="image-20230609130240354"></p>
<p><img src="https://s2.loli.net/2023/06/09/6LGZ7ShqyuKNa9c.png" alt="image-20230609132641562"></p>
<h6 id="修改配置文件-instance-properties"><a href="#修改配置文件-instance-properties" class="headerlink" title="修改配置文件 instance.properties"></a>修改配置文件 instance.properties</h6><p><img src="https://s2.loli.net/2023/06/09/9od6KeVOsxhQaNr.png" alt="image-20230609132211508"></p>
<h5 id="重新启动并查看日志"><a href="#重新启动并查看日志" class="headerlink" title="重新启动并查看日志"></a>重新启动并查看日志</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker restart canal</span><br><span class="line">tail -f n500 /mydata/canal/log/example/example/log</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/09/gHCJ65T2soqv9uy.png" alt="image-20230609134449190"></p>
<h4 id="监听Canal"><a href="#监听Canal" class="headerlink" title="监听Canal"></a>监听Canal</h4><h5 id="Canal客户端"><a href="#Canal客户端" class="headerlink" title="Canal客户端"></a>Canal客户端</h5><blockquote>
<p>Canal提供了各种语言的客户端，当Canal监听到 binlog 变化时，会通知 canal 客户端</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/09/7O8FGZfMkuIQrWP.png" alt="image-20230609134850285"></p>
<blockquote>
<p>Canal 提供了各种语言的客户端，当 Canal 监听到 binlog 变化时，会通知 Canel 的客户端</p>
</blockquote>
<h5 id="编写Canal客户端"><a href="#编写Canal客户端" class="headerlink" title="编写Canal客户端"></a>编写Canal客户端</h5><blockquote>
<p>这里使用 第三方开源的canal-starter</p>
</blockquote>
<h6 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Canal --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.javatool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>canal-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1-RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a>编写配置文件</h6><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">canal:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">example</span> <span class="comment"># canal 示例名称</span></span><br><span class="line">  <span class="attr">server:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:11111</span> <span class="comment"># canal 地址</span></span><br></pre></td></tr></table></figure>

<h6 id="编写监听器"><a href="#编写监听器" class="headerlink" title="编写监听器"></a>编写监听器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanalTable(value = &quot;pms_product_category&quot;)</span> <span class="comment">// 指定监听的表名</span></span><br><span class="line"><span class="meta">@Component</span>  <span class="comment">//</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCategoryHandler</span> <span class="keyword">implements</span> <span class="title class_">EntryHandler</span>&lt;PmsProductCategory&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听新增数据并执行相应逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pmsProductCategory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(PmsProductCategory pmsProductCategory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听更新数据并执行相应逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> before</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> after</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(PmsProductCategory before, PmsProductCategory after)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听删除数据并执行相应逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pmsProductCategory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(PmsProductCategory pmsProductCategory)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Canal 推送给 canal客户端 的是 被修改的这一行数据（row），而我们引入的canal客户端需要我们把数据封建到实体类中，这个过程需要知道数据库与实体类的映射关系，需要用的JPA的几个注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="meta">@Id</span> <span class="comment">// 主键</span></span><br><span class="line"><span class="meta">@Column</span> <span class="comment">// 列</span></span><br><span class="line"><span class="meta">@Transient</span> <span class="comment">// 无需映射</span></span><br></pre></td></tr></table></figure>

<h4 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h4><p><img src="https://s2.loli.net/2023/06/09/JGg71ovZjHaMbXx.png" alt="image-20230609151614437"></p>
<h2 id="Redis最佳实践"><a href="#Redis最佳实践" class="headerlink" title="Redis最佳实践"></a>Redis最佳实践</h2><h3 id="Redis键值设计"><a href="#Redis键值设计" class="headerlink" title="Redis键值设计"></a>Redis键值设计</h3><h4 id="Key结构"><a href="#Key结构" class="headerlink" title="Key结构"></a>Key结构</h4><p><img src="https://s2.loli.net/2023/06/09/xQlf5LI1Pt48bes.png" alt="image-20230609152806473"></p>
<p>Redis的Key可以自定义，但是最好尊循下面几个最佳实践的约定：</p>
<ul>
<li>遵循基本格式：[业务名称]:[数据名]:[id]</li>
<li>长度不超过44字节</li>
<li>不包括特殊字符</li>
</ul>
<p>优点：1、可读性强，易于管理、避免冲突；2、节省内存空间：key是string类型，底层编码包括int、embstr和raw三种（embstr在小于44个字节使用，采用连续内存空间，内存占用更小）</p>
<h4 id="拒绝BigKey"><a href="#拒绝BigKey" class="headerlink" title="拒绝BigKey"></a>拒绝BigKey</h4><p><img src="https://s2.loli.net/2023/06/09/yWvjcN8sBV2dAS5.png" alt="image-20230609154724693"></p>
<blockquote>
<p>BigKey 通常以 <strong>Key的大小</strong> 和 <strong>Key中成员的数量</strong> 来综合判定</p>
</blockquote>
<ul>
<li>Key 本身的数据量过大</li>
<li>Key 中成员数量过多</li>
<li>Key 中成员的数据量过大</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MEMORY USAGE</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/09/lBdWCUc7ILa86Fz.png" alt="image-20230609154432582"></p>
<h5 id="推荐值"><a href="#推荐值" class="headerlink" title="推荐值"></a>推荐值</h5><ul>
<li>单个Key的Value小于10KB</li>
<li>对于集合类型的Key，建议元素数量小于1000</li>
</ul>
<h4 id="Bigkey的危害"><a href="#Bigkey的危害" class="headerlink" title="Bigkey的危害"></a>Bigkey的危害</h4><ul>
<li>网络阻塞：对Bigkey执行读请求时，少量的QPS就可能会导致带宽使用率被占满 </li>
<li>数据倾斜：BigKey所在的Redis实例内存使用率远超其他实例，无使数据分片的内存资源达到均衡</li>
<li>Redis阻塞：对于元素较多的hash、list、zset等做运算耗时较久，使得主线程（Redis是单线程）被阻塞</li>
<li>CPU压力：对BigKey的数据序列化和反序列化会导致CPU的使用率飙升</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/10/IOmMJ9rxuyQwpzA.png" alt="image-20230610141352716"></p>
<h4 id="发现BigKey"><a href="#发现BigKey" class="headerlink" title="发现BigKey"></a>发现BigKey</h4><p><img src="https://s2.loli.net/2023/06/14/HThCAacXtk7f4KO.png" alt="image-20230614150332437"></p>
<ul>
<li><h5 id="redis-cli-bigkeys"><a href="#redis-cli-bigkeys" class="headerlink" title="redis-cli --bigkeys"></a><code>redis-cli --bigkeys</code></h5></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -a 密码	 --bigkeys</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/14/IUG9rY51gtvEV67.png" alt="image-20230614150807161"></p>
<ul>
<li><h5 id="Scan-扫描"><a href="#Scan-扫描" class="headerlink" title="Scan 扫描"></a>Scan 扫描</h5><blockquote>
<p>利用 <code>Scan</code> 批量扫描 Redis 中的所有Key， 再利用 strlen， hlen等命令判断 key 的长度</p>
</blockquote>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/14/Odjws5qynrp6iMl.png" alt="image-20230614151001448"></p>
<p><img src="https://s2.loli.net/2023/06/14/EkBDKRvJU7pMXbh.png" alt="image-20230614151149174"></p>
<ul>
<li><h5 id="第三方工具"><a href="#第三方工具" class="headerlink" title="第三方工具"></a>第三方工具</h5></li>
</ul>
<p>利用第三方工具，如 <code>Redis-Rdb-Tools</code> 分析 RDB 快照文件，全面分析内存使用情况</p>
<ul>
<li><h5 id="网络监控"><a href="#网络监控" class="headerlink" title="网络监控"></a>网络监控</h5></li>
</ul>
<p>自定义监控，监控进出Redis的网络数据，超出预警值主动告警</p>
<h4 id="删除BigKey"><a href="#删除BigKey" class="headerlink" title="删除BigKey"></a>删除BigKey</h4><blockquote>
<p>BigKey 内存占用较多，即便删除也需要消耗很长的时间，导致Redis主进程阻塞，引发一系列的问题</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/nQYvkiDceKE2jTW.png" alt="image-20230614153328669"></p>
<ul>
<li>Redis 3.0 及以下版本</li>
</ul>
<blockquote>
<p>如果是集合类型，则遍历BigKey元素，先逐个删除单个元素，最后删除BigKey</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/LUriP3bE9A6FjSp.png" alt="image-20230614153649056"></p>
<blockquote>
<p>Redis在 4.0 后提供了 异步删除的命令-<code>unlink</code></p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/XAVegqsj6xzBZ2R.png" alt="image-20230614153605063"></p>
<h4 id="恰当的数据类型"><a href="#恰当的数据类型" class="headerlink" title="恰当的数据类型"></a>恰当的数据类型</h4><h5 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h5><blockquote>
<p>推荐使用 <code>hash</code> 结构</p>
</blockquote>
<h6 id="json字符串：优点-实现简单粗暴-缺点-数据耦合没有灵活性"><a href="#json字符串：优点-实现简单粗暴-缺点-数据耦合没有灵活性" class="headerlink" title="json字符串：优点-实现简单粗暴 缺点-数据耦合没有灵活性"></a>json字符串：优点-实现简单粗暴 缺点-数据耦合没有灵活性</h6><h6 id="字段分散：灵活访问对象任意字段-缺点-占用空间大，无法同一控制"><a href="#字段分散：灵活访问对象任意字段-缺点-占用空间大，无法同一控制" class="headerlink" title="字段分散：灵活访问对象任意字段 缺点-占用空间大，无法同一控制"></a>字段分散：灵活访问对象任意字段 缺点-占用空间大，无法同一控制</h6><h6 id="Hash：底层使用ziplist，空间占用小，灵活访问对象的任意字段-缺点-代码相对复杂"><a href="#Hash：底层使用ziplist，空间占用小，灵活访问对象的任意字段-缺点-代码相对复杂" class="headerlink" title="Hash：底层使用ziplist，空间占用小，灵活访问对象的任意字段 缺点-代码相对复杂"></a>Hash：底层使用ziplist，空间占用小，灵活访问对象的任意字段 缺点-代码相对复杂</h6><p><img src="https://s2.loli.net/2023/06/14/ZmpnSYx6Nsu4wbi.png" alt="image-20230614154848514"></p>
<h5 id="大键值对"><a href="#大键值对" class="headerlink" title="大键值对"></a>大键值对</h5><h6 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h6><ul>
<li>Hash 的 <code>entry</code> 数量超过 <code>512</code> 时，会使用 <code>哈希表</code> 而不是 <code>ZipList</code>，内存占用较多</li>
<li>通过 <code>hash-max-ziplist-entries</code> 配置 <code>entry 上限</code>，但是 如果 entry 过多会导致 Bigkey 问题</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/14/SZQubi6xYXMErKo.png" alt="image-20230614155227280"></p>
<p><img src="https://s2.loli.net/2023/06/14/a8LArODk1t7QdBF.png" alt="image-20230614155327132"></p>
<p>如果拆分为String类型，由于string结构底层没有太多的内存优化，存在很多元数据等要存，内存占用较多，其次当业务上想要批量当获取这些数据时比较麻烦</p>
<p><img src="https://s2.loli.net/2023/06/14/BGEFDYXkoNduat6.png" alt="image-20230614155500829"></p>
<h6 id="划分Hash"><a href="#划分Hash" class="headerlink" title="划分Hash"></a>划分Hash</h6><blockquote>
<p>拆分为小的Hash，将id/100作为key，将id%100作为field，每100个元素作为一个Hash</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/3Z7y82tIcxsT5r9.png" alt="image-20230614155543651"></p>
<p><img src="https://s2.loli.net/2023/06/14/79mNp4cVXsdyOZA.png" alt="image-20230614155733292"></p>
<h4 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h4><p><img src="https://s2.loli.net/2023/06/14/N7CyfrzImkj3oGM.png" alt="image-20230614160008531"></p>
<h5 id="Key"><a href="#Key" class="headerlink" title="Key"></a>Key</h5><ul>
<li>固定格式：**[业务名]:[数据名]:[id]**</li>
<li>足够简短：<strong>不超过44字节</strong></li>
<li><strong>不包括特殊字符</strong></li>
</ul>
<h5 id="Value"><a href="#Value" class="headerlink" title="Value"></a>Value</h5><ul>
<li>合理的拆分数据，<strong>拒绝BigKey</strong></li>
<li>选择<strong>合适的数据结构</strong></li>
<li>Hash结构的<strong>entry数量</strong>不要超过1000</li>
<li>设置合理的<strong>超时时间</strong></li>
</ul>
<h3 id="批处理优化"><a href="#批处理优化" class="headerlink" title="批处理优化"></a>批处理优化</h3><h4 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h4><h5 id="单个命令的执行流程"><a href="#单个命令的执行流程" class="headerlink" title="单个命令的执行流程"></a>单个命令的执行流程</h5><p><img src="https://s2.loli.net/2023/06/14/GZQ6cMF9vqUn1kp.png" alt="image-20230614164041486"></p>
<h5 id="N个命令的执行流程"><a href="#N个命令的执行流程" class="headerlink" title="N个命令的执行流程"></a>N个命令的执行流程</h5><p><img src="https://s2.loli.net/2023/06/14/8HiaYydlKhS5cog.png" alt="image-20230614164244348"></p>
<h5 id="N个命令批量执行"><a href="#N个命令批量执行" class="headerlink" title="N个命令批量执行"></a>N个命令批量执行</h5><p><img src="https://s2.loli.net/2023/06/14/AKuyzPvWQHdro6V.png" alt="image-20230614164318494"></p>
<h5 id="MSET"><a href="#MSET" class="headerlink" title="MSET"></a>MSET</h5><blockquote>
<p>不要在一次批处理中传输大多的命令，否则单次命令占用带宽过多，会导致网络阻塞</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/1Ek5DCxV4dUqRB9.png" alt="image-20230614164627706"></p>
<p><img src="https://s2.loli.net/2023/06/14/HZaQvTUb2DCcx7i.png" alt="image-20230614164548509"></p>
<p><img src="https://s2.loli.net/2023/06/14/OyVIUx8hScflFLj.png" alt="image-20230614165510774"></p>
<h5 id="Pipeline-1"><a href="#Pipeline-1" class="headerlink" title="Pipeline"></a>Pipeline</h5><blockquote>
<p>MSET 虽然可以进行批处理，但是只能操作部分数据类型，因此如果有对复杂的数据类型的批处理需求时，建议使用Pipeline功能</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/OuQbFeq6Yf5wDdv.png" alt="image-20230614165944139"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testPipeline</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 创建管道</span></span><br><span class="line">  <span class="type">Pipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> jedis.pipelined();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i&lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 将命令放入管道中</span></span><br><span class="line">    pipeline.set(<span class="string">&quot;test:key:&quot;</span>+i, i);</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">1000</span>) &#123;</span><br><span class="line">      pipeline.sync();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 批量添加并设置失效时间</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">setBypipeline</span><span class="params">(Map&lt;String, Object&gt; map, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.executePipelined(<span class="keyword">new</span> <span class="title class_">SessionCallback</span>&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> &lt;K, V&gt; Object <span class="title function_">execute</span><span class="params">(RedisOperations&lt;K, V&gt; operations)</span> <span class="keyword">throws</span> DataAccessException &#123;</span><br><span class="line">            <span class="comment">// 开启事务</span></span><br><span class="line">            operations.multi();</span><br><span class="line">            ValueOperations&lt;String, Object&gt; kvValueOperations = (ValueOperations&lt;String, Object&gt;) operations.opsForValue();</span><br><span class="line">            map.entrySet()</span><br><span class="line">                    .forEach(stringObjectEntry -&gt; kvValueOperations.set(</span><br><span class="line">                            stringObjectEntry.getKey(),</span><br><span class="line">                            stringObjectEntry.getValue(),</span><br><span class="line">                            time,</span><br><span class="line">                            TimeUnit.SECONDS</span><br><span class="line">                    ));</span><br><span class="line">            <span class="keyword">return</span> operations.exec();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 批量添加</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">redisTemplate.opsForValue().multiSet(map);</span><br></pre></td></tr></table></figure>

<h5 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h5><p>批处理方案：1、原生的m操作 2、Pipeline批量操作（推荐）</p>
<p>注意事项：1、批处理不建议一次携带太多命令 2、Pipeline的多个命令之间不具备原子性</p>
<h4 id="集群下的批处理"><a href="#集群下的批处理" class="headerlink" title="集群下的批处理"></a>集群下的批处理</h4><blockquote>
<p>如果<code>MSET</code>或者``Pipeline<code>在一次请求中携带了多条命令，而此时如果</code>Redis`是一个集群，那么批量的命令多个Key计算出来的hash值必须落到一个插槽中，否则会导致执行失败（No way to dispatch this command to Redis Cluster because keys have different slots）</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/KVgnJmTXBWuvcoQ.png" alt="image-20230614174309626"></p>
<p><code>串行slot</code> 和 <code>并行slot</code> 的区别在于是否开启多个线程异步的执行各组命令，<code>hash_tag</code>虽然耗时非常短，但是容易出现数据倾斜</p>
<p><code>redisTemplate.opsForValue().multiSet(Map&lt;? extends K, ? extends V&gt; map)</code> 底层就是 <code>并行slot</code> 在客户端计算每个 <code>key</code> 的 <code>slot</code>，将 slot 一致分为一组，每组都利用 <code>Pipeline</code> 批处理，<strong>异步并行</strong>执行各组命令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量设置</span></span><br><span class="line">redisTemplate.opsForValue().multiSet(map);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/14/JUWXjVYkpfoPz5h.png" alt="image-20230614201259765"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量查询</span></span><br><span class="line">redisTemplate.opsForValue().multiGet(Arrays.asList());</span><br><span class="line"><span class="comment">// 批量</span></span><br><span class="line">redisTemplate.delete(Arrays.asList());</span><br></pre></td></tr></table></figure>

<h3 id="服务端优化"><a href="#服务端优化" class="headerlink" title="服务端优化"></a>服务端优化</h3><h4 id="持久化配置"><a href="#持久化配置" class="headerlink" title="持久化配置"></a>持久化配置</h4><p><img src="https://s2.loli.net/2023/06/14/U2jhY4Qy7Cfeglo.png" alt="image-20230614234223416"></p>
<blockquote>
<p>Redis 持久化可以保证数据安全，但是会带来额外的开销，因此持久化要遵循下列建议</p>
</blockquote>
<ul>
<li><p>用来作为<strong>缓存业务</strong>的Redis实例尽量<strong>不要开启</strong>持久化功能，对于<strong>安全性</strong>要求比较高的业务可以<strong>开启持久化</strong></p>
</li>
<li><p>建议关闭RDB持久化功能，使用<strong>AOF</strong>持久化</p>
</li>
<li><p>利用<strong>脚本定期</strong>在<strong>Slave节点</strong>做RDB，实现数据备份</p>
</li>
<li><p>在使用AOF持久化时，设置合理的<strong>rewrite阈值</strong>，<strong>避免频繁的bgrewrite</strong></p>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/14/wdhJuD91QWOgzfI.png" alt="image-20230614232448489"></p>
<ul>
<li>配置 <code>no-appendfsync-on-rewrite=yes</code>，<strong>禁止rewrite期间</strong>进行<strong>AOF</strong>，避免因AOF带来巨大的磁盘IO，引起的主线程阻塞</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/14/plM3AIXrPz9C4s8.png" alt="image-20230614233818024"></p>
<h5 id="部署建议"><a href="#部署建议" class="headerlink" title="部署建议"></a>部署建议</h5><ul>
<li>Redis实例的物理机要预留足够的内存，以应对fork和rewrite</li>
<li>单个Redis实例内存上限不要过高（4/8G），可以加快fork速度，减少主从同步，数据迁移的压力</li>
<li>不要与CPU密集型应用部署在一起</li>
<li>不要与高硬盘负载应用一起部署，例如数据库，消息队列</li>
</ul>
<h4 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h4><blockquote>
<p>慢查询：在Redis执行时<strong>耗时超过某个阈值</strong>的命令，称为慢查询</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/06/14/7qoDlJmWdMrcH39.png" alt="image-20230614234931532"></p>
<p>由于Redis是单线程执行命令即主线程执行命令，Redis有一个队列让命令请求进行排队依次执行，当一个查询命令执行时间过长时，会导致其他后面的请求命令等待超时</p>
<p>慢查询的阈值可以通过配资指定</p>
<ul>
<li><code>slowlog-log-slower-than</code>：<strong>慢查询阈值</strong>，单位微秒，默认是10000(10ms)，建议1000(1ms)</li>
</ul>
<p>慢查询会被存放在<strong>慢查询日志</strong>中，日志的长度存在上限，可以通过配置指定</p>
<p><img src="https://s2.loli.net/2023/06/15/oWD9Bra3UGlMcq4.png" alt="image-20230615000248437"></p>
<ul>
<li><code>slowlog-max-len</code>：慢查询日志（本质是一个队列）的长度，默认128，建议1000</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/WtrypqxbRaXlshw.png" alt="image-20230615000119711"></p>
<p>查看慢查询日志列表</p>
<ul>
<li><code>slowlog len</code>：查询<strong>慢查询日志长度</strong></li>
<li><code>slowly get [n]</code>：<strong>读取n条</strong>慢查询日志</li>
<li><code>slow reset</code>：<strong>清空</strong>慢查询列表</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/DK8Z1ObfAq4um7L.png" alt="image-20230615000749772"></p>
<p><img src="/Users/yuanjianwei/Library/Application%20Support/typora-user-images/image-20230615000440826.png" alt="image-20230615000440826"></p>
<h4 id="命令和安全配置"><a href="#命令和安全配置" class="headerlink" title="命令和安全配置"></a>命令和安全配置</h4><blockquote>
<p>Redis 默认会绑定在 <code>0.0.0.0:6379</code>，这会将Redis服务暴露到公网上，如果Redis没有做身份认证，会出现严重的安全漏洞</p>
</blockquote>
<p>漏洞出现核心原因：</p>
<ul>
<li>Redis <code>未设置密码</code>（默认的 redis服务 没有密码）</li>
<li>利用 Redis 的 <code>config set 命令动态修改</code> Redis 配置</li>
<li>使用了 <code>Root 账号权限</code>启动 Redis</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/t7aNzeEWMfJlhRT.png" alt="image-20230615102015014"></p>
<p><img src="https://s2.loli.net/2023/06/15/bYNMyns671fWPI5.png" alt="image-20230615103250818"></p>
<p>为了避免这样的漏洞：</p>
<ul>
<li>Redis 一定要 <code>设置密码</code></li>
<li>禁止线上使用如下命令：<code>keys</code>、<code>flushall</code>、<code>flushed</code>、<code>config set</code>等命令，可以利用 <code>rename-command</code>禁用</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rename-command CONFIG CONFIGURATION  <span class="comment"># 此时 CONFIG 被修改为 CONFIGURATION</span></span><br><span class="line">rename-command KEYS <span class="string">&#x27;&#x27;</span> <span class="comment"># 此时 KEYS 无效</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/15/EeVbNCj9GYmLsSA.png" alt="image-20230615102157383"></p>
<p><img src="https://s2.loli.net/2023/06/15/Te6whc3ORQ4JVIo.png" alt="image-20230615102234229"></p>
<ul>
<li>配置 <code>bind</code> 限制网卡，禁止外网网卡访问</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 0.0.0.0  <span class="comment"># 默认是 开放 0.0.0.0</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/15/wB4eWvuhEmUrgyC.png" alt="image-20230615103329093"></p>
<ul>
<li>开启<code>防火墙</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> firewalld</span><br></pre></td></tr></table></figure>

<ul>
<li><code>不用使用root 账户</code> 启动 Redis，防止 root 权限修改本地目录和文件</li>
<li>尽量<code>不要使用默认端口</code></li>
</ul>
<h4 id="内存配置"><a href="#内存配置" class="headerlink" title="内存配置"></a>内存配置</h4><blockquote>
<p>当Redis内存不足时，可能会导致 key 频繁被删除，响应时间变长，QPS不稳定等问题，当内存使用率达到90%以上时需要警惕并快速定位到内存占用的原因</p>
</blockquote>
<h5 id="Redis-内存分配"><a href="#Redis-内存分配" class="headerlink" title="Redis 内存分配"></a>Redis 内存分配</h5><ul>
<li><p><strong>数据内存</strong>：Redis<strong>最主要的部分</strong>，存储Redis<strong>键值</strong>信息，主要信息是<code>BigKey</code>问题以及<code>内存碎片</code>问题</p>
</li>
<li><p><strong>进程内存</strong>：Redis主进程本身<strong>运行占用内存</strong>，如代码、常量池等等，这部分内存占用一般几兆，在大多数生产环境中，它与Redis数据占用内存相比<strong>可以忽略不计</strong> </p>
</li>
<li><p><strong>缓存区内存</strong>：一般包括客户端缓冲区、AOF缓冲区、复制缓冲区等。客户端缓冲区包括<strong>输入缓冲区</strong>和<strong>输出缓冲区</strong>两种，这部分内存占用<strong>波动较大</strong>，如果不当使用BigKey，可能会导致<strong>内存溢出</strong></p>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/YzC6QVp1OaJDgUL.png" alt="image-20230615104551494"></p>
<h5 id="查看内存分配命令"><a href="#查看内存分配命令" class="headerlink" title="查看内存分配命令"></a>查看内存分配命令</h5><blockquote>
<p>Redis 提供了一些命令，可以查看Redis目前的内存分配状态</p>
</blockquote>
<ul>
<li>INFO MEMORY</li>
<li>MEMORY STATS</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/MNzlvqC8GdD1rIk.png" alt="image-20230615110759069"></p>
<p><img src="https://s2.loli.net/2023/06/15/GKkhlDOaNLpiBte.png" alt="image-20230615105348749"></p>
<p><img src="https://s2.loli.net/2023/06/15/gdUNknosau1BDw7.png" alt="image-20230615105541610"></p>
<p><img src="https://s2.loli.net/2023/06/15/WAaxVDRgqLJfeCz.png" alt="image-20230615105318565"></p>
<h5 id="内存缓冲区配置"><a href="#内存缓冲区配置" class="headerlink" title="内存缓冲区配置"></a>内存缓冲区配置</h5><p>内存缓冲区的常见三种：</p>
<ul>
<li><p><strong>复制缓冲区</strong>：主从复制用于增加同步的<code>repl_backlog_buf</code>，如果该缓冲区的大小设置的大小，会增量的数据缓冲区无法全部保存，从而导致频繁的全量同步，影响性能：可以通过 <code>repl-backlog-size</code> 来设置，默认是1mb</p>
</li>
<li><p><strong>AOF缓冲区</strong>：AOF 刷新磁盘之前的缓存区域，AOF 执行 rewrite 的缓冲区，无法设置容量的上限</p>
</li>
<li><p><strong>客户端缓冲区</strong>：分为输入缓存区和输出缓冲区，输入缓冲区最大1G且不能设置，输出缓冲区可以设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client-output-buffer-limit &lt;class&gt; &lt;hard <span class="built_in">limit</span>&gt; &lt;soft <span class="built_in">limit</span>&gt; &lt;soft seconds&gt;</span><br><span class="line"><span class="comment"># &lt;class&gt; 客户端类型：normal:普通客户端 replica:主从辅助客户端 pubsub:PubSub客户端</span></span><br><span class="line"><span class="comment"># &lt;hard limit&gt;：缓冲区上限在超过 limit 后断开</span></span><br><span class="line"><span class="comment"># &lt;soft limit&gt; &lt;soft seconds&gt; 缓冲区上限，在超过soft limit并且持续soft seconds秒后断开客户端</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/Oj4CM9zyNkcm2KI.png" alt="image-20230615111746298"></p>
<p>也可以通过命令查看内存缓冲区大小和每个客户端的缓冲区占用情况</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看客户端的输入缓冲区和输出缓冲区</span></span><br><span class="line">INFO clients</span><br><span class="line"><span class="comment"># 查看每个客户端的缓冲区占用情况</span></span><br><span class="line">clients list</span><br></pre></td></tr></table></figure>

<p><img src="/Users/yuanjianwei/Library/Application%20Support/typora-user-images/image-20230615111943651.png" alt="image-20230615111943651"></p>
<p><img src="/Users/yuanjianwei/Library/Application%20Support/typora-user-images/image-20230615112023461.png" alt="image-20230615112023461"></p>
<h3 id="集群最佳实践"><a href="#集群最佳实践" class="headerlink" title="集群最佳实践"></a>集群最佳实践</h3><p><img src="https://s2.loli.net/2023/06/15/Vj1trNu5EPTKI9h.png" alt="image-20230615125121828"></p>
<ul>
<li><h4 id="集群完整性问题"><a href="#集群完整性问题" class="headerlink" title="集群完整性问题"></a>集群完整性问题</h4></li>
</ul>
<p>在Redis的默认配置中， 如果发现任意一个插槽不可用，则整个集群都会停止对外服务</p>
<p>可以通过修改 <code>cluster-require-full-coverage false</code> 让部分插槽不可用时，其他插槽依旧对外正常服务，来保证汲取高可用的特性</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require-full-coverage <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/06/15/Diuw3Ny4fMGOr8n.png" alt="image-20230615125210887"></p>
<ul>
<li><h4 id="集群带宽问题"><a href="#集群带宽问题" class="headerlink" title="集群带宽问题"></a>集群带宽问题</h4></li>
</ul>
<p>集群节点之间会不断的互相 <code>ping</code> 来确定集群中其他节点的状态，每次 <code>ping</code> 携带的信息至少包括：<code>插槽信息</code>和<code>集群状态信息</code>。这就导致集群中节点越多，集群的状态信息数量也就越大，10个节点的相关信息可能就到达了1kb，此时每次集群的互通所需的带宽就会非常高</p>
<h4 id="解决途径"><a href="#解决途径" class="headerlink" title="解决途径"></a>解决途径</h4><ul>
<li>避免大集群，集群节点数据不要过多，最好少于1000，如果业务比较大，则可以建立多个集群</li>
<li>避免在单个物理机上运行太多的Redis实例，因为单个物理机的带宽是有限的</li>
<li>配置合适的 <code>cluster-node-timeout</code> 值，不要让 <code>ping</code> 的频率过高，也不能让频率过慢，否则会导致可用性降低</li>
</ul>
<p><img src="https://s2.loli.net/2023/06/15/ckrG1zU6lwahmYi.png" alt="image-20230615132552248"></p>
<p>注意：单体Redis（主从Redis已经可以达到万级别的QPS，并且由于哨兵机制，它也具备很强的高可用特性，如果主从能够满足业务需求的情况下，尽量不要搭建Redis集群）</p>
<p><img src="https://s2.loli.net/2023/06/15/Ryeh5kMqxzvDTwW.png" alt="image-20230615133113121"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">YuanJW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/01/07/Redis%E9%AB%98%E7%BA%A7/">http://example.com/2023/01/07/Redis%E9%AB%98%E7%BA%A7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post_share"><div class="social-share" data-image="/img/default-cover/10.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/08/Docker%E5%B8%B8%E8%A7%81%E9%83%A8%E7%BD%B2%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="/img/default-cover/21.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Docker在Linux环境下常见部署</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/01/Redis%E5%AE%9E%E6%88%98/"><img class="next-cover" src="/img/default-cover/6.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Redis实战</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/12/01/Redis%E5%AE%9E%E6%88%98/" title="Redis实战"><img class="cover" src="/img/default-cover/6.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-01</div><div class="title">Redis实战</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YuanJW</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/XiaoYuanJW" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/2754742370@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">Redis分布式缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E9%9B%86%E7%BE%A4"><span class="toc-number">1.1.</span> <span class="toc-text">Redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9Redis%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.1.</span> <span class="toc-text">单节点Redis问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">Redis持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDB%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.1.</span> <span class="toc-text">RDB持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RDB%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">RDB文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E9%85%8D%E7%BD%AERDB"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">Redis配置RDB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%9A%84Fork%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">Redis的Fork原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.1.3.1.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RDB%E7%9A%84bgsave%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.1.3.2.</span> <span class="toc-text">RDB的bgsave的基本流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RDB%E4%BC%9A%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%EF%BC%8Csave%E5%91%BD%E4%BB%A4%E7%9A%84%E5%90%AB%E4%B9%89"><span class="toc-number">1.2.1.3.3.</span> <span class="toc-text">RDB会执行时间，save命令的含义</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RDB%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.2.1.3.4.</span> <span class="toc-text">RDB的缺点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.2.</span> <span class="toc-text">AOF持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E5%AE%9A%E4%B9%89"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">AOF定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF%E5%BC%80%E5%90%AF%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">AOF开启配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E4%B8%BB%E4%BB%8E"><span class="toc-number">1.3.</span> <span class="toc-text">Redis主从</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">搭建主从架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAredis%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">搭建redis从节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E4%B8%BB%E4%BB%8E%E5%85%B3%E7%B3%BB%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">开启主从关系的两种方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E8%AE%A1"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">总计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.2.</span> <span class="toc-text">主从复制原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">全量同步</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E6%97%A5%E5%BF%97"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">从节点日志</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E6%97%A5%E5%BF%97"><span class="toc-number">1.3.2.1.2.</span> <span class="toc-text">主节点日志</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.2.1.3.</span> <span class="toc-text">全量复制总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">增量同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">优化主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5%E6%80%A7%E8%83%BD%EF%BC%9A"><span class="toc-number">1.3.2.3.1.</span> <span class="toc-text">优化全量同步性能：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%BD%E9%87%8F%E5%87%8F%E5%B0%91%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5%EF%BC%9A"><span class="toc-number">1.3.2.3.2.</span> <span class="toc-text">尽量减少全量同步：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%8D%E4%BD%8E%E4%B8%BB%E8%8A%82%E7%82%B9%E5%90%8C%E6%AD%A5%E5%8E%8B%E5%8A%9B"><span class="toc-number">1.3.2.3.3.</span> <span class="toc-text">降低主节点同步压力</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%93%A8%E5%85%B5"><span class="toc-number">1.4.</span> <span class="toc-text">Redis哨兵</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6%EF%BC%88Redis-Sentinel%EF%BC%89%E7%9A%84%E4%BD%9C%E7%94%A8%E5%92%8C%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.1.</span> <span class="toc-text">哨兵机制（Redis Sentinel）的作用和原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">哨兵的作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">服务状态监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4%E7%9A%84%E9%80%89%E4%B8%BE"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">哨兵集群的选举</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E4%B8%BB%E5%BA%93%E7%9A%84%E9%80%89%E5%87%BA"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">新主库的选出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E7%9A%84%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.4.1.5.</span> <span class="toc-text">故障的转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">1.4.1.6.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4"><span class="toc-number">1.4.2.</span> <span class="toc-text">搭建哨兵集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">创建配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99Docker-compose-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">编写Docker-compose.yml配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">文件结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">运行服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">测试故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.4.2.5.1.</span> <span class="toc-text">关闭主节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bsentinel%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.2.5.2.</span> <span class="toc-text">查看sentinel日志</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BD%AC%E7%A7%BB%E7%9A%84%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">1.4.2.5.3.</span> <span class="toc-text">查看转移的主节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedisTemplate%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.3.</span> <span class="toc-text">RedisTemplate哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring%E9%85%8D%E7%BD%AE%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">Spring配置哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5redis%E7%9A%84starter%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.3.1.1.</span> <span class="toc-text">引入redis的starter依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8C%87%E5%AE%9Asentinel%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.3.1.2.</span> <span class="toc-text">配置文件指定sentinel信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.4.3.1.3.</span> <span class="toc-text">配置主从读写分离</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.</span> <span class="toc-text">Redis分片集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.1.</span> <span class="toc-text">分片集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#docker-compose%E9%83%A8%E7%BD%B2redis%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">docker-compose部署redis集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99docker-compose%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.1.1.1.</span> <span class="toc-text">编写docker-compose文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.1.1.2.</span> <span class="toc-text">启动集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.1.1.3.</span> <span class="toc-text">建立集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">1.5.1.1.4.</span> <span class="toc-text">查看集群状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%A3%E5%88%97%E6%8F%92%E6%A7%BD"><span class="toc-number">1.5.2.</span> <span class="toc-text">散列插槽</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E4%BF%A1%E6%81%AF"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">查看集群信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Redis%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E6%9F%90%E4%B8%AAkey%E5%BA%94%E8%AF%A5%E5%9C%A8%E5%93%AA%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.2.2.1.</span> <span class="toc-text">Redis如何判断某个key应该在哪一个实例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86-%E5%90%8C%E4%B8%80%E7%B1%BB%E6%95%B0%E6%8D%AE-%E5%9B%BA%E5%AE%9A%E7%9A%84%E4%BF%9D%E6%8C%81%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AAredis%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.2.2.2.</span> <span class="toc-text">如何将 同一类数据 固定的保持在同一个redis实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.5.3.</span> <span class="toc-text">集群伸缩</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">添加一个节点到集群</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E9%9B%86%E7%BE%A4%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.5.3.1.1.</span> <span class="toc-text">操作集群的命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="toc-number">1.5.3.1.2.</span> <span class="toc-text">新增节点到集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81-1"><span class="toc-number">1.5.3.1.3.</span> <span class="toc-text">查看集群状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E6%8F%92%E6%A7%BD"><span class="toc-number">1.5.3.1.4.</span> <span class="toc-text">分配插槽</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81"><span class="toc-number">1.5.3.1.5.</span> <span class="toc-text">重新查看节点状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.5.4.</span> <span class="toc-text">故障转移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB-1"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">故障转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">数据迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8Failover%E6%94%AF%E6%8C%81%E7%9A%84%E4%B8%89%E7%A7%8D%E4%B8%8D%E5%90%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.4.2.1.</span> <span class="toc-text">手动Failover支持的三种不同模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedisTemplate%E8%AE%BF%E9%97%AE%E5%88%86%E7%89%87%E5%88%86%E9%85%8D"><span class="toc-number">1.5.5.</span> <span class="toc-text">RedisTemplate访问分片分配</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5-redis-%E7%9A%84-starter-%E4%BE%9D%E8%B5%96"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">引入 redis 的 starter 依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E5%9C%B0%E5%9D%80"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">配置分片集群地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">配置读写分离</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.</span> <span class="toc-text">多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.1.</span> <span class="toc-text">传统缓存问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98%E6%96%B9%E6%A1%88"><span class="toc-number">1.6.2.</span> <span class="toc-text">多级缓存方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E4%BB%A3%E7%90%86"><span class="toc-number">1.6.3.</span> <span class="toc-text">Nginx代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM%E8%BF%9B%E7%A8%8B%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.4.</span> <span class="toc-text">JVM进程缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">本地进程缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%EF%BC%9A%E4%BE%8B%E5%A6%82Redis"><span class="toc-number">1.6.4.1.1.</span> <span class="toc-text">分布式缓存：例如Redis</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%EF%BC%9A%E4%BE%8B%E5%A6%82HashMap%E3%80%81GuavaCache"><span class="toc-number">1.6.4.1.2.</span> <span class="toc-text">进程本地缓存：例如HashMap、GuavaCache</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Caffeine"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">Caffeine</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Caffine%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.6.4.2.1.</span> <span class="toc-text">Caffine的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">1.6.4.2.1.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Cache%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA"><span class="toc-number">1.6.4.2.1.2.</span> <span class="toc-text">Cache手动创建</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Caffine%E7%9A%84%E4%B8%89%E7%A7%8D%E7%BC%93%E5%AD%98%E9%A9%B1%E9%80%90%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.4.2.2.</span> <span class="toc-text">Caffine的三种缓存驱逐策略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E8%AF%AD%E6%B3%95"><span class="toc-number">1.6.5.</span> <span class="toc-text">Lua语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8BLua"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">初始Lua</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%92%8C%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">变量和循环</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.5.2.1.</span> <span class="toc-text">数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">1.6.5.2.2.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.6.5.2.3.</span> <span class="toc-text">循环</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84"><span class="toc-number">1.6.5.2.3.1.</span> <span class="toc-text">遍历数组</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%81%8D%E5%8E%86table"><span class="toc-number">1.6.5.2.3.2.</span> <span class="toc-text">遍历table</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%8E%A7%E5%88%B6%E5%92%8C%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">条件控制和函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.5.3.1.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">1.6.5.3.2.</span> <span class="toc-text">条件控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98-1"><span class="toc-number">1.6.6.</span> <span class="toc-text">多级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#openResty"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">openResty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85openresty"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">安装openresty</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%AE%B9%E5%99%A8"><span class="toc-number">1.6.6.2.1.</span> <span class="toc-text">安装容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">1.6.6.2.2.</span> <span class="toc-text">运行容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95"><span class="toc-number">1.6.6.2.3.</span> <span class="toc-text">挂载目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8"><span class="toc-number">1.6.6.2.4.</span> <span class="toc-text">重新运行容器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#openResty%E5%85%A5%E9%97%A8"><span class="toc-number">1.6.6.3.</span> <span class="toc-text">openResty入门</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80%EF%BC%9A%E4%BF%AE%E6%94%B9Nginx-conf%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.3.1.</span> <span class="toc-text">步骤一：修改Nginx.conf文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%A8nginx-conf%E7%9A%84http%E4%B8%AD%EF%BC%8C%E6%B7%BB%E5%8A%A0%E5%AF%B9OpenResty%E7%9A%84Lua%E6%A8%A1%E5%9D%97%E7%9A%84%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.6.6.3.1.1.</span> <span class="toc-text">在nginx.conf的http中，添加对OpenResty的Lua模块的加载</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%A8nginx-conf%E7%9A%84server%E4%B8%8B%E9%9D%A2%EF%BC%8C%E6%B7%BB%E5%8A%A0%E5%AF%B9-%E6%8C%87%E5%AE%9A%E8%B7%AF%E5%BE%84-%E7%9A%84%E7%9B%91%E5%90%AC"><span class="toc-number">1.6.6.3.1.2.</span> <span class="toc-text">在nginx.conf的server下面，添加对 指定路径 的监听</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C%EF%BC%9A%E7%BC%96%E5%86%99lua%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.3.2.</span> <span class="toc-text">步骤二：编写lua文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%A8nginx%E7%9B%AE%E5%BD%95%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9lua%E4%BB%A5%E5%8F%8A%E6%96%B0%E5%BB%BAlua%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.3.2.1.</span> <span class="toc-text">在nginx目录创建文件夹lua以及新建lua文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E5%86%85%E5%AE%B9"><span class="toc-number">1.6.6.3.2.2.</span> <span class="toc-text">编辑内容</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E5%90%AF%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.6.3.3.</span> <span class="toc-text">重启加载配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E5%A4%84%E7%90%86"><span class="toc-number">1.6.6.4.</span> <span class="toc-text">请求参数处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E7%9A%84API"><span class="toc-number">1.6.6.4.1.</span> <span class="toc-text">获取参数的API</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E5%8D%A0%E4%BD%8D%E7%AC%A6"><span class="toc-number">1.6.6.4.1.1.</span> <span class="toc-text">路径占位符</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">1.6.6.4.1.2.</span> <span class="toc-text">请求头</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#GET-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.6.4.1.3.</span> <span class="toc-text">GET 请求参数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#POST-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.6.4.1.4.</span> <span class="toc-text">POST 请求参数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#JSON-%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.6.4.1.5.</span> <span class="toc-text">JSON 参数</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.6.4.2.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E5%8D%A0%E4%BD%8D%E7%AC%A6-1"><span class="toc-number">1.6.6.4.2.1.</span> <span class="toc-text">路径占位符</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E8%BE%91lua%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.4.2.2.</span> <span class="toc-text">编辑lua文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2Tomcat"><span class="toc-number">1.6.6.5.</span> <span class="toc-text">查询Tomcat</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx%E5%86%85%E9%83%A8%E5%8F%91%E9%80%81http%E8%AF%B7%E6%B1%82"><span class="toc-number">1.6.6.5.1.</span> <span class="toc-text">nginx内部发送http请求</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%9A%84%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9%E5%8C%85%E6%8B%AC"><span class="toc-number">1.6.6.5.1.1.</span> <span class="toc-text">返回的响应内容包括</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85HTTP%E8%AF%B7%E6%B1%82%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.6.5.2.</span> <span class="toc-text">封装HTTP请求查询的函数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%A8-usr-local-openrrsty-lualib%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%88%9B%E5%BB%BAget-lua%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.6.5.2.1.</span> <span class="toc-text">在&#x2F;usr&#x2F;local&#x2F;openrrsty&#x2F;lualib目录下创建get.lua文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%A8get-lua%E4%B8%AD%E5%B0%81%E8%A3%85http%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.6.5.2.2.</span> <span class="toc-text">在get.lua中封装http查询的函数</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">1.6.6.5.3.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JSON%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-number">1.6.6.5.4.</span> <span class="toc-text">JSON结果处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.6.6.6.</span> <span class="toc-text">Tomcat集群负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.6.6.1.</span> <span class="toc-text">配置反向代理集群配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.6.6.2.</span> <span class="toc-text">修改负载均衡策略</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-number">1.6.6.7.</span> <span class="toc-text">Redis缓存预热</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%B7%E5%90%AF%E5%8A%A8%E5%92%8C%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-number">1.6.6.7.1.</span> <span class="toc-text">冷启动和缓存预热</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%86%B7%E5%90%AF%E5%8A%A8%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%88%9A%E5%88%9A%E5%90%AF%E5%8A%A8%E6%97%B6%EF%BC%8CRedis%E4%B8%AD%E5%B9%B6%E6%B2%A1%E6%9C%89%E7%BC%93%E5%AD%98%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%89%80%E6%9C%89%E5%95%86%E5%93%81%E9%83%BD%E5%9C%A8%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%9F%A5%E8%AF%A2%E6%97%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%BC%93%E5%AD%98%E4%B8%AD%EF%BC%8C%E5%8F%AF%E8%83%BD%E4%BC%9A%E7%BB%99%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B8%A6%E6%9D%A5%E8%BE%83%E5%A4%A7%E7%9A%84%E5%8E%8B%E5%8A%9B"><span class="toc-number">1.6.6.7.1.1.</span> <span class="toc-text">冷启动：服务刚刚启动时，Redis中并没有缓存，如果所有商品都在第一次查询时添加到缓存中，可能会给数据库带来较大的压力</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD%EF%BC%9A%E9%9D%A2%E5%AF%B9%E5%86%B7%E5%90%AF%E5%8A%A8%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E7%9A%84%E7%83%AD%E7%82%B9%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%9C%A8%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E6%97%B6%EF%BC%8C%E5%B0%86%E8%BF%99%E4%BA%9B%E7%83%AD%E7%82%B9%E6%95%B0%E6%8D%AE%E6%8F%90%E5%89%8D%E6%9F%A5%E8%AF%A2%E5%B9%B6%E4%BF%9D%E5%AD%98%E5%88%B0%E7%BC%93%E5%AD%98%E4%B8%AD%E3%80%82%E6%88%96%E8%80%85%E6%95%B0%E6%8D%AE%E9%87%8F%E6%AF%94%E8%BE%83%E5%B0%91%E6%97%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E5%90%AF%E5%8A%A8%E6%97%B6%E5%B0%86%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E6%94%BE%E5%85%A5%E7%BC%93%E5%AD%98%E4%B8%AD"><span class="toc-number">1.6.6.7.1.2.</span> <span class="toc-text">缓存预热：面对冷启动的问题，我们可以利用大数据统计用户访问的热点数据，在项目启动时，将这些热点数据提前查询并保存到缓存中。或者数据量比较少时，可以在启动时将所有数据放入缓存中</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD"><span class="toc-number">1.6.6.7.2.</span> <span class="toc-text">缓存预热</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%88%9D%E5%A7%8B%E5%8C%96%E7%B1%BB"><span class="toc-number">1.6.6.7.2.1.</span> <span class="toc-text">编写初始化类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2Redis%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.6.8.</span> <span class="toc-text">查询Redis缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5Redis%E6%A8%A1%E5%9D%97%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96Redis%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.6.6.8.1.</span> <span class="toc-text">引入Redis模块并初始化Redis对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%87%BD%E6%95%B0%EF%BC%88%E7%94%A8%E6%9D%A5%E9%87%8A%E6%94%BERedis%E8%BF%9E%E6%8E%A5-%E9%87%8A%E6%94%BE%E8%BF%9B%E5%85%A5%E8%BF%9E%E6%8E%A5%E6%B1%A0%EF%BC%89"><span class="toc-number">1.6.6.8.2.</span> <span class="toc-text">封装函数（用来释放Redis连接-释放进入连接池）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%87%BD%E6%95%B0%EF%BC%88%E4%BB%8ERedis%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%B9%B6%E8%BF%94%E5%9B%9E%EF%BC%89"><span class="toc-number">1.6.6.8.3.</span> <span class="toc-text">封装函数（从Redis读取数据并返回）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">1.6.6.8.4.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E5%B0%81%E8%A3%85%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.6.8.4.1.</span> <span class="toc-text">根据具体业务封装函数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.6.8.4.2.</span> <span class="toc-text">调用函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98"><span class="toc-number">1.6.6.9.</span> <span class="toc-text">Nginx本地缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E5%85%B1%E4%BA%AB%E5%AD%97%E5%85%B8"><span class="toc-number">1.6.6.9.1.</span> <span class="toc-text">开启共享字典</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E5%85%B1%E4%BA%AB%E5%AD%97%E5%85%B8"><span class="toc-number">1.6.6.9.2.</span> <span class="toc-text">操作共享字典</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%90%8C%E6%AD%A5"><span class="toc-number">1.6.7.</span> <span class="toc-text">缓存同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%90%8C%E6%AD%A5%E7%AD%96%E7%95%A5"><span class="toc-number">1.6.7.1.</span> <span class="toc-text">缓存同步策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ECanal%E7%9A%84%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5"><span class="toc-number">1.6.7.2.</span> <span class="toc-text">基于Canal的异步通知</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8BCanal"><span class="toc-number">1.6.7.2.1.</span> <span class="toc-text">初始Canal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Canal"><span class="toc-number">1.6.7.3.</span> <span class="toc-text">安装Canal</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%87%E5%AE%9Abinary-log%E6%96%87%E4%BB%B6%E5%92%8Cdatabase"><span class="toc-number">1.6.7.3.1.</span> <span class="toc-text">指定binary log文件和database</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9MySQL%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.7.3.1.1.</span> <span class="toc-text">修改MySQL配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E5%90%AFMySQL%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.7.3.1.2.</span> <span class="toc-text">重启MySQL服务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-mydata-mysql-data-%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84-binary-log-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.7.3.1.3.</span> <span class="toc-text">查看 &#x2F;mydata&#x2F;mysql&#x2F;data&#x2F; 目录下的 binary log 日志文件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-number">1.6.7.3.2.</span> <span class="toc-text">设置用户权限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E5%B9%B6%E5%B0%86MySQL%E5%AE%B9%E5%99%A8%E5%8A%A0%E5%85%A5%E7%BD%91%E7%BB%9C"><span class="toc-number">1.6.7.3.3.</span> <span class="toc-text">创建网络并将MySQL容器加入网络</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BACanal%E5%AE%B9%E5%99%A8"><span class="toc-number">1.6.7.3.4.</span> <span class="toc-text">创建Canal容器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-instance-properties"><span class="toc-number">1.6.7.3.4.1.</span> <span class="toc-text">修改配置文件 instance.properties</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97"><span class="toc-number">1.6.7.3.5.</span> <span class="toc-text">重新启动并查看日志</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%ACCanal"><span class="toc-number">1.6.7.4.</span> <span class="toc-text">监听Canal</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Canal%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.6.7.4.1.</span> <span class="toc-text">Canal客户端</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99Canal%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.6.7.4.2.</span> <span class="toc-text">编写Canal客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.6.7.4.2.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.6.7.4.2.2.</span> <span class="toc-text">编写配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">1.6.7.4.2.3.</span> <span class="toc-text">编写监听器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-5"><span class="toc-number">1.6.7.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.</span> <span class="toc-text">Redis最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.7.1.</span> <span class="toc-text">Redis键值设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Key%E7%BB%93%E6%9E%84"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">Key结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%92%E7%BB%9DBigKey"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">拒绝BigKey</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E5%80%BC"><span class="toc-number">1.7.1.2.1.</span> <span class="toc-text">推荐值</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bigkey%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">Bigkey的危害</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0BigKey"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">发现BigKey</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#redis-cli-bigkeys"><span class="toc-number">1.7.1.4.1.</span> <span class="toc-text">redis-cli --bigkeys</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Scan-%E6%89%AB%E6%8F%8F"><span class="toc-number">1.7.1.4.2.</span> <span class="toc-text">Scan 扫描</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7"><span class="toc-number">1.7.1.4.3.</span> <span class="toc-text">第三方工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E7%9B%91%E6%8E%A7"><span class="toc-number">1.7.1.4.4.</span> <span class="toc-text">网络监控</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4BigKey"><span class="toc-number">1.7.1.5.</span> <span class="toc-text">删除BigKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%81%B0%E5%BD%93%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.7.1.6.</span> <span class="toc-text">恰当的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.7.1.6.1.</span> <span class="toc-text">对象</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#json%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%9A%E4%BC%98%E7%82%B9-%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%B2%97%E6%9A%B4-%E7%BC%BA%E7%82%B9-%E6%95%B0%E6%8D%AE%E8%80%A6%E5%90%88%E6%B2%A1%E6%9C%89%E7%81%B5%E6%B4%BB%E6%80%A7"><span class="toc-number">1.7.1.6.1.1.</span> <span class="toc-text">json字符串：优点-实现简单粗暴 缺点-数据耦合没有灵活性</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%88%86%E6%95%A3%EF%BC%9A%E7%81%B5%E6%B4%BB%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1%E4%BB%BB%E6%84%8F%E5%AD%97%E6%AE%B5-%E7%BC%BA%E7%82%B9-%E5%8D%A0%E7%94%A8%E7%A9%BA%E9%97%B4%E5%A4%A7%EF%BC%8C%E6%97%A0%E6%B3%95%E5%90%8C%E4%B8%80%E6%8E%A7%E5%88%B6"><span class="toc-number">1.7.1.6.1.2.</span> <span class="toc-text">字段分散：灵活访问对象任意字段 缺点-占用空间大，无法同一控制</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Hash%EF%BC%9A%E5%BA%95%E5%B1%82%E4%BD%BF%E7%94%A8ziplist%EF%BC%8C%E7%A9%BA%E9%97%B4%E5%8D%A0%E7%94%A8%E5%B0%8F%EF%BC%8C%E7%81%B5%E6%B4%BB%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%BB%BB%E6%84%8F%E5%AD%97%E6%AE%B5-%E7%BC%BA%E7%82%B9-%E4%BB%A3%E7%A0%81%E7%9B%B8%E5%AF%B9%E5%A4%8D%E6%9D%82"><span class="toc-number">1.7.1.6.1.3.</span> <span class="toc-text">Hash：底层使用ziplist，空间占用小，灵活访问对象的任意字段 缺点-代码相对复杂</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%A7%E9%94%AE%E5%80%BC%E5%AF%B9"><span class="toc-number">1.7.1.6.2.</span> <span class="toc-text">大键值对</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.1.6.2.1.</span> <span class="toc-text">存在问题</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%92%E5%88%86Hash"><span class="toc-number">1.7.1.6.2.2.</span> <span class="toc-text">划分Hash</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-6"><span class="toc-number">1.7.1.7.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Key"><span class="toc-number">1.7.1.7.1.</span> <span class="toc-text">Key</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Value"><span class="toc-number">1.7.1.7.2.</span> <span class="toc-text">Value</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%A4%84%E7%90%86%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.2.</span> <span class="toc-text">批处理优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">Pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E5%91%BD%E4%BB%A4%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.7.2.1.1.</span> <span class="toc-text">单个命令的执行流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#N%E4%B8%AA%E5%91%BD%E4%BB%A4%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.7.2.1.2.</span> <span class="toc-text">N个命令的执行流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#N%E4%B8%AA%E5%91%BD%E4%BB%A4%E6%89%B9%E9%87%8F%E6%89%A7%E8%A1%8C"><span class="toc-number">1.7.2.1.3.</span> <span class="toc-text">N个命令批量执行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MSET"><span class="toc-number">1.7.2.1.4.</span> <span class="toc-text">MSET</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline-1"><span class="toc-number">1.7.2.1.5.</span> <span class="toc-text">Pipeline</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-7"><span class="toc-number">1.7.2.1.6.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%B8%8B%E7%9A%84%E6%89%B9%E5%A4%84%E7%90%86"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">集群下的批处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.3.</span> <span class="toc-text">服务端优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.3.1.</span> <span class="toc-text">持久化配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.7.3.1.1.</span> <span class="toc-text">部署建议</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.3.2.</span> <span class="toc-text">慢查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%92%8C%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.3.3.</span> <span class="toc-text">命令和安全配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.3.4.</span> <span class="toc-text">内存配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Redis-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="toc-number">1.7.3.4.1.</span> <span class="toc-text">Redis 内存分配</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%91%BD%E4%BB%A4"><span class="toc-number">1.7.3.4.2.</span> <span class="toc-text">查看内存分配命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%BC%93%E5%86%B2%E5%8C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">1.7.3.4.3.</span> <span class="toc-text">内存缓冲区配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.7.4.</span> <span class="toc-text">集群最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%8C%E6%95%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">集群完整性问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%B8%A6%E5%AE%BD%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">集群带宽问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%80%94%E5%BE%84"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">解决途径</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/10/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Linux常用命令"><img src="/img/default-cover/26.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux常用命令"/></a><div class="content"><a class="title" href="/2023/06/10/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Linux常用命令">Linux常用命令</a><time datetime="2023-06-10T02:31:22.000Z" title="Created 2023-06-10 10:31:22">2023-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/24/Spring%E5%8E%9F%E7%90%86-AOP/" title="Spring 原理 - AOP"><img src="/img/default-cover/19.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring 原理 - AOP"/></a><div class="content"><a class="title" href="/2023/05/24/Spring%E5%8E%9F%E7%90%86-AOP/" title="Spring 原理 - AOP">Spring 原理 - AOP</a><time datetime="2023-05-24T12:35:22.000Z" title="Created 2023-05-24 20:35:22">2023-05-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/24/Spring%E5%8E%9F%E7%90%86-Bean%E5%92%8C%E5%AE%B9%E5%99%A8/" title="Spring 原理 - Bean和容器"><img src="/img/default-cover/50.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring 原理 - Bean和容器"/></a><div class="content"><a class="title" href="/2023/05/24/Spring%E5%8E%9F%E7%90%86-Bean%E5%92%8C%E5%AE%B9%E5%99%A8/" title="Spring 原理 - Bean和容器">Spring 原理 - Bean和容器</a><time datetime="2023-05-24T12:35:22.000Z" title="Created 2023-05-24 20:35:22">2023-05-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/10/%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81/" title="阅读源码-@Transaction"><img src="/img/default-cover/40.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="阅读源码-@Transaction"/></a><div class="content"><a class="title" href="/2023/05/10/%E9%98%85%E8%AF%BB%E6%BA%90%E7%A0%81/" title="阅读源码-@Transaction">阅读源码-@Transaction</a><time datetime="2023-05-10T09:30:00.000Z" title="Created 2023-05-10 17:30:00">2023-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/04/ELK/" title="ELK"><img src="/img/default-cover/30.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ELK"/></a><div class="content"><a class="title" href="/2023/05/04/ELK/" title="ELK">ELK</a><time datetime="2023-05-04T07:31:22.000Z" title="Created 2023-05-04 15:31:22">2023-05-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By YuanJW</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>