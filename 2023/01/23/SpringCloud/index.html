<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>SpringCloud | Hexo</title><meta name="keywords" content="SpringCloud"><meta name="author" content="YuanJW"><meta name="copyright" content="YuanJW"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringCloud   微服务服务架构演变单体架构 将业务的所有功能集中在一个项目中开发并打包部署   优点：架构简单、部署成本低 缺点：耦合度高   分布式架构 根据业务功能对系统进行拆分，每个业务模块作为一个独立项目开发   优点：降低服务耦合，利于服务升级拓展    问题   服务拆分的粒度 服务地址的维护 服务远程的调用 服务状态的感知    微服务 微服务是一种经过良好架构设计的分布">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="http://example.com/2023/01/23/SpringCloud/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="SpringCloud   微服务服务架构演变单体架构 将业务的所有功能集中在一个项目中开发并打包部署   优点：架构简单、部署成本低 缺点：耦合度高   分布式架构 根据业务功能对系统进行拆分，每个业务模块作为一个独立项目开发   优点：降低服务耦合，利于服务升级拓展    问题   服务拆分的粒度 服务地址的维护 服务远程的调用 服务状态的感知    微服务 微服务是一种经过良好架构设计的分布">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/default-cover/7.png">
<meta property="article:published_time" content="2023-01-23T02:31:22.000Z">
<meta property="article:modified_time" content="2023-02-23T10:44:09.929Z">
<meta property="article:author" content="YuanJW">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/default-cover/7.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/01/23/SpringCloud/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-23 18:44:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/default-cover/7.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-01-23T02:31:22.000Z" title="Created 2023-01-23 10:31:22">2023-01-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-02-23T10:44:09.929Z" title="Updated 2023-02-23 18:44:09">2023-02-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloud"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h1><p><img src="https://s2.loli.net/2023/02/10/KbCqjypxIeQ8W6P.png" alt="image-20230210111413170"></p>
<p><img src="https://s2.loli.net/2023/02/10/lSaqRn58HA6BYTp.png" alt="image-20230210111437287"></p>
<p><img src="https://s2.loli.net/2023/02/10/MsWpCvPV9N6tjn8.png" alt="image-20230210111840848"></p>
<h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><h3 id="服务架构演变"><a href="#服务架构演变" class="headerlink" title="服务架构演变"></a>服务架构演变</h3><h4 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h4><blockquote>
<p>将业务的所有功能集中在一个项目中开发并打包部署</p>
</blockquote>
<ul>
<li>优点：架构简单、部署成本低</li>
<li>缺点：耦合度高</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/10/PjWzDSX46LJM59V.png" alt="image-20230210112345474"></p>
<h4 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h4><blockquote>
<p>根据业务功能对系统进行拆分，每个业务模块作为一个独立项目开发</p>
</blockquote>
<ul>
<li>优点：降低服务耦合，利于服务升级拓展</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/10/CBD5Fz7QNutyelL.png" alt="image-20230210112702501"></p>
<ul>
<li><p>问题</p>
<p><img src="https://s2.loli.net/2023/02/10/QXM4ritw6DK2gSG.png" alt="image-20230210112951592"></p>
<ul>
<li>服务拆分的粒度</li>
<li>服务地址的维护</li>
<li>服务远程的调用</li>
<li>服务状态的感知</li>
</ul>
</li>
</ul>
<h4 id="微服务-1"><a href="#微服务-1" class="headerlink" title="微服务"></a>微服务</h4><blockquote>
<p><code>微服务</code>是一种经过良好架构设计的<code>分布式</code>架构设计方案。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/10/2xdC6XhEISfoYia.png" alt="image-20230210113807145"></p>
<p>微服务架构的特征：</p>
<ul>
<li>单一职责：微服务拆分粒度更小，每个服务都对应唯一的业务能力，做到单一职责，避免重复业务开发</li>
<li>面向服务：每个微服务对外暴露业务接口</li>
<li>独立自治：开发独立，技术独立，数据独立，部署独立</li>
<li>级联隔离：服务调用要做好隔离、容错、降级，避免出现级联问题</li>
</ul>
<p>微服务的优缺点：</p>
<ul>
<li>优点：拆分粒度更小，服务更加独立，耦合度更低</li>
<li>缺点：架构非常复杂，运维、监控、部署难度高</li>
</ul>
<p>微服务技术对比：</p>
<p><img src="https://s2.loli.net/2023/02/10/1uQSlvFI6q8mWUs.png" alt="image-20230210125543588"></p>
<h3 id="SpringCloud-1"><a href="#SpringCloud-1" class="headerlink" title="SpringCloud"></a>SpringCloud</h3><p><img src="https://s2.loli.net/2023/02/10/TtDJy2CdKEFVu9l.png" alt="image-20230210130124308"></p>
<p><img src="https://s2.loli.net/2023/02/10/SKRbUQLP9uaCfrt.png" alt="image-20230210130153060"></p>
<blockquote>
<p>SpringCloud集成了各种微服务组件，并基于SpringBoot实现组件的自动装配，从而提供开箱即用的体验</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/10/rkfSqhmcG3YKiQW.png" alt="image-20230210130814678"></p>
<h4 id="SpringCloud和SpringBoot版本对应关系"><a href="#SpringCloud和SpringBoot版本对应关系" class="headerlink" title="SpringCloud和SpringBoot版本对应关系"></a>SpringCloud和SpringBoot版本对应关系</h4><p><img src="https://s2.loli.net/2023/02/11/8U9VTFXuJfCn7Wb.png" alt="image-20230211180656324"></p>
<h3 id="服务拆分"><a href="#服务拆分" class="headerlink" title="服务拆分"></a>服务拆分</h3><ul>
<li>不同微服务单一职责，不会重复开发相同的业务</li>
<li>不同微服务数据独立，不会访问其他服务的数据库</li>
<li>微服务将业务暴露为接口，供其他微服务调用</li>
</ul>
<h3 id="远程调用"><a href="#远程调用" class="headerlink" title="远程调用"></a>远程调用</h3><h4 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h4><blockquote>
<p>基于RestTemplate发起的http请求实现的远程调用与语言就无关，只要请求的ip地址、端口、接口路径以及请求参数即可。</p>
</blockquote>
<h5 id="导入Ribbon依赖"><a href="#导入Ribbon依赖" class="headerlink" title="导入Ribbon依赖"></a>导入Ribbon依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="注册RestTemplate"><a href="#注册RestTemplate" class="headerlink" title="注册RestTemplate"></a>注册RestTemplate</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册RestTemplate对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="使用RestTemplate发送http请求"><a href="#使用RestTemplate发送http请求" class="headerlink" title="使用RestTemplate发送http请求"></a>使用RestTemplate发送http请求</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用RestTemplate发送http请求</span></span><br><span class="line"><span class="type">UmsMember</span> <span class="variable">umsMember</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8001/member/&quot;</span> + omsOrder.getMemberId(), UmsMember.class);</span><br></pre></td></tr></table></figure>

<h4 id="提供者与消费者"><a href="#提供者与消费者" class="headerlink" title="提供者与消费者"></a>提供者与消费者</h4><p><img src="https://s2.loli.net/2023/02/15/ZahAUtpTeELfFln.png" alt="image-20230215174602110"></p>
<ul>
<li>服务提供者：暴露接口给其他微服务调用</li>
<li>服务消费者：调用其他微服务提供的接口</li>
<li>提供者与消费者角色是相对的</li>
</ul>
<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><h3 id="RestTemplate调用出现的问题"><a href="#RestTemplate调用出现的问题" class="headerlink" title="RestTemplate调用出现的问题"></a>RestTemplate调用出现的问题</h3><ul>
<li>硬编码方式不易于修改请求地址</li>
<li>集群环境不能获取地址和负载均衡</li>
<li>不能监测服务提供者的健康状态</li>
</ul>
<h3 id="Eureka的作用"><a href="#Eureka的作用" class="headerlink" title="Eureka的作用"></a>Eureka的作用</h3><blockquote>
<p>Spring Cloud Eureka是Spring Cloud Netflix 子项目的核心组件之一，主要用于微服务架构中的服务治理。本文将对搭建Eureka注册中心，搭建Eureka客户端，搭建Eureka集群及给Eureka注册中心添加登录认证进行介绍。</p>
<p>在微服务架构中往往会有一个注册中心，每个微服务都会向注册中心去注册自己的地址及端口信息，注册中心维护着服务名称与服务实例的对应关系。每个微服务都会定时从注册中心获取服务列表，同时汇报自己的运行情况，这样当有的服务需要调用其他服务时，就可以从自己获取到的服务列表中获取实例地址进行调用，Eureka实现了这套服务注册与发现机制。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/15/87JUVjlEoKmeOTy.png" alt="image-20230215180145676"></p>
<p><img src="https://s2.loli.net/2023/02/15/Ynx9WDKX5Svp7J1.png" alt="image-20230215180245207"></p>
<p><img src="https://s2.loli.net/2023/02/15/JAIYLQZ4slRSahM.png" alt="image-20230215180306986"></p>
<h3 id="搭建Eureka服务端"><a href="#搭建Eureka服务端" class="headerlink" title="搭建Eureka服务端"></a>搭建Eureka服务端</h3><h4 id="父工程引入spring-cloud依赖"><a href="#父工程引入spring-cloud依赖" class="headerlink" title="父工程引入spring-cloud依赖"></a>父工程引入spring-cloud依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring Cloud 相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建子工程"><a href="#创建子工程" class="headerlink" title="创建子工程"></a>创建子工程</h4><p><img src="https://s2.loli.net/2023/02/16/qjMW3dRhFSK94oy.png" alt="img"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="启动类添加-EnableEurekaServer启用Eureka注册中心"><a href="#启动类添加-EnableEurekaServer启用Eureka注册中心" class="headerlink" title="启动类添加@EnableEurekaServer启用Eureka注册中心"></a>启动类添加@EnableEurekaServer启用Eureka注册中心</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置注册中心"><a href="#配置注册中心" class="headerlink" title="配置注册中心"></a>配置注册中心</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span> <span class="comment"># 指定运行端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span> <span class="comment"># 指定服务名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment"># 指定主机地址</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span> <span class="comment"># 指定是否要从注册中心获取服务（注册中心不需要开启）</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span> <span class="comment"># 指定是否要注册到注册中心（注册中心不需要开启）</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment"># 关闭保护模式</span></span><br></pre></td></tr></table></figure>

<h4 id="运行并访问http-localhost-7001"><a href="#运行并访问http-localhost-7001" class="headerlink" title="运行并访问http://localhost:7001/"></a>运行并访问<a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001/</a></h4><p><img src="https://s2.loli.net/2023/02/16/RVfMKgCQNZ5BDUH.png" alt="image-20230216110000487"></p>
<h3 id="搭建Eureka客户端"><a href="#搭建Eureka客户端" class="headerlink" title="搭建Eureka客户端"></a>搭建Eureka客户端</h3><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- eureka client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="启动类添加-EnableDiscoveryClient启用Eureka服务发现"><a href="#启动类添加-EnableDiscoveryClient启用Eureka服务发现" class="headerlink" title="启动类添加@EnableDiscoveryClient启用Eureka服务发现"></a>启动类添加@EnableDiscoveryClient启用Eureka服务发现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置编辑"><a href="#配置编辑" class="headerlink" title="配置编辑"></a>配置编辑</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eureka 服务注册与发现配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span> <span class="comment"># 注册到Eureka的注册中心</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span> <span class="comment"># 获取注册实例列表</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span> <span class="comment"># 配置注册中心地址</span></span><br></pre></td></tr></table></figure>

<h4 id="查看注册信息"><a href="#查看注册信息" class="headerlink" title="查看注册信息"></a>查看注册信息</h4><p><img src="https://s2.loli.net/2023/02/16/deObycaHXRw24tr.png" alt="image-20230216111133843"></p>
<h4 id="多实例部署"><a href="#多实例部署" class="headerlink" title="多实例部署"></a>多实例部署</h4><blockquote>
<p>多实例部署，修改端口设置，避免端口冲突</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dserver.port=8002</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/16/aBvgxYftEJp3jLX.png" alt="image-20230216144158442"></p>
<p><img src="https://s2.loli.net/2023/02/16/wlORaD8gNcYzTS3.png" alt="image-20230216145444136"></p>
<h4 id="拉取服务"><a href="#拉取服务" class="headerlink" title="拉取服务"></a>拉取服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用RestTemplate发送http请求</span></span><br><span class="line">           <span class="type">CommonResult</span> <span class="variable">commonResult</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://demo-user/member/&quot;</span> + omsOrder.getMemberId(), CommonResult.class);</span><br></pre></td></tr></table></figure>

<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Eureka集群搭建"><a href="#Eureka集群搭建" class="headerlink" title="Eureka集群搭建"></a>Eureka集群搭建</h3><blockquote>
<p>由于所有服务都会注册到注册中心去，服务之间的调用都是通过从注册中心获取的服务列表来调用，注册中心一旦宕机，所有服务调用都会出现问题。所以我们需要多个注册中心组成集群来提供服务，下面将搭建一个双节点的注册中心集群。</p>
<p>通过多个注册中心互相注册，搭建了注册中心的多节点集群。</p>
</blockquote>
<h4 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h4><ul>
<li>application.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span> <span class="comment">#指定运行端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span> <span class="comment">#指定服务名称</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#指定主机地址</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7002/eureka/,</span> <span class="string">http://localhost:7003/eureka/</span> <span class="comment">#注册到另一个Eureka注册中心</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span> <span class="comment">#指定是否要从注册中心获取服务</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span> <span class="comment">#指定是否要注册到注册中心</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application-replica1.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,</span> <span class="string">http://localhost:7003/eureka/</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application-replica2.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,</span> <span class="string">http://localhost:7002/eureka/</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="复制运行配置"><a href="#复制运行配置" class="headerlink" title="复制运行配置"></a>复制运行配置</h4><p><img src="https://s2.loli.net/2023/02/16/wHS8K3OjWYCz1m7.png" alt="image-20230216173000337"></p>
<h4 id="编辑配置文件-1"><a href="#编辑配置文件-1" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h4><p><img src="https://s2.loli.net/2023/02/16/T3yxBG9eEAw7vbq.png" alt="image-20230216172820478"></p>
<p><img src="https://s2.loli.net/2023/02/16/kVXUGZth9b3vPeA.png"></p>
<h3 id="Eureka添加认证"><a href="#Eureka添加认证" class="headerlink" title="Eureka添加认证"></a>Eureka添加认证</h3><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="配置WebSecurityConfig"><a href="#配置WebSecurityConfig" class="headerlink" title="配置WebSecurityConfig"></a>配置WebSecurityConfig</h4><blockquote>
<p>默认情况下添加SpringSecurity依赖的应用每个请求都需要添加CSRF token才能访问，Eureka客户端注册时并不会添加，所以需要配置/eureka/**路径不需要CSRF token。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@EnableWebSecurity</span><br><span class="line">public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span><br><span class="line">        http.csrf().ignoringAntMatchers(&quot;/eureka/**&quot;);</span><br><span class="line">        super.configure(http);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编辑配置文件-2"><a href="#编辑配置文件-2" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h4><blockquote>
<p>配置文件中需要修改注册中心地址格式</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://$&#123;username&#125;:$&#123;password&#125;@$&#123;hostname&#125;:$&#123;port&#125;/eureka/</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-server</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">serviceUrl:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://admin:123456@localhost:7001/eureka/,</span> <span class="string">http://admin:123456@localhost:7002/eureka/</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/16/qkMYtihmrVleN7p.png" alt="image-20230216174959224"></p>
<p><img src="https://s2.loli.net/2023/02/16/sSqdQbefr7ELXAW.png" alt="image-20230216175016142"></p>
<h3 id="Eureka常见配置"><a href="#Eureka常见配置" class="headerlink" title="Eureka常见配置"></a>Eureka常见配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#eureka客户端配置</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span> <span class="comment">#是否将自己注册到eureka服务端上去</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span> <span class="comment">#是否获取eureka服务端上注册的服务列表</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8001/eureka/</span> <span class="comment"># 指定注册中心地址</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 启用eureka客户端</span></span><br><span class="line">    <span class="attr">registry-fetch-interval-seconds:</span> <span class="number">30</span> <span class="comment">#定义去eureka服务端获取服务列表的时间间隔</span></span><br><span class="line">  <span class="attr">instance:</span> <span class="comment">#eureka客户端实例配置</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">30</span> <span class="comment">#定义服务多久去注册中心续约</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">90</span> <span class="comment">#定义服务多久不去续约认为服务失效</span></span><br><span class="line">    <span class="attr">metadata-map:</span></span><br><span class="line">      <span class="attr">zone:</span> <span class="string">jiangsu</span> <span class="comment">#所在区域</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#服务主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">false</span> <span class="comment">#是否优先使用ip来作为主机名</span></span><br><span class="line">  <span class="attr">server:</span> <span class="comment">#eureka服务端配置</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment">#关闭eureka服务端的保护机制</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="搭建Eureka服务端-1"><a href="#搭建Eureka服务端-1" class="headerlink" title="搭建Eureka服务端"></a>搭建Eureka服务端</h4><ul>
<li>引入eureka-server依赖</li>
<li>添加@EnableEurekaServer注解</li>
<li>在application.yml配置eureka地址</li>
</ul>
<h4 id="搭建Eureka服务端-2"><a href="#搭建Eureka服务端-2" class="headerlink" title="搭建Eureka服务端"></a>搭建Eureka服务端</h4><ul>
<li>引入eureka-client依赖</li>
<li>添加@EnableDiscoveryClient注解</li>
<li>在application.yml配置eureka地址</li>
</ul>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><ul>
<li>RestTemplate添加@LoadBalanced注解</li>
<li>用服务提供者的服务名称远程调用</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/16/srZ4Gmf2CTbpgdX.png" alt="image-20230216171238673"></p>
<h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><blockquote>
<p>Spring Cloud Ribbon 是Spring Cloud Netflix 子项目的核心组件之一，主要给服务间调用及API网关转发提供负载均衡的功能。</p>
<p>在微服务架构中，很多服务都会部署多个，其他服务去调用该服务的时候，如何保证负载均衡是个不得不去考虑的问题。负载均衡可以增加系统的可用性和扩展性，当我们使用RestTemplate来调用其他服务时，Ribbon可以很方便的实现负载均衡功能。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/16/Oix1LDRZes5w792.png" alt="image-20230216175448616"></p>
<p><img src="https://s2.loli.net/2023/02/17/O8bn6cCASMT1p35.png" alt="image-20230217102436638"></p>
<h3 id="负载均衡流程"><a href="#负载均衡流程" class="headerlink" title="负载均衡流程"></a>负载均衡流程</h3><p><img src="https://s2.loli.net/2023/02/17/Tg2KGeDWxaOip5h.png" alt="image-20230217104237779"></p>
<h3 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h3><p><img src="https://s2.loli.net/2023/02/17/1Czovl4iq9mDLxu.png" alt="image-20230217104059033"></p>
<blockquote>
<p>Ribbon的负载均衡规则由一个IRule的接口定义，每一个接口都是一种规则</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/17/oxiVTnMmIuapXkF.png" alt="image-20230217105006354"></p>
<p><img src="https://s2.loli.net/2023/02/17/zNAYcX63nQgBkuO.png" alt="image-20230217105159529"></p>
<blockquote>
<p>所谓的负载均衡策略，就是当A服务调用B服务时，此时B服务有多个实例，这时A服务以何种方式来选择调用的B实例，ribbon可以选择以下几种负载均衡策略。</p>
</blockquote>
<ul>
<li>com.netflix.loadbalancer.RandomRule：从提供服务的实例中以随机的方式；</li>
<li>com.netflix.loadbalancer.RoundRobinRule：以线性轮询的方式，就是维护一个计数器，从提供服务的实例中按顺序选取，第一次选第一个，第二次选第二个，以此类推，到最后一个以后再从头来过；</li>
<li>com.netflix.loadbalancer.RetryRule：在RoundRobinRule的基础上添加重试机制，即在指定的重试时间内，反复使用线性轮询策略来选择可用实例；</li>
<li>com.netflix.loadbalancer.WeightedResponseTimeRule：对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择；</li>
<li>com.netflix.loadbalancer.BestAvailableRule：选择并发较小的实例；</li>
<li>com.netflix.loadbalancer.AvailabilityFilteringRule：先过滤掉故障实例，再选择并发较小的实例；</li>
<li>com.netflix.loadbalancer.ZoneAwareLoadBalancer：采用双重过滤，同时过滤不是同一区域的实例和故障实例，选择并发较小的实例。</li>
</ul>
<h3 id="Ribbon常用配置"><a href="#Ribbon常用配置" class="headerlink" title="Ribbon常用配置"></a>Ribbon常用配置</h3><h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment">#服务请求连接超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">3000</span> <span class="comment">#服务请求处理超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对超时请求启用重试机制</span></span><br><span class="line">  <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换重试实例的最大个数</span></span><br><span class="line">  <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment"># 切换实例后重试最大次数</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<h4 id="指定服务配置"><a href="#指定服务配置" class="headerlink" title="指定服务配置"></a>指定服务配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user-service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment">#服务请求连接超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">3000</span> <span class="comment">#服务请求处理超时时间（毫秒）</span></span><br><span class="line">    <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">true</span> <span class="comment">#对超时请求启用重试机制</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">1</span> <span class="comment">#切换重试实例的最大个数</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">1</span> <span class="comment"># 切换实例后重试最大次数</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<h3 id="修改负载均衡算法"><a href="#修改负载均衡算法" class="headerlink" title="修改负载均衡算法"></a>修改负载均衡算法</h3><h4 id="定义新IRule并注入Bean"><a href="#定义新IRule并注入Bean" class="headerlink" title="定义新IRule并注入Bean"></a>定义新IRule并注入Bean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> IRule <span class="title function_">randomRule</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomRule</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment">#修改负载均衡算法</span></span><br></pre></td></tr></table></figure>

<h3 id="饥饿加载"><a href="#饥饿加载" class="headerlink" title="饥饿加载"></a>饥饿加载</h3><blockquote>
<p>Ribbon默认是采用懒加载，即第一次访问时才会创建LoadBalanceClient负载均衡客户端，请求时间会较长。</p>
<p>饥饿加载会在项目启动时创建，降低第一次访问的耗时。</p>
</blockquote>
<h4 id="开启饥饿加载"><a href="#开启饥饿加载" class="headerlink" title="开启饥饿加载"></a>开启饥饿加载</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">eager-load:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启饥饿加载</span></span><br><span class="line">    <span class="attr">clients:</span> <span class="string">userservice</span> <span class="comment"># 指定饥饿加载的服务</span></span><br></pre></td></tr></table></figure>

<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p><img src="https://s2.loli.net/2023/02/17/LOja9GlQinVNcfu.png" alt="image-20230217141915851"></p>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><h3 id="Nacos简介"><a href="#Nacos简介" class="headerlink" title="Nacos简介"></a>Nacos简介</h3><blockquote>
<p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案，Nacos 作为其核心组件之一，可以作为<code>注册中心</code>和<code>配置中心</code>使用，本文将对其用法进行详细介绍。</p>
</blockquote>
<p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。</p>
<p>Nacos 具有如下特性:</p>
<ul>
<li>服务发现和服务健康监测：支持基于<code>DNS</code>和基于<code>RPC</code>的服务发现，支持对服务的实时的健康检查，阻止向不健康的主机或服务实例发送请求；</li>
<li>动态配置服务：动态配置服务可以让您以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置；</li>
<li>动态 DNS 服务：动态 DNS 服务支持权重路由，让您更容易地实现中间层负载均衡、更灵活的路由策略、流量控制以及数据中心内网的简单DNS解析服务；</li>
<li>服务及其元数据管理：支持从微服务平台建设的视角管理数据中心的所有服务及元数据。</li>
</ul>
<h3 id="Nacos安装"><a href="#Nacos安装" class="headerlink" title="Nacos安装"></a>Nacos安装</h3><h4 id="拉取Nacos镜像"><a href="#拉取Nacos镜像" class="headerlink" title="拉取Nacos镜像"></a>拉取Nacos镜像</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nacos/nacos-server</span><br></pre></td></tr></table></figure>

<h4 id="运行Nacos容器"><a href="#运行Nacos容器" class="headerlink" title="运行Nacos容器"></a>运行Nacos容器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --env MODE=standalone --name nacos -d -p 8848:8848 nacos/nacos-server</span><br></pre></td></tr></table></figure>

<h4 id="访问地址"><a href="#访问地址" class="headerlink" title="访问地址"></a>访问地址</h4><blockquote>
<p><a target="_blank" rel="noopener" href="http://xx.xx.xx.xxx:8848/nacos/">http://xx.xx.xx.xxx:8848/nacos/</a></p>
<p>初始账号和密码：nacos/nacos</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/17/awotvjCDUHZI39J.png"></p>
<h3 id="应用注册"><a href="#应用注册" class="headerlink" title="应用注册"></a>应用注册</h3><h4 id="添加SpringCloudAlibaba依赖"><a href="#添加SpringCloudAlibaba依赖" class="headerlink" title="添加SpringCloudAlibaba依赖"></a>添加SpringCloudAlibaba依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring Cloud Alibaba 相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="添加Nacos服务发现依赖"><a href="#添加Nacos服务发现依赖" class="headerlink" title="添加Nacos服务发现依赖"></a>添加Nacos服务发现依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址</span></span><br></pre></td></tr></table></figure>

<h3 id="服务分级存储模型"><a href="#服务分级存储模型" class="headerlink" title="服务分级存储模型"></a>服务分级存储模型</h3><blockquote>
<p>服务调用尽量选择本地集群的服务，跨地域集群调用延迟较高。</p>
<p>使用服务分级存储模型，当本地集群不可访问时，再去访问其他集群。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/17/IQBnGyRtp2XYZod.png" alt="image-20230217173645935"></p>
<h4 id="修改配置文件-2"><a href="#修改配置文件-2" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><blockquote>
<p>添加spring.cloud.nacos.discovery.cluster-name属性</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">JIANGSU</span> <span class="comment"># 集群名称</span></span><br></pre></td></tr></table></figure>

<h4 id="复制运行配置-1"><a href="#复制运行配置-1" class="headerlink" title="复制运行配置"></a>复制运行配置</h4><p><img src="https://s2.loli.net/2023/02/17/7gQMo5Tx12WHXcl.png" alt="image-20230217175125981"></p>
<p><img src="https://s2.loli.net/2023/02/17/Ju2NIDPRKlaLtvz.png" alt="image-20230217174723828"></p>
<h3 id="集群负载均衡"><a href="#集群负载均衡" class="headerlink" title="集群负载均衡"></a>集群负载均衡</h3><h4 id="设置负载均衡IRule为NacosRule"><a href="#设置负载均衡IRule为NacosRule" class="headerlink" title="设置负载均衡IRule为NacosRule"></a>设置负载均衡IRule为NacosRule</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">userservice:</span></span><br><span class="line">	<span class="attr">ribbon:</span></span><br><span class="line">		<span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.alibaba.cloud.nacos.ribbon.NacosRule</span></span><br></pre></td></tr></table></figure>

<h4 id="NacosRule负载均衡策略"><a href="#NacosRule负载均衡策略" class="headerlink" title="NacosRule负载均衡策略"></a>NacosRule负载均衡策略</h4><ul>
<li>优先选择同集群服务实例列表</li>
<li>本地集群无法找到服务提供者，才去其他集群寻找并报告警告</li>
<li>确定可用实例列表，采用随机负载均衡策略挑选实例</li>
</ul>
<h3 id="权重负载均衡"><a href="#权重负载均衡" class="headerlink" title="权重负载均衡"></a>权重负载均衡</h3><p>由于服务器设备性能存在差异，部分实例所在机器性能较好，需要承担更多的用户请求。</p>
<p>Nacos提供了权重配置来控制访问频率，权重越大，访问频率越高。</p>
<p><img src="https://s2.loli.net/2023/02/20/Hc1UAd2hjTmgWvO.png" alt="image-20230220134417692"></p>
<h4 id="实例权重控制"><a href="#实例权重控制" class="headerlink" title="实例权重控制"></a>实例权重控制</h4><ul>
<li>Nacos控制台可以设置实例的权重值（0-1之间）</li>
<li>同集群内的多个实例，权重越高被访问的频率越高</li>
<li>权重设置为0，则完全不会被访问</li>
</ul>
<h3 id="环境隔离"><a href="#环境隔离" class="headerlink" title="环境隔离"></a>环境隔离</h3><p>Nacos中服务存储和数据存储的最外层是namespace，用来最外层隔离，隔离不同环境。</p>
<p><img src="https://s2.loli.net/2023/02/20/YEMlnS7ywCvtejx.png" alt="image-20230220134903522"></p>
<h4 id="创建命名空间"><a href="#创建命名空间" class="headerlink" title="创建命名空间"></a>创建命名空间</h4><p><img src="https://s2.loli.net/2023/02/20/dz9jGWXh5nkV3tT.png" alt="image-20230220135549579"></p>
<p><img src="https://s2.loli.net/2023/02/20/GK4bLCBFMNIxAya.png" alt="image-20230220135606369"></p>
<h4 id="修改配置文件-3"><a href="#修改配置文件-3" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">3c30a7da-2359-490d-90f3-c67f0f64d477</span> <span class="comment"># namespace 命名空间ID</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/20/prSX4TbhMZU35DN.png" alt="image-20230220140152505"></p>
<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p><img src="https://s2.loli.net/2023/02/20/tac1PzhXJnLIZFM.png" alt="image-20230220140325330"></p>
<h3 id="Nacos配置中心"><a href="#Nacos配置中心" class="headerlink" title="Nacos配置中心"></a>Nacos配置中心</h3><h3 id="Nacos和Eureka的区别"><a href="#Nacos和Eureka的区别" class="headerlink" title="Nacos和Eureka的区别"></a>Nacos和Eureka的区别</h3><p><img src="https://s2.loli.net/2023/02/20/ClPo6IyF5dzNDg7.png" alt="image-20230220141231444"></p>
<h4 id="临时实例和非临时实例"><a href="#临时实例和非临时实例" class="headerlink" title="临时实例和非临时实例"></a>临时实例和非临时实例</h4><h5 id="配置非临时实例"><a href="#配置非临时实例" class="headerlink" title="配置非临时实例"></a>配置非临时实例</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">ephemeral:</span> <span class="literal">false</span> <span class="comment"># 设置是否为临时实例</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>临时实例宕机时，从nacos的服务列表中剔除，而非实例则不会</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/20/Vxh8pJBLN93WAjz.png" alt="image-20230220155502822"></p>
<h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><p><img src="https://s2.loli.net/2023/02/20/xDFbShicjInzULN.png" alt="image-20230220142706896"></p>
<h5 id="Nacos与Eureka的共同点"><a href="#Nacos与Eureka的共同点" class="headerlink" title="Nacos与Eureka的共同点"></a>Nacos与Eureka的共同点</h5><ul>
<li>支持服务注册和服务拉取</li>
<li>支持服务提供者以心跳方式做健康检测</li>
</ul>
<h5 id="Nacos与Eureka的区别点"><a href="#Nacos与Eureka的区别点" class="headerlink" title="Nacos与Eureka的区别点"></a>Nacos与Eureka的区别点</h5><ul>
<li>Nacos支持服务端主动检测提供者状态：<code>临时实例</code>采用<code>心跳</code>模式，<code>非临时实例</code>采用<code>主动检测</code>模式</li>
<li>临时实例心跳不正常会被剔除，非临时实例不正常时不会被剔除</li>
<li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li>
<li>Nacos集群默认采用AP方式，当集群中存在非临时实例时，采用CP模式；Eureka采用AP方式</li>
</ul>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><h4 id="统一配置管理"><a href="#统一配置管理" class="headerlink" title="统一配置管理"></a>统一配置管理</h4><p><img src="https://s2.loli.net/2023/02/20/3WPvVk8dxKHrcmS.png" alt="image-20230220163338981"></p>
<h5 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h5><blockquote>
<p>Nacos的dataid的组成格式以及springboot配置文件中属性对应关系</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务名称-配置版本.文件格式</span></span><br><span class="line"><span class="variable">$&#123;spring.application.name&#125;</span>-<span class="variable">$&#123;spring.profiles.active&#125;</span>.<span class="variable">$&#123;spring.cloud.nacos.config.file-extension&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/21/QpcWTDwigRZBKAu.png"></p>
<p><img src="https://s2.loli.net/2023/02/20/PkN72jMyJrz1h9d.png" alt="image-20230220164853919"></p>
<h5 id="获取配置步骤"><a href="#获取配置步骤" class="headerlink" title="获取配置步骤"></a>获取配置步骤</h5><p><img src="https://s2.loli.net/2023/02/20/5tFs3jlNR7Cg8oa.png" alt="image-20230220170309580"></p>
<h6 id="引入Nacos配置管理客户端"><a href="#引入Nacos配置管理客户端" class="headerlink" title="引入Nacos配置管理客户端"></a>引入Nacos配置管理客户端</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Nacos Discovery --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Nacos Config --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Bootstrap --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="添加配置文件bootstrap-yml"><a href="#添加配置文件bootstrap-yml" class="headerlink" title="添加配置文件bootstrap.yml"></a>添加配置文件bootstrap.yml</h6><blockquote>
<p>bootstrap.yml文件是引导文件，优先级高于application.yml，主要对Nacos的作为配置中心的功能进行配置</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/20/dUuxwMkqXmZLo3D.png" alt="image-20230220171219558"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">demo-order</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment"># 开发环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8848</span> <span class="comment"># Nacos 地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8848</span> <span class="comment"># Nacos地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 获取的yaml格式的配置</span></span><br></pre></td></tr></table></figure>

<h6 id="创建ConfigClientController从Nacos配置中心获取配置信息"><a href="#创建ConfigClientController从Nacos配置中心获取配置信息" class="headerlink" title="创建ConfigClientController从Nacos配置中心获取配置信息"></a>创建ConfigClientController从Nacos配置中心获取配置信息</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/21/8w6TLmPn5xgZ7yK.png" alt="image-20230221135527778"></p>
<p><img src="https://s2.loli.net/2023/02/21/r8JeAbhCkXNUo6g.png" alt="image-20230221132156988"></p>
<h4 id="配置热更新"><a href="#配置热更新" class="headerlink" title="配置热更新"></a>配置热更新</h4><blockquote>
<p>Nacos中的配置文件变更后，微服务无需重启就可以感知</p>
</blockquote>
<ul>
<li>方式一：在<code>@Value</code>注入变量所在类上添加注解<code>@RefreshScope</code></li>
</ul>
<p><img src="https://s2.loli.net/2023/02/21/fSQVxLueBgalm8t.png"></p>
<p><img src="https://s2.loli.net/2023/02/21/1saMEFjSeQTxbCY.png" alt="image-20230221140434067"></p>
<ul>
<li>方式二：使用<code>@ConfigurationProperties</code>注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String info;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ConfigInfoProperties configInfoProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfoProperties.getInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/21/zptCNncbefXAuw3.png" alt="image-20230221141822603"></p>
<h4 id="多环境配置共享"><a href="#多环境配置共享" class="headerlink" title="多环境配置共享"></a>多环境配置共享</h4><blockquote>
<p>项目启动时会从Nacos读取多个配置文件，无论profile如何变化，[spring.application.name].[spring.cloud.nacos.config.file-extension]一定会被加载</p>
</blockquote>
<ul>
<li>```yml<br>${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  $&#123;spring.application.name&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://s2.loli.net/2023/02/21/Ph1wIfpRumavdjn.png" alt="image-20230221142231467"></p>
<p><img src="https://s2.loli.net/2023/02/21/M5UHgs8bvYf49ry.png" alt="image-20230221142933061"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigInfoProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">    <span class="keyword">private</span> String shared;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/shared&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">shared</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfoProperties.getShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/21/VEqmB4zNZrF9AUI.png" alt="image-20230221144050665"></p>
<p><img src="https://s2.loli.net/2023/02/21/pWBKm6hRC9Z1zY8.png" alt="image-20230221143743961"></p>
<h5 id="多种配置的优先级"><a href="#多种配置的优先级" class="headerlink" title="多种配置的优先级"></a>多种配置的优先级</h5><ul>
<li>服务名称-profile.yaml &gt; 服务名称.yaml &gt; 本地配置</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/21/SGeJTLmg7aQRydh.png" alt="image-20230221144537596"></p>
<p><img src="https://s2.loli.net/2023/02/21/AxvcLIFaNMSn7DX.png" alt="image-20230221145027139"></p>
<h4 id="Nacos集群搭建"><a href="#Nacos集群搭建" class="headerlink" title="Nacos集群搭建"></a>Nacos集群搭建</h4><p><img src="https://s2.loli.net/2023/02/21/2uhMaBKvOqH4x9P.webp" alt="img"></p>
<p><img src="https://s2.loli.net/2023/02/21/kKjWLzgR8rCPd9n.png" alt="image-20230221145236903"></p>
<h5 id="Nacos节点"><a href="#Nacos节点" class="headerlink" title="Nacos节点"></a>Nacos节点</h5><table>
<thead>
<tr>
<th>节点</th>
<th>ip地址</th>
<th>port</th>
</tr>
</thead>
<tbody><tr>
<td>nacos1</td>
<td>1.117.34.49</td>
<td>8845</td>
</tr>
<tr>
<td>nacos2</td>
<td>1.117.34.49</td>
<td>8846</td>
</tr>
<tr>
<td>nacos3</td>
<td>1.117.34.49</td>
<td>8847</td>
</tr>
</tbody></table>
<h5 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h5><ul>
<li>搭建数据库</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/21/vi6LNhrX2W3pfbA.png" alt="image-20230221151411726"></p>
<ul>
<li>容器启动Nacos集群</li>
</ul>
<blockquote>
<p>docker-compose.yml</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span> </span><br><span class="line"><span class="attr">services:</span>  </span><br><span class="line">  <span class="attr">docker-nacos-server-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos-server-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8845:8848&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9555:9555&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_PLATFORM:</span> <span class="string">mysql</span> </span><br><span class="line">      <span class="attr">NACOS_SERVERS:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8845</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8846</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8847</span></span><br><span class="line">      <span class="attr">NACOS_APPLICATION_PORT:</span> <span class="number">8845</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_HOST:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PORT:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_DB_NAME:</span> <span class="string">nacos_config</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">JVM_XMS:</span> <span class="string">256m</span></span><br><span class="line">      <span class="attr">JVM_XMX:</span> <span class="string">256m</span></span><br><span class="line">      <span class="attr">JVM_XMN:</span> <span class="string">256m</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/nacos-cluster/nacos1/logs:/home/nacos/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/nacos-cluster/nacos1/init.d/custom.properties:/home/nacos/init.d/custom.properties</span></span><br><span class="line">  <span class="attr">docker-nacos-server-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos-server-2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8846:8848&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_PLATFORM:</span> <span class="string">mysql</span> </span><br><span class="line">      <span class="attr">NACOS_SERVERS:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8845</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8846</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8847</span></span><br><span class="line">      <span class="attr">NACOS_APPLICATION_PORT:</span> <span class="number">8845</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_HOST:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PORT:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_DB_NAME:</span> <span class="string">nacos_config</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">JVM_XMS:</span> <span class="string">256m</span></span><br><span class="line">      <span class="attr">JVM_XMX:</span> <span class="string">256m</span></span><br><span class="line">      <span class="attr">JVM_XMN:</span> <span class="string">256m</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/nacos-cluster/nacos2/logs:/home/nacos/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/nacos-cluster/nacos2/init.d/custom.properties:/home/nacos/init.d/custom.properties</span></span><br><span class="line">  <span class="attr">docker-nacos-server-3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos-server-3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8847:8848&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">on-failure</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_PLATFORM:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">NACOS_SERVERS:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8845</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8846</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8847</span></span><br><span class="line">      <span class="attr">NACOS_APPLICATION_PORT:</span> <span class="number">8845</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_HOST:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PORT:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_DB_NAME:</span> <span class="string">nacos_config</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">JVM_XMS:</span> <span class="string">256m</span></span><br><span class="line">      <span class="attr">JVM_XMX:</span> <span class="string">256m</span></span><br><span class="line">      <span class="attr">JVM_XMN:</span> <span class="string">256m</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/nacos-cluster/nacos3/logs:/home/nacos/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mydata/nacos-cluster/nacos3/init.d/custom.properties:/home/nacos/init.d/custom.properties</span></span><br></pre></td></tr></table></figure>

<ul>
<li>nginx反向代理</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream nacos-cluster &#123;</span><br><span class="line">    server 1.117.34.49:8845;</span><br><span class="line">    server 1.117.34.49:8846;</span><br><span class="line">    server 1.117.34.49:8847;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    listen  [::]:80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    </span><br><span class="line">    location /nacos &#123;</span><br><span class="line">      proxy_pass http://nacos-cluster</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/21/GzSVUvZg6HqWLfi.png" alt="image-20230221161910758"></p>
<h2 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h2><h3 id="远程调用-1"><a href="#远程调用-1" class="headerlink" title="远程调用"></a>远程调用</h3><h4 id="RestTemplate调用存在的问题"><a href="#RestTemplate调用存在的问题" class="headerlink" title="RestTemplate调用存在的问题"></a>RestTemplate调用存在的问题</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CommonResult</span> <span class="variable">commonResult</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://demo-user/member/&quot;</span> + omsOrder.getMemberId(), CommonResult.class);</span><br><span class="line"><span class="type">UmsMember</span> <span class="variable">umsMember</span> <span class="operator">=</span> BeanUtil.toBean(commonResult.getData(), UmsMember.class);</span><br></pre></td></tr></table></figure>

<ul>
<li>代码可读性和编程体验性差</li>
<li>URL和参数难以维护</li>
</ul>
<h4 id="Fegin介绍"><a href="#Fegin介绍" class="headerlink" title="Fegin介绍"></a>Fegin介绍</h4><blockquote>
<p>Spring Cloud OpenFeign 是声明式的服务调用工具，它整合了Ribbon和Hystrix，拥有负载均衡和服务容错功能。</p>
<p>Feign是声明式的服务调用工具，我们只需创建一个接口并用注解的方式来配置它，就可以实现对某个服务接口的调用，简化了直接使用RestTemplate来调用服务接口的开发量。Feign具备可插拔的注解支持，同时支持Feign注解、JAX-RS注解及SpringMVC注解。当使用Feign时，Spring Cloud集成了Ribbon和Eureka以提供负载均衡的服务调用及基于Hystrix的服务容错保护功能。</p>
</blockquote>
<h5 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="启动类添加-EnableFeignClients来启动Feign客户端功能"><a href="#启动类添加-EnableFeignClients来启动Feign客户端功能" class="headerlink" title="启动类添加@EnableFeignClients来启动Feign客户端功能"></a>启动类添加@EnableFeignClients来启动Feign客户端功能</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="添加UserService接口完成服务接口绑定"><a href="#添加UserService接口完成服务接口绑定" class="headerlink" title="添加UserService接口完成服务接口绑定"></a>添加UserService接口完成服务接口绑定</h5><blockquote>
<p>我们通过@FeignClient注解实现了一个Feign客户端，其中的value为user-service表示这是对demo-user服务的接口调用客户端。我们可以回想下user-service中的UserController，只需将其改为接口，保留原来的SpringMvc注释即可。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;demo-user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/member/&#123;id&#125;&quot;)</span></span><br><span class="line">    CommonResult <span class="title function_">detail</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调用UserService实现服务调用"><a href="#调用UserService实现服务调用" class="headerlink" title="调用UserService实现服务调用"></a>调用UserService实现服务调用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CommonResult</span> <span class="variable">commonResult</span> <span class="operator">=</span> userService.detail(omsOrder.getMemberId());</span><br><span class="line"><span class="type">UmsMember</span> <span class="variable">umsMember</span> <span class="operator">=</span> BeanUtil.toBean(commonResult.getData(), UmsMember.class);</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/21/JS6rptiAMsmvnWX.png" alt="image-20230221174553914"></p>
<h3 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h3><blockquote>
<p>Feign自定义配置覆盖默认配置</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/21/GqdhyA4TX2gcZPC.png" alt="image-20230221203110311"></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>feign.Logger.Level</td>
<td>修改日志级别</td>
<td>四种不同的级别：NONE、BASIC、HEADERS、FULL</td>
</tr>
<tr>
<td>feign.codec.Decoder</td>
<td>响应结果的解析器</td>
<td>解析HTTP远程调用的返回结果</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>请求参数编码</td>
<td>编码HTTP远程调用的请求参数</td>
</tr>
<tr>
<td>feign.Contract</td>
<td>支持的注解格式</td>
<td>默认是SpringMVC注解</td>
</tr>
<tr>
<td>feign.Retryer</td>
<td>失败重试机制</td>
<td>请求失败的重试机制，默认没有，使用Ribbon的重试机制</td>
</tr>
</tbody></table>
<h4 id="Feign自定义配置"><a href="#Feign自定义配置" class="headerlink" title="Feign自定义配置"></a>Feign自定义配置</h4><h5 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h5><ul>
<li>全局配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">	client:</span><br><span class="line">		config:</span><br><span class="line">			default:	# 用default是全局配置，用服务名称是局部服务配置</span><br><span class="line">				loggerLevel: FULL # 日志级别</span><br></pre></td></tr></table></figure>

<ul>
<li>局部配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">	client:</span><br><span class="line">		config:</span><br><span class="line">			demo-user:	# 用default是全局配置，用服务名称是局部服务配置</span><br><span class="line">				loggerLevel: FULL # 日志级别</span><br></pre></td></tr></table></figure>

<h5 id="Bean方式"><a href="#Bean方式" class="headerlink" title="Bean方式"></a>Bean方式</h5><blockquote>
<p>配置类声明一个Bean</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignClientConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>全局配置，启动类@EnableFeignClient注解中</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(defaultConfiguration = FeignClientConfiguration.class)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>局部配置，绑定接口@FeignClient注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;demo-user&quot;, configuration = FeignClientConfiguration.class)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/22/PdqQRjZI6HcA1Yf.png" alt="image-20230222112112606"></p>
<p><img src="https://s2.loli.net/2023/02/22/qIc8lVYPDHfZXTw.png" alt="image-20230222113524115"></p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><h4 id="Feign底层客户端实现"><a href="#Feign底层客户端实现" class="headerlink" title="Feign底层客户端实现"></a>Feign底层客户端实现</h4><ul>
<li>URLConnection：默认实现，不支持连接池</li>
<li>Apache HttpClient：支持连接池</li>
<li>OKHttp：支持连接池</li>
</ul>
<p>优化Feign的性能主要包括</p>
<ul>
<li>使用<code>连接池</code>代替默认的URLConnection</li>
<li>日志级别，最好使用basic或none</li>
</ul>
<h4 id="添加HttpClient的支持"><a href="#添加HttpClient的支持" class="headerlink" title="添加HttpClient的支持"></a>添加HttpClient的支持</h4><h5 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HttpClient --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置连接池"><a href="#配置连接池" class="headerlink" title="配置连接池"></a>配置连接池</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启Feign对HttpClient的支持</span></span><br><span class="line">    <span class="attr">max-connections:</span>  <span class="comment"># 最大连接数</span></span><br><span class="line">    <span class="attr">max-connections-per-route:</span> <span class="number">50</span> <span class="comment"># 每个路径的最大连接数</span></span><br></pre></td></tr></table></figure>

<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ul>
<li>方式一-继承：给消费者的FeignClient和提供者的Controller定义统一的父接口作为标准</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/22/adLFU7yGViRo6uv.png" alt="image-20230222141439427"></p>
<ul>
<li>方式二-抽取：将FeignClient抽取为独立通用模块，默认的Feign都放到这个模块中提供给消费者使用</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/22/PvsKTfq24VgGx1d.png" alt="image-20230222141736918"></p>
<p><img src="https://s2.loli.net/2023/02/22/elXqt1Cud7RH452.png" alt="image-20230222142305225"></p>
<p><img src="https://s2.loli.net/2023/02/22/qzRisBby6jwVfYP.png" alt="image-20230222141906745"></p>
<blockquote>
<p>当定义的FeignClient不在SpringBootApplication的扫描包范围时，这些FeignClient无法使用</p>
</blockquote>
<ul>
<li>方法一：指定FeignClient所在包</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.example.demo.feign&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方法二：指定FeignClient字节码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(clients=&#123;UserService.class&#125;)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/22/IyKXMYvHZTamoWl.png" alt="image-20230222143607565"></p>
<h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><blockquote>
<p>Feign中的服务降级只需要Feign客户端定义的接口添加一个服务降级处理的实现类即可</p>
</blockquote>
<h4 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="添加服务降级实现类UserFallbackService"><a href="#添加服务降级实现类UserFallbackService" class="headerlink" title="添加服务降级实现类UserFallbackService"></a>添加服务降级实现类UserFallbackService</h4><blockquote>
<p>继承接口并对接口中的每个实现方法进行了服务降级逻辑的实现</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFallbackService</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">detail</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">UmsMember</span> <span class="variable">defaultMember</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UmsMember</span>();</span><br><span class="line">        <span class="keyword">return</span> CommonResult.success(defaultMember);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置服务降级处理类为UserFallbackService"><a href="#设置服务降级处理类为UserFallbackService" class="headerlink" title="设置服务降级处理类为UserFallbackService"></a>设置服务降级处理类为UserFallbackService</h4><blockquote>
<p>修改@FeignClient注解中的参数，设置fallback为UserFallbackService.class即可。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;demo-user&quot;, fallback = UserFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/member/&#123;id&#125;&quot;)</span></span><br><span class="line">    CommonResult <span class="title function_">detail</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改配置文件-4"><a href="#修改配置文件-4" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#在Feign中开启Hystrixs</span></span><br></pre></td></tr></table></figure>

<h2 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h2><blockquote>
<p>Spring Cloud Gateway 为 SpringBoot 应用提供了API网关支持，具有强大的智能路由与过滤器功能。</p>
</blockquote>
<h3 id="Gateway简介"><a href="#Gateway简介" class="headerlink" title="Gateway简介"></a>Gateway简介</h3><blockquote>
<p>Gateway是在Spring生态系统之上构建的API网关服务，基于Spring 5，Spring Boot 2和 Project Reactor等技术。Gateway旨在提供一种简单而有效的方式来对API进行路由，以及提供一些强大的过滤器功能， 例如：熔断、限流、重试等。</p>
</blockquote>
<h4 id="网关功能"><a href="#网关功能" class="headerlink" title="网关功能"></a>网关功能</h4><ul>
<li>身份认证和权限校验</li>
<li>服务路由和负载均衡</li>
<li>请求限流和服务熔断</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/22/cnSv739yWdBMhjZ.png" alt="image-20230222165747255"></p>
<p>Spring Cloud Gateway 具有如下特性：</p>
<ul>
<li>基于Spring Framework 5, Project Reactor 和 Spring Boot 2.0 进行构建；</li>
<li>动态路由：能够匹配任何请求属性；</li>
<li>可以对路由指定 Predicate（断言）和 Filter（过滤器）；</li>
<li>集成Hystrix的断路器功能；</li>
<li>集成 Spring Cloud 服务发现功能；</li>
<li>易于编写的 Predicate（断言）和 Filter（过滤器）；</li>
<li>请求限流功能；</li>
<li>支持路径重写。</li>
</ul>
<h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><ul>
<li>Route（路由）：路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由；</li>
<li>Predicate（断言）：指的是Java 8 的 Function Predicate。 输入类型是Spring框架中的ServerWebExchange。 这使开发人员可以匹配HTTP请求中的所有内容，例如请求头或请求参数。如果请求与断言相匹配，则进行路由；</li>
<li>Filter（过滤器）：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前后对请求进行修改。</li>
</ul>
<h3 id="搭建网关模块"><a href="#搭建网关模块" class="headerlink" title="搭建网关模块"></a>搭建网关模块</h3><h4 id="添加依赖-2"><a href="#添加依赖-2" class="headerlink" title="添加依赖"></a>添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Nacos Discovery --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Gateway --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Loadbalancer --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="添加路由配置"><a href="#添加路由配置" class="headerlink" title="添加路由配置"></a>添加路由配置</h4><blockquote>
<p>Gateway提供了两种不同的方式用于配置路由，一种是通过yml文件来配置，另一种通过Java Bean来配置。</p>
</blockquote>
<ul>
<li>使用配置文件</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span> <span class="comment"># 网关端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">1.117</span><span class="number">.34</span><span class="number">.49</span><span class="string">:8848</span> <span class="comment"># nacos地址</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">demo-user</span> <span class="comment"># 自定义路由id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://demo-user</span> <span class="comment"># 路由目标地址 lb是loadbalance的缩写 后面紧跟服务名称(lb需要引入loadbalance依赖)</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言：判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/member/**</span> <span class="comment"># 按照路径匹配</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用Java Bean配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">customizeRouteLocator</span><span class="params">(RouteLocatorBuilder routeLocatorBuilder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> routeLocatorBuilder.routes()</span><br><span class="line">                .route(<span class="string">&quot;demo-order&quot;</span>,</span><br><span class="line">                        r -&gt; r.path(<span class="string">&quot;/order/**&quot;</span>)</span><br><span class="line">                                .uri(<span class="string">&quot;lb://demo-order&quot;</span>)</span><br><span class="line">                ).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/23/JGPphIOc5vbF4SL.png" alt="image-20230223103617526"></p>
<p><img src="https://s2.loli.net/2023/02/23/kuM4KzOCF65eAJP.png" alt="image-20230223103659518"></p>
<h5 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h5><ul>
<li>路由id：路由唯一标识</li>
<li>uri：路由目的地，支持lb和http两种</li>
<li>predicates：路由断言，判断请求是否符合要求，符合则转发到路由目的地</li>
<li>filters：路由过滤器，处理请求或响应</li>
</ul>
<h3 id="路由断言工厂"><a href="#路由断言工厂" class="headerlink" title="路由断言工厂"></a>路由断言工厂</h3><p><img src="https://s2.loli.net/2023/02/23/oe2jTSkc3DJyYAN.png" alt="image-20230223122712339"></p>
<blockquote>
<p>配置文件的断言规则是字符串，这些字符串是被Predicate Factory读取并处理，转变为路由判断的条件。</p>
<p>Path按照路径匹配，这个规则是由<code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code>类来处理。</p>
<p><code>PredicateFacrtory</code>的作用是：读取用户定义的断言条件，对于请求做出判断。</p>
</blockquote>
<h4 id="Route-Predicate的使用"><a href="#Route-Predicate的使用" class="headerlink" title="Route Predicate的使用"></a>Route Predicate的使用</h4><blockquote>
<p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping基础架构的一部分。 Spring Cloud Gateway包括许多内置的Route Predicate工厂。 所有这些Predicate都与HTTP请求的不同属性匹配。 多个Route Predicate工厂可以进行组合，下面我们来介绍下一些常用的Route Predicate。    </p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/23/CrBKex9LJUaZy3Y.png" alt="image-20230223133936751"></p>
<h5 id="After-Route-Predicate"><a href="#After-Route-Predicate" class="headerlink" title="After Route Predicate"></a>After Route Predicate</h5><blockquote>
<p>在指定时间之后的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">After=2019-09-24T16:30:00+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>

<h5 id="Before-Route-Predicate"><a href="#Before-Route-Predicate" class="headerlink" title="Before Route Predicate"></a>Before Route Predicate</h5><blockquote>
<p>在指定时间之前的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">Before=2019-09-24T16:30:00+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>

<h5 id="Between-Route-Predicate"><a href="#Between-Route-Predicate" class="headerlink" title="Between Route Predicate"></a>Between Route Predicate</h5><blockquote>
<p>在指定时间区间内请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">Between=2019-09-24T16:30:00+08:00[Asia/Shanghai],</span> <span class="number">2019-09-25T16:30:00+08:00</span>[<span class="string">Asia/Shanghai</span>]</span><br></pre></td></tr></table></figure>

<h5 id="Cookie-Route-Predicate"><a href="#Cookie-Route-Predicate" class="headerlink" title="Cookie Route Predicate"></a>Cookie Route Predicate</h5><blockquote>
<p>带有指定Cookie的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Cookie=username,user</span> <span class="comment"># 使用curl工具发送带有cookie为username=user的请求可以匹配该路由</span></span><br></pre></td></tr></table></figure>

<h5 id="Header-Route-Predicate"><a href="#Header-Route-Predicate" class="headerlink" title="Header Route Predicate"></a>Header Route Predicate</h5><blockquote>
<p>带有指定请求头的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span> <span class="comment"># 使用curl工具发送带有请求头为X-Request-Id:123的请求可以匹配该路由</span></span><br></pre></td></tr></table></figure>

<h5 id="Host-Route-Predicate"><a href="#Host-Route-Predicate" class="headerlink" title="Host Route Predicate"></a>Host Route Predicate</h5><blockquote>
<p>带有指定Host的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Host=**.somehost.com</span> <span class="comment">#使用curl工具发送带有请求头为Host:www.macrozheng.com的请求可以匹配该路由</span></span><br></pre></td></tr></table></figure>

<h5 id="Method-Route-Predicate"><a href="#Method-Route-Predicate" class="headerlink" title="Method Route Predicate"></a>Method Route Predicate</h5><blockquote>
<p>发送指定方法的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Method=Get</span> <span class="comment"># 使用curl工具发送GET请求可以匹配该路由</span></span><br></pre></td></tr></table></figure>

<h5 id="Path-Route-Predicate"><a href="#Path-Route-Predicate" class="headerlink" title="Path Route Predicate"></a>Path Route Predicate</h5><blockquote>
<p>发送指定路径的请求会匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Path=/user/**</span> <span class="comment"># 使用curl工具发送/user/**路径请求可以匹配该路由</span></span><br></pre></td></tr></table></figure>

<h5 id="Query-Route-Predicate"><a href="#Query-Route-Predicate" class="headerlink" title="Query Route Predicate"></a>Query Route Predicate</h5><blockquote>
<p>带指定查询参数的请求可以匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">Query=username</span> <span class="comment"># 使用curl工具发送带username=?查询参数的请求可以匹配该路由</span></span><br></pre></td></tr></table></figure>

<h5 id="RemoteAddr-Route-Predicate"><a href="#RemoteAddr-Route-Predicate" class="headerlink" title="RemoteAddr Route Predicate"></a>RemoteAddr Route Predicate</h5><blockquote>
<p>从指定远程地址发起的请求可以匹配该路由</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure>

<h5 id="Weight-Route-Predicate"><a href="#Weight-Route-Predicate" class="headerlink" title="Weight Route Predicate"></a>Weight Route Predicate</h5><blockquote>
<p>使用权重来路由相应请求，以下表示有80%的请求会被路由到localhost:8201，20%会被路由到localhost:8202。</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">cloud:</span></span><br><span class="line">		<span class="attr">gateway:</span></span><br><span class="line">			<span class="attr">routes:</span></span><br><span class="line">				<span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_high</span></span><br><span class="line">				  <span class="attr">uri:</span> <span class="string">http://localhost:8201</span></span><br><span class="line">				  <span class="attr">predicates:</span></span><br><span class="line">				  <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">8</span></span><br><span class="line">			    <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_low</span></span><br><span class="line">				  <span class="attr">uri:</span> <span class="string">http://localhost:8202</span></span><br><span class="line">				  <span class="attr">predicates:</span></span><br><span class="line">				  <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="过滤器工厂"><a href="#过滤器工厂" class="headerlink" title="过滤器工厂"></a>过滤器工厂</h3><blockquote>
<p>GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理。</p>
<p>路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应，路由过滤器只能指定路由进行使用。Spring Cloud Gateway 内置了多种路由过滤器，他们都由GatewayFilter的工厂类来产生。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/23/Pb48FxHzZyoJltp.png" alt="image-20230223142303381"></p>
<p><img src="https://s2.loli.net/2023/02/23/doKPxCQm4JLgSUI.png" alt="image-20230223150554554"></p>
<h4 id="配置方式-1"><a href="#配置方式-1" class="headerlink" title="配置方式"></a>配置方式</h4><ul>
<li>局部配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">	 <span class="attr">gateway:</span></span><br><span class="line">        <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">demo-user</span> <span class="comment"># 自定义路由id</span></span><br><span class="line">         	<span class="attr">uri:</span> <span class="string">lb://demo-user</span> <span class="comment"># 路由目标地址 lb是loadbalance的缩写 后面紧跟服务名称</span></span><br><span class="line">          	<span class="attr">filters:</span> <span class="comment"># 过滤器配置</span></span><br><span class="line">            	<span class="bullet">-</span> <span class="string">AddRequestParameter=username,</span> <span class="string">user</span> <span class="comment"># 请求添加参数, &#x27;,&#x27;前面为key,后面为value</span></span><br></pre></td></tr></table></figure>

<ul>
<li>全局配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default-filters:</span> <span class="comment"># 全局配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">AddRequestParameter=username,</span> <span class="string">user</span> <span class="comment"># 请求添加参数, &#x27;,&#x27;前面为key,后面为value</span></span><br></pre></td></tr></table></figure>

<h4 id="AddRequestParameter-GatewayFilter"><a href="#AddRequestParameter-GatewayFilter" class="headerlink" title="AddRequestParameter GatewayFilter"></a>AddRequestParameter GatewayFilter</h4><blockquote>
<p>给请求添加参数的过滤器</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 网关路由配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">demo-user</span> <span class="comment"># 自定义路由id</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://demo-user</span> <span class="comment"># 路由目标地址 lb是loadbalance的缩写 后面紧跟服务名称</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment"># 过滤器配置</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestParameter=username,</span> <span class="string">user</span> <span class="comment"># 请求添加参数, &#x27;,&#x27;前面为key,后面为value</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言：判断请求是否符合路由规则的条件</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/member/**</span> <span class="comment"># 按照路径匹配</span></span><br></pre></td></tr></table></figure>

<h4 id="AddRequestHeader-GatewayFilter"><a href="#AddRequestHeader-GatewayFilter" class="headerlink" title="AddRequestHeader GatewayFilter"></a>AddRequestHeader GatewayFilter</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span> <span class="comment"># 过滤器配置</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">AddRequestParameter=username,</span> <span class="string">user</span> <span class="comment"># 请求添加参数, &#x27;,&#x27;前面为key,后面为value</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/23/IcMxYOdrKqTNn3G.png" alt="image-20230223150417933"></p>
<h4 id="StripPrefix-GatewayFilter"><a href="#StripPrefix-GatewayFilter" class="headerlink" title="StripPrefix GatewayFilter"></a>StripPrefix GatewayFilter</h4><blockquote>
<p>对指定数量的路径前缀进行去除的过滤器</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">StripPrefix=2</span> <span class="comment"># 将以/demo-user/开头的请求路径去除两位，即curl http://localhost:9201/demo-user/a/user/1相当于请求curl http://localhost:9201/user/1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/23/WuAjyOrqbPF4NSi.png" alt="image-20230223144515350"></p>
<h3 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h3><blockquote>
<p>全局过滤器的作用是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用。区别在于GatewayFilter通过配置定义，处理逻辑是固定的。定义方式是实现GlobalFilter接口。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/23/RrhyGW6xCXdPkOj.png" alt="image-20230223154041790"></p>
<h4 id="简单拦截认证"><a href="#简单拦截认证" class="headerlink" title="简单拦截认证"></a>简单拦截认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizeFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理当前请求，必要的话将GatewayFilterChain将请求交给下个过滤器处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 请求上下文，用于获取Request、Response等信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain 过滤器链，用于将请求委托给下一个过滤器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回标识当前过滤器业务结束</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取请求ServerHttpRequest对象</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 获取请求参数</span></span><br><span class="line">        MultiValueMap&lt;String, String&gt; queryParams = request.getQueryParams();</span><br><span class="line">        <span class="comment">// 获取请求参数中的 authorization 参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> queryParams.getFirst(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(authorization)) &#123;</span><br><span class="line">            <span class="comment">// 放行</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拦截</span></span><br><span class="line">        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);</span><br><span class="line">        <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/02/23/yXPQwjCaufYivI2.png" alt="image-20230223160704698"></p>
<h4 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h4><ul>
<li><p>全局过滤器的作用</p>
<blockquote>
<p>对所有路由生效的过滤器并可以自定义处理逻辑</p>
</blockquote>
</li>
<li><p>实现全局过滤器的步骤</p>
<ul>
<li>继承GlobalFilter接口并实现方法自定义处理逻辑</li>
<li>添加@Order注解或实现Ordered接口说明过滤链顺序</li>
</ul>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/23/LgGtPThVB9q7DuE.png" alt="image-20230223160948210"></p>
<h3 id="过滤器链"><a href="#过滤器链" class="headerlink" title="过滤器链"></a>过滤器链</h3><blockquote>
<p>请求进入网关会遇到三种类型的路由器：当前路由的过滤器、DefaultFilter以及GlobalFilter。</p>
<p>请求路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter合并到一个过滤器链（集合）中，排序后依次执行每个过滤器。</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/02/23/eM2kjxNB9pVlQoY.png" alt="image-20230223174035138"></p>
<h4 id="过滤器执行顺序"><a href="#过滤器执行顺序" class="headerlink" title="过滤器执行顺序"></a>过滤器执行顺序</h4><ul>
<li>每个过滤器必须指定一个int类型的order值，ordre值越小，优先级越高，执行顺序越靠前</li>
<li>GlobalFilter通过实现ordered接口或者添加@Order注解来指定order值</li>
<li>路由过滤器和defaultFilter的order由spring指定，默认是按照声明顺序从1递增</li>
<li>当过滤器的order值一样时，会按照defaultFilter &gt; 路由过滤器 &gt; GlobaFilter的顺序执行</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/23/GTLbgsZHfVjBvQ5.png" alt="image-20230223174222332"></p>
<h4 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h4><ul>
<li>order值越小，优先级越高</li>
<li>当order值一样时，顺序是defaultFilter最先，然后是局部路由过滤器，最后是全局过滤器</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/23/Qwrh5clUjXO7JiD.png" alt="image-20230223174238394"></p>
<h3 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h3><blockquote>
<p>跨域问题：协议、主机以及端口任一不同，浏览器禁止请求的发起者和服务端发生跨域请求。请求被浏览器拦截的问题。</p>
</blockquote>
<h4 id="跨越问题处理"><a href="#跨越问题处理" class="headerlink" title="跨越问题处理"></a>跨越问题处理</h4><p><img src="https://s2.loli.net/2023/02/23/YfyFOVi245GTdse.png" alt="image-20230223175700001"></p>
<blockquote>
<p>网关处理跨域同样采用CORS方案，只需简单的配置即可实现</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span> <span class="comment"># 全局跨域处理</span></span><br><span class="line">        <span class="attr">add-to-simple-url-handler-mapping:</span> <span class="literal">true</span> <span class="comment"># 解决options请求（浏览器询问服务端是否允许跨域的请求）被拦截问题</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="comment"># 允许哪些网站的跨域请求</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;http://1.117.34.49:9001&quot;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span> <span class="comment"># 允许的跨域ajax的请求方式</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;DELETE&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;PUT&quot;</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">&quot;OPTIONS&quot;</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&quot;*&quot;</span> <span class="comment"># 允许在请求中携带的头信息</span></span><br><span class="line">            <span class="attr">allowCredentials:</span> <span class="literal">true</span> <span class="comment"># 是否允许携带cookie</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">360000</span> <span class="comment"># 这次跨域检测的有效期</span></span><br></pre></td></tr></table></figure>

<h4 id="网关跨域配置核心参数"><a href="#网关跨域配置核心参数" class="headerlink" title="网关跨域配置核心参数"></a>网关跨域配置核心参数</h4><p><img src="https://s2.loli.net/2023/02/23/DIUpCibNgozQqrB.png" alt="image-20230223180424312"></p>
<ul>
<li>允许跨域的域名</li>
<li>允许跨域的请求头</li>
<li>允许跨域的请求方式</li>
<li>是否允许使用cookie</li>
<li>跨域的有效期</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">YuanJW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/01/23/SpringCloud/">http://example.com/2023/01/23/SpringCloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a></div><div class="post_share"><div class="social-share" data-image="/img/default-cover/7.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/01/12/MySQL%E8%BF%9B%E9%98%B6/"><img class="next-cover" src="/img/default-cover/12.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">MySQL进阶</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YuanJW</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/XiaoYuanJW" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/2754742370@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud"><span class="toc-number">1.</span> <span class="toc-text">SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98"><span class="toc-number">1.1.1.</span> <span class="toc-text">服务架构演变</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">单体架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">分布式架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1-1"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">微服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCloud-1"><span class="toc-number">1.1.2.</span> <span class="toc-text">SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringCloud%E5%92%8CSpringBoot%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">SpringCloud和SpringBoot版本对应关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">服务拆分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text">远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RestTemplate"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">RestTemplate</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5Ribbon%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.4.1.1.</span> <span class="toc-text">导入Ribbon依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%86%8CRestTemplate"><span class="toc-number">1.1.4.1.2.</span> <span class="toc-text">注册RestTemplate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RestTemplate%E5%8F%91%E9%80%81http%E8%AF%B7%E6%B1%82"><span class="toc-number">1.1.4.1.3.</span> <span class="toc-text">使用RestTemplate发送http请求</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85%E4%B8%8E%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">提供者与消费者</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka"><span class="toc-number">1.2.</span> <span class="toc-text">Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RestTemplate%E8%B0%83%E7%94%A8%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">RestTemplate调用出现的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">Eureka的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAEureka%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">搭建Eureka服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%88%B6%E5%B7%A5%E7%A8%8B%E5%BC%95%E5%85%A5spring-cloud%E4%BE%9D%E8%B5%96"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">父工程引入spring-cloud依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">创建子工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B7%BB%E5%8A%A0-EnableEurekaServer%E5%90%AF%E7%94%A8Eureka%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">启动类添加@EnableEurekaServer启用Eureka注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">配置注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%B9%B6%E8%AE%BF%E9%97%AEhttp-localhost-7001"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">运行并访问http:&#x2F;&#x2F;localhost:7001&#x2F;</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAEureka%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.2.4.</span> <span class="toc-text">搭建Eureka客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B7%BB%E5%8A%A0-EnableDiscoveryClient%E5%90%AF%E7%94%A8Eureka%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">启动类添加@EnableDiscoveryClient启用Eureka服务发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%96%E8%BE%91"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">配置编辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">查看注册信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">多实例部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">拉取服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.2.4.7.</span> <span class="toc-text">负载均衡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.5.</span> <span class="toc-text">Eureka集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">编辑配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%BF%90%E8%A1%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">复制运行配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">编辑配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E6%B7%BB%E5%8A%A0%E8%AE%A4%E8%AF%81"><span class="toc-number">1.2.6.</span> <span class="toc-text">Eureka添加认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEWebSecurityConfig"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">配置WebSecurityConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">编辑配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.7.</span> <span class="toc-text">Eureka常见配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.8.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAEureka%E6%9C%8D%E5%8A%A1%E7%AB%AF-1"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">搭建Eureka服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAEureka%E6%9C%8D%E5%8A%A1%E7%AB%AF-2"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">搭建Eureka服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.2.8.3.</span> <span class="toc-text">服务发现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon"><span class="toc-number">1.3.</span> <span class="toc-text">Ribbon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">负载均衡流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.2.</span> <span class="toc-text">负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbon%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">Ribbon常用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">全局配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">指定服务配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">1.3.4.</span> <span class="toc-text">修改负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%96%B0IRule%E5%B9%B6%E6%B3%A8%E5%85%A5Bean"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">定义新IRule并注入Bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">修改配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.3.5.</span> <span class="toc-text">饥饿加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E9%A5%A5%E9%A5%BF%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">开启饥饿加载</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">1.3.6.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos"><span class="toc-number">1.4.</span> <span class="toc-text">Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E7%AE%80%E4%BB%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">Nacos简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.2.</span> <span class="toc-text">Nacos安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96Nacos%E9%95%9C%E5%83%8F"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">拉取Nacos镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8CNacos%E5%AE%B9%E5%99%A8"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">运行Nacos容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">访问地址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%B3%A8%E5%86%8C"><span class="toc-number">1.4.3.</span> <span class="toc-text">应用注册</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0SpringCloudAlibaba%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">添加SpringCloudAlibaba依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0Nacos%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">添加Nacos服务发现依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">修改配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%88%86%E7%BA%A7%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.4.</span> <span class="toc-text">服务分级存储模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%BF%90%E8%A1%8C%E9%85%8D%E7%BD%AE-1"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">复制运行配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.5.</span> <span class="toc-text">集群负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1IRule%E4%B8%BANacosRule"><span class="toc-number">1.4.5.1.</span> <span class="toc-text">设置负载均衡IRule为NacosRule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NacosRule%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.5.2.</span> <span class="toc-text">NacosRule负载均衡策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%87%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.4.6.</span> <span class="toc-text">权重负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E6%9D%83%E9%87%8D%E6%8E%A7%E5%88%B6"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">实例权重控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB"><span class="toc-number">1.4.7.</span> <span class="toc-text">环境隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">1.4.7.1.</span> <span class="toc-text">创建命名空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-3"><span class="toc-number">1.4.7.2.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.7.3.</span> <span class="toc-text">启动服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">1.4.8.</span> <span class="toc-text">Nacos配置中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E5%92%8CEureka%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.4.9.</span> <span class="toc-text">Nacos和Eureka的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B%E5%92%8C%E9%9D%9E%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.4.9.1.</span> <span class="toc-text">临时实例和非临时实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%9D%9E%E4%B8%B4%E6%97%B6%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.4.9.1.1.</span> <span class="toc-text">配置非临时实例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">1.4.9.2.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Nacos%E4%B8%8EEureka%E7%9A%84%E5%85%B1%E5%90%8C%E7%82%B9"><span class="toc-number">1.4.9.2.1.</span> <span class="toc-text">Nacos与Eureka的共同点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nacos%E4%B8%8EEureka%E7%9A%84%E5%8C%BA%E5%88%AB%E7%82%B9"><span class="toc-number">1.4.9.2.2.</span> <span class="toc-text">Nacos与Eureka的区别点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.10.</span> <span class="toc-text">配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.10.1.</span> <span class="toc-text">统一配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.10.1.1.</span> <span class="toc-text">添加配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.4.10.1.2.</span> <span class="toc-text">获取配置步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%95%E5%85%A5Nacos%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.4.10.1.2.1.</span> <span class="toc-text">引入Nacos配置管理客户端</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6bootstrap-yml"><span class="toc-number">1.4.10.1.2.2.</span> <span class="toc-text">添加配置文件bootstrap.yml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAConfigClientController%E4%BB%8ENacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.10.1.2.3.</span> <span class="toc-text">创建ConfigClientController从Nacos配置中心获取配置信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-number">1.4.10.2.</span> <span class="toc-text">配置热更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB"><span class="toc-number">1.4.10.3.</span> <span class="toc-text">多环境配置共享</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E7%A7%8D%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.4.10.3.1.</span> <span class="toc-text">多种配置的优先级</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.4.10.4.</span> <span class="toc-text">Nacos集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Nacos%E8%8A%82%E7%82%B9"><span class="toc-number">1.4.10.4.1.</span> <span class="toc-text">Nacos节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.4.10.4.2.</span> <span class="toc-text">集群搭建</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign"><span class="toc-number">1.5.</span> <span class="toc-text">Feign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RestTemplate%E8%B0%83%E7%94%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">RestTemplate调用存在的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fegin%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">Fegin介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.5.1.2.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E6%B7%BB%E5%8A%A0-EnableFeignClients%E6%9D%A5%E5%90%AF%E5%8A%A8Feign%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.1.2.2.</span> <span class="toc-text">启动类添加@EnableFeignClients来启动Feign客户端功能</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0UserService%E6%8E%A5%E5%8F%A3%E5%AE%8C%E6%88%90%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E7%BB%91%E5%AE%9A"><span class="toc-number">1.5.1.2.3.</span> <span class="toc-text">添加UserService接口完成服务接口绑定</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8UserService%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">1.5.1.2.4.</span> <span class="toc-text">调用UserService实现服务调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text">自定义配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Feign%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">Feign自定义配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.2.1.1.</span> <span class="toc-text">配置方式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bean%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.2.1.2.</span> <span class="toc-text">Bean方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.3.</span> <span class="toc-text">性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Feign%E5%BA%95%E5%B1%82%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">Feign底层客户端实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0HttpClient%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">添加HttpClient的支持</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.5.3.2.1.</span> <span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">1.5.3.2.2.</span> <span class="toc-text">配置连接池</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.5.4.</span> <span class="toc-text">最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">1.5.5.</span> <span class="toc-text">服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E5%AE%9E%E7%8E%B0%E7%B1%BBUserFallbackService"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">添加服务降级实现类UserFallbackService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E5%A4%84%E7%90%86%E7%B1%BB%E4%B8%BAUserFallbackService"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">设置服务降级处理类为UserFallbackService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-4"><span class="toc-number">1.5.5.4.</span> <span class="toc-text">修改配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gateway"><span class="toc-number">1.6.</span> <span class="toc-text">Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gateway%E7%AE%80%E4%BB%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">Gateway简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E5%8A%9F%E8%83%BD"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">网关功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">相关概念</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%BD%91%E5%85%B3%E6%A8%A1%E5%9D%97"><span class="toc-number">1.6.2.</span> <span class="toc-text">搭建网关模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-2"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">添加路由配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.2.2.1.</span> <span class="toc-text">路由配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-number">1.6.3.</span> <span class="toc-text">路由断言工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Route-Predicate%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">Route Predicate的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#After-Route-Predicate"><span class="toc-number">1.6.3.1.1.</span> <span class="toc-text">After Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Before-Route-Predicate"><span class="toc-number">1.6.3.1.2.</span> <span class="toc-text">Before Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Between-Route-Predicate"><span class="toc-number">1.6.3.1.3.</span> <span class="toc-text">Between Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Cookie-Route-Predicate"><span class="toc-number">1.6.3.1.4.</span> <span class="toc-text">Cookie Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Header-Route-Predicate"><span class="toc-number">1.6.3.1.5.</span> <span class="toc-text">Header Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Host-Route-Predicate"><span class="toc-number">1.6.3.1.6.</span> <span class="toc-text">Host Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Method-Route-Predicate"><span class="toc-number">1.6.3.1.7.</span> <span class="toc-text">Method Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Path-Route-Predicate"><span class="toc-number">1.6.3.1.8.</span> <span class="toc-text">Path Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Query-Route-Predicate"><span class="toc-number">1.6.3.1.9.</span> <span class="toc-text">Query Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RemoteAddr-Route-Predicate"><span class="toc-number">1.6.3.1.10.</span> <span class="toc-text">RemoteAddr Route Predicate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Weight-Route-Predicate"><span class="toc-number">1.6.3.1.11.</span> <span class="toc-text">Weight Route Predicate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-number">1.6.4.</span> <span class="toc-text">过滤器工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F-1"><span class="toc-number">1.6.4.1.</span> <span class="toc-text">配置方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddRequestParameter-GatewayFilter"><span class="toc-number">1.6.4.2.</span> <span class="toc-text">AddRequestParameter GatewayFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddRequestHeader-GatewayFilter"><span class="toc-number">1.6.4.3.</span> <span class="toc-text">AddRequestHeader GatewayFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StripPrefix-GatewayFilter"><span class="toc-number">1.6.4.4.</span> <span class="toc-text">StripPrefix GatewayFilter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.5.</span> <span class="toc-text">全局过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8B%A6%E6%88%AA%E8%AE%A4%E8%AF%81"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">简单拦截认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE"><span class="toc-number">1.6.6.</span> <span class="toc-text">过滤器链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">过滤器执行顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.7.</span> <span class="toc-text">跨域问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%A8%E8%B6%8A%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86"><span class="toc-number">1.6.7.1.</span> <span class="toc-text">跨越问题处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0"><span class="toc-number">1.6.7.2.</span> <span class="toc-text">网关跨域配置核心参数</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/01/23/SpringCloud/" title="SpringCloud"><img src="/img/default-cover/7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud"/></a><div class="content"><a class="title" href="/2023/01/23/SpringCloud/" title="SpringCloud">SpringCloud</a><time datetime="2023-01-23T02:31:22.000Z" title="Created 2023-01-23 10:31:22">2023-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/12/MySQL%E8%BF%9B%E9%98%B6/" title="MySQL进阶"><img src="/img/default-cover/12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL进阶"/></a><div class="content"><a class="title" href="/2023/01/12/MySQL%E8%BF%9B%E9%98%B6/" title="MySQL进阶">MySQL进阶</a><time datetime="2023-01-12T02:31:22.000Z" title="Created 2023-01-12 10:31:22">2023-01-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/08/Docker%E5%B8%B8%E8%A7%81%E9%83%A8%E7%BD%B2%E6%80%BB%E7%BB%93/" title="Docker在Linux环境下常见部署"><img src="/img/default-cover/7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker在Linux环境下常见部署"/></a><div class="content"><a class="title" href="/2023/01/08/Docker%E5%B8%B8%E8%A7%81%E9%83%A8%E7%BD%B2%E6%80%BB%E7%BB%93/" title="Docker在Linux环境下常见部署">Docker在Linux环境下常见部署</a><time datetime="2023-01-08T02:30:55.000Z" title="Created 2023-01-08 10:30:55">2023-01-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/01/Redis%E5%AE%9E%E6%88%98/" title="Redis实战"><img src="/img/default-cover/17.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis实战"/></a><div class="content"><a class="title" href="/2022/12/01/Redis%E5%AE%9E%E6%88%98/" title="Redis实战">Redis实战</a><time datetime="2022-12-01T00:31:22.000Z" title="Created 2022-12-01 08:31:22">2022-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/06/ElasticSearch/" title="分布式搜索-ElasticSearch"><img src="/img/default-cover/2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式搜索-ElasticSearch"/></a><div class="content"><a class="title" href="/2022/11/06/ElasticSearch/" title="分布式搜索-ElasticSearch">分布式搜索-ElasticSearch</a><time datetime="2022-11-06T14:30:55.000Z" title="Created 2022-11-06 22:30:55">2022-11-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By YuanJW</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>